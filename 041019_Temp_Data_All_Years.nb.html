<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title>Temp_Data_All_Years</title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="1671.1">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; text-align: center; line-height: 18.0px; font: 12.0px 'Helvetica Neue'; color: #262626; -webkit-text-stroke: #262626; background-color: #ffffff}
    p.p3 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 20.0px; font: 14.0px 'Helvetica Neue'; color: #262626; -webkit-text-stroke: #262626; min-height: 16.0px}
    p.p4 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 18.0px; font: 13.0px Courier; color: #262626; -webkit-text-stroke: #262626; background-color: #f2f2f2}
    p.p5 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 18.0px; font: 13.0px Courier; color: #262626; -webkit-text-stroke: #262626; background-color: #ffffff}
    p.p6 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 18.0px; font: 13.0px Courier; color: #262626; -webkit-text-stroke: #262626; background-color: #ffffff; min-height: 13.0px}
    p.p7 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 18.0px; font: 13.0px Courier; color: #262626; -webkit-text-stroke: #262626; background-color: #f2f2f2; min-height: 13.0px}
    p.p8 {margin: 0.0px 0.0px 10.0px 0.0px; line-height: 18.0px; font: 13.0px Courier; color: #262626; -webkit-text-stroke: #262626; background-color: #f2f2f2}
    p.p12 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 18.0px; font: 12.6px Courier; color: #262626; -webkit-text-stroke: #262626; background-color: #000000; background-color: rgba(0, 0, 0, 0.039); min-height: 12.0px}
    li.li8 {margin: 0.0px 0.0px 10.0px 0.0px; line-height: 18.0px; font: 13.0px Courier; color: #262626; -webkit-text-stroke: #262626; background-color: #f2f2f2}
    li.li9 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 18.0px; font: 13.0px Courier; color: #262626; background-color: #f2f2f2}
    li.li10 {margin: 0.0px 0.0px 10.0px 0.0px; line-height: 18.0px; font: 13.0px Courier; color: #2965a8; -webkit-text-stroke: #2965a8}
    li.li11 {margin: 0.0px 0.0px 10.0px 0.0px; line-height: 18.0px; font: 13.0px Courier; color: #262626; -webkit-text-stroke: #262626}
    span.s1 {font-kerning: none}
    span.s2 {color: #262626; background-color: #f2f2f2; -webkit-text-stroke: 0px #000000}
    span.s3 {font-kerning: none; color: #262626; background-color: #f2f2f2; -webkit-text-stroke: 0px #262626}
    span.s4 {font-kerning: none; color: #2965a8; -webkit-text-stroke: 0px #2965a8}
    span.s5 {font-kerning: none; color: #262626; -webkit-text-stroke: 0px #262626}
    span.s6 {-webkit-text-stroke: 0px #000000}
    span.s7 {background-color: #f2f2f2; -webkit-text-stroke: 0px #000000}
    span.s8 {font-kerning: none; background-color: #f2f2f2}
    ol.ol1 {list-style-type: decimal}
  </style>
</head>
<body>
<p class="p1"><span class="s1">Code<span class="Apple-converted-space"> </span></span></p>
<h1 style="margin: 0.0px 0.0px 10.0px 0.0px; line-height: 41.0px; font: 38.0px 'Helvetica Neue'; color: #262626; -webkit-text-stroke: #262626"><span class="s1">Temp_Data_All_Years</span></h1>
<p class="p3"><span class="s1"></span><br></p>
<p class="p4"><span class="s1">library(dplyr)</span></p>
<p class="p5"><span class="s1">Attaching package: ‘dplyr’</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p5"><span class="s1">The following objects are masked from ‘package:stats’:</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>filter, lag</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p5"><span class="s1">The following objects are masked from ‘package:base’:</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>intersect, setdiff, setequal, union</span></p>
<p class="p4"><span class="s1">library(data.table)</span></p>
<p class="p5"><span class="s1">package ‘data.table’ was built under R version 3.5.2data.table 1.12.0<span class="Apple-converted-space">  </span>Latest news: r-datatable.com</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p5"><span class="s1">Attaching package: ‘data.table’</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p5"><span class="s1">The following objects are masked from ‘package:dplyr’:</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>between, first, last</span></p>
<p class="p4"><span class="s1">library(here)</span></p>
<p class="p5"><span class="s1">here() starts at /Users/zoekitchel/Documents/grad school/Rutgers/LabWork/Colonization_Extinction</span></p>
<p class="p4"><span class="s1">library(raster)</span></p>
<p class="p5"><span class="s1">package ‘raster’ was built under R version 3.5.2Loading required package: sp</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p5"><span class="s1">Attaching package: ‘raster’</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p5"><span class="s1">The following object is masked from ‘package:data.table’:</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>shift</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p5"><span class="s1">The following object is masked from ‘package:dplyr’:</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>select</span></p>
<p class="p4"><span class="s1">library(ncdf4)</span></p>
<p class="p5"><span class="s1">package ‘ncdf4’ was built under R version 3.5.2</span></p>
<p class="p4"><span class="s1">library(lubridate)</span></p>
<p class="p5"><span class="s1">Attaching package: ‘lubridate’</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p5"><span class="s1">The following object is masked from ‘package:here’:</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>here</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p5"><span class="s1">The following objects are masked from ‘package:data.table’:</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>hour, isoweek, mday, minute, month, quarter, second, wday, week, yday, year</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p5"><span class="s1">The following object is masked from ‘package:base’:</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>date</span></p>
<p class="p4"><span class="s1">library(maptools)</span></p>
<p class="p5"><span class="s1">package ‘maptools’ was built under R version 3.5.2Checking rgeos availability: TRUE</span></p>
<p class="p4"><span class="s1">library(rgdal)</span></p>
<p class="p5"><span class="s1">rgdal: version: 1.3-6, (SVN revision 773)</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space"> </span>Geospatial Data Abstraction Library extensions to R successfully loaded</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space"> </span>Loaded GDAL runtime: GDAL 2.1.3, released 2017/20/01</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space"> </span>Path to GDAL shared files: /Library/Frameworks/R.framework/Versions/3.5/Resources/library/rgdal/gdal</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space"> </span>GDAL binary built with GEOS: FALSE<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space"> </span>Loaded PROJ.4 runtime: Rel. 4.9.3, 15 August 2016, [PJ_VERSION: 493]</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space"> </span>Path to PROJ.4 shared files: /Library/Frameworks/R.framework/Versions/3.5/Resources/library/rgdal/proj</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space"> </span>Linking to sp version: 1.3-1<span class="Apple-converted-space"> </span></span></p>
<p class="p4"><span class="s1">library(tidyr)</span></p>
<p class="p5"><span class="s1">Attaching package: ‘tidyr’</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p5"><span class="s1">The following object is masked from ‘package:raster’:</span></p>
<p class="p6"><span class="s1"></span><br></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">    </span>extract</span></p>
<p class="p4"><span class="s1">library(ggplot2)</span></p>
<p class="p4"><span class="s1">library(dplyr)</span></p>
<p class="p4"><span class="s1">library(data.table)</span></p>
<p class="p4"><span class="s1">library(here)</span></p>
<p class="p4"><span class="s1">library(raster)</span></p>
<p class="p4"><span class="s1">library(ncdf4)</span></p>
<p class="p4"><span class="s1">library(lubridate)</span></p>
<p class="p4"><span class="s1">library(maptools)</span></p>
<p class="p4"><span class="s1">library(rgdal)</span></p>
<p class="p4"><span class="s1">library(tidyr)</span></p>
<p class="p4"><span class="s1">library(ggplot2)</span></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p4"><span class="s1">load("/Users/zoekitchel/Documents/grad school/Rutgers/Coursework/Fall 2018/SDM/hauls_catch_Dec2017 1.RData")</span></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p8"><span class="s1">First, I will make list of GPS points and days/year ranges for which I need temperatures</span></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p4"><span class="s1">latlongyear &lt;- hauls %&gt;%</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">  </span>dplyr::select(lat, lon, year, month)</span></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p8"><span class="s1">Okay, now getting SODA data Where I got the data to match soda in trawlData (following Ryan’s readme) Soda Data Files</span></p>
<ol class="ol1">
  <li class="li9"></li>
  <li class="li10"><span class="s2"></span><span class="s3">Go Here: <a href="http://iridl.ldeo.columbia.edu/SOURCES/.CARTON-GIESE/.SODA/.v2p1p6/.temp/time/%28Jan%202000%29%28Dec%202008%29RANGEEDGES/lat/%2810.25N%29%2884.75N%29RANGEEDGES/lon/%28179.75W%29%2820.25W%29RANGEEDGES/dataselection.html"><span class="s4">http://iridl.ldeo.columbia.edu/SOURCES/.CARTON-GIESE/.SODA/.v2p1p6/.temp/time/%28Jan%202000%29%28Dec%202008%29RANGEEDGES/lat/%2810.25N%29%2884.75N%29RANGEEDGES/lon/%28179.75W%29%2820.25W%29RANGEEDGES/dataselection.html</span></a></span><span class="s5"><br>
</span></li>
  <li class="li8"><span class="s6"></span><span class="s1">Restrict ranges as follows for SST to match SODA in trawlData</span></li>
  <li class="li8"><span class="s6"></span><span class="s1">-200E to 20E –&gt; 440 pts</span></li>
  <li class="li8"><span class="s6"></span><span class="s1">0N to 89.5N –&gt; 179 pts</span></li>
  <li class="li8"><span class="s6"></span><span class="s1">5.01 to 5.01</span></li>
  <li class="li11"><span class="s7"></span><span class="s8">Jan 1958 to Dec 2008 –&gt; 612 pts</span><span class="s1"><br>
</span></li>
  <li class="li11"><span class="s7"></span><span class="s8">Stop Selecting</span><span class="s1"><br>
</span></li>
  <li class="li11"><span class="s7"></span><span class="s8">Click Data Files</span><span class="s1"><br>
</span></li>
  <li class="li11"><span class="s7"></span><span class="s8">Download NetCDF Format</span><span class="s1"><br>
</span></li>
</ol>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p4"><span class="s1">cp &lt;- nc_open("/Users/zoekitchel/Documents/grad school/Rutgers/LabWork/Colonization_Extinction/CARTON-GIESE_SODA_v2p1p6_sstemp.nc")</span></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p5"><span class="s1">Error in R_nc4_open: No such file or directory</span></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p5"><span class="s1">Error in nc_open("/Users/zoekitchel/Documents/grad school/Rutgers/LabWork/Colonization_Extinction/CARTON-GIESE_SODA_v2p1p6_sstemp.nc") :<span class="Apple-converted-space"> </span></span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">  </span>Error in nc_open trying to open file /Users/zoekitchel/Documents/grad school/Rutgers/LabWork/Colonization_Extinction/CARTON-GIESE_SODA_v2p1p6_sstemp.nc</span></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p4"><span class="s1">cp &lt;- nc_open("/Users/zoekitchel/Documents/grad school/Rutgers/LabWork/Colonization_Extinction/CARTON-GIESE_SODA_v2p1p6_sstemp.nc")</span></p>
<p class="p4"><span class="s1">print(cp)</span></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p4"><span class="s1"># =========================================</span></p>
<p class="p4"><span class="s1"># = Function to Read in SODA, Grab Surface =</span></p>
<p class="p4"><span class="s1"># =========================================</span></p>
<p class="p4"><span class="s1">get.soda.sst &lt;- function(file){</span></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">    </span>soda.info &lt;- nc_open(file)</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">    </span>name.soda.sizes &lt;- sapply(soda.info$var$temp$dim, function(x)x$name)</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">    </span>soda.sizes &lt;- soda.info$var$temp$size</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">    </span>dim.units &lt;- sapply(soda.info$var$temp$dim, function(x)x$units)</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">    </span>print(dim.units)</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">    </span>stopifnot(grepl("months since ", dim.units[4])) # make sure time is in correct units and in right place</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">    </span>names(soda.sizes) &lt;- name.soda.sizes</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">    </span>ntime &lt;- soda.sizes["time"]</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">    </span>ndepth &lt;- soda.sizes["depth"]</span></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">    </span>soda.time0 &lt;- soda.info$var$temp$dim[[4]]$vals</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">    </span>ref.date &lt;- as.Date(gsub("months since ", "", dim.units[4]))</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">    </span>start.before.ref &lt;- grepl("-", soda.time0[1]) # is the first date before ref.date?</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">    </span>n.month.before &lt;- ceiling(abs(soda.time0[1])) + as.integer(start.before.ref)</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">    </span>start.increment &lt;- ifelse(start.before.ref, "-1 month", "1 month")</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">    </span>time.start &lt;- rev(seq.Date(ref.date, by=start.increment, length.out=n.month.before))[1]</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">    </span>soda.time &lt;- seq.Date(time.start, by="1 month", length.out=ntime)</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">    </span></span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">    </span>soda.sst &lt;- brick(file)</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">    </span>names(soda.sst) &lt;- soda.time</span></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">        </span></span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">    </span>return(soda.sst)</span></p>
<p class="p7"><span class="s1"><span class="Apple-converted-space">    </span></span></p>
<p class="p4"><span class="s1">}</span></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p4"><span class="s1">## Using Ryan's code</span></p>
<p class="p4"><span class="s1">soda_sst &lt;- get.soda.sst("/Users/zoekitchel/Documents/grad school/Rutgers/LabWork/Colonization_Extinction/CARTON-GIESE_SODA_v2p1p6_sstemp.nc")</span></p>
<p class="p4"><span class="s1">soda_sst</span></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p4"><span class="s1">plot(soda_sst[[9]])</span></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p4"><span class="s1">saveRDS(soda_sst, "SODA2.1.6_SST.rds")</span></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p8"><span class="s1">New column in latlongyear with “X1958.01.01” format, looks like I may not need to do this after all…</span></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p4"><span class="s1">latlongyear$month_digits &lt;- NA</span></p>
<p class="p4"><span class="s1">for (i in 1:nrow(latlongyear)) {</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">  </span>if (latlongyear$month[[i]] &lt; 10) {</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">    </span>latlongyear$month_digits[[i]] &lt;- paste0("0", month(latlongyear$month[[i]]))</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">  </span>} else {</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">    </span>latlongyear$month_digits[[i]] &lt;- paste0(month(latlongyear$month[[i]]))</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p4"><span class="s1">}</span></p>
<p class="p4"><span class="s1">latlongyear$day &lt;- paste0("0", c(1))</span></p>
<p class="p4"><span class="s1">latlongyear$year_digits &lt;- paste0("X", latlongyear$year)</span></p>
<p class="p4"><span class="s1">latlongyear$ID &lt;- paste(latlongyear$year_digits, latlongyear$month_digits, latlongyear$day, sep=".")</span></p>
<p class="p4"><span class="s1">latlongyearIDonly &lt;- latlongyear %&gt;%</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">  </span>dplyr::select(ID, lat, lon)</span></p>
<p class="p4"><span class="s1">justlatlong &lt;- latlongyear %&gt;%</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">  </span>dplyr::select(lat, lon)</span></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p8"><span class="s1">SET COORDINATE SYSTEM</span></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p4"><span class="s1">locations &lt;- SpatialPoints(cbind(latlongyear$lon, latlongyear$lat),<span class="Apple-converted-space"> </span></span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">                            </span>proj4string=CRS("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"))</span></p>
<p class="p4"><span class="s1">cord.UTM &lt;- spTransform(locations, crs(soda_sst))</span></p>
<p class="p4"><span class="s1">plot(cord.UTM)</span></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p8"><span class="s1">Now, let’s extract values</span></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p4"><span class="s1">temp_values &lt;- raster::extract(soda_sst, cord.UTM)</span></p>
<p class="p4"><span class="s1">df &lt;- cbind(justlatlong, temp_values)</span></p>
<p class="p4"><span class="s1">subset(df, is.na(df[,4])) #looking for NA's</span></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p8"><span class="s1">Let’s look at the problem rows, GOOD NEWS, the problem is that we have a few GPS locations of trawls lacking datapoints, luckily, we can just get rid of these points when averaging!!</span></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p4"><span class="s1">#now, to make my life easier, I'm just gonna remove NA's here</span></p>
<p class="p4"><span class="s1">df_na_rm &lt;- df[complete.cases(df[,4]), ]</span></p>
<p class="p4"><span class="s1">head(df_na_rm, rows=10, cols=10)</span></p>
<p class="p4"><span class="s1">df_long &lt;- gather(df_na_rm, key = "ID", value = "temp", 3:614 )</span></p>
<p class="p4"><span class="s1">head(df_long)</span></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p8"><span class="s1">We now have to split the date back up unfortunately, and get rid of X</span></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p4"><span class="s1">rm(df, soda_sst, cord.UTM, df_na_rm, locations, temp_values)#open memory</span></p>
<p class="p4"><span class="s1">df_long2 &lt;- df_long %&gt;%</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">  </span>separate(col = ID, into = c("year", "month", "day"))</span></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p4"><span class="s1">df_long2$year &lt;- substr(as.character(df_long2$year), 2, 5)</span></p>
<p class="p4"><span class="s1">head(df_long2, 30)</span></p>
<p class="p4"><span class="s1">save(df_long2, file = "SODA_monthly_data.R")</span></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p8"><span class="s1">I currently have mean monthly values for a ton of GPS points within a region. For temperature values, I will first take a mean for each month over the whole region, so then I have a mean month/year value. region_<i>month</i>_mean_sst Then, I will take mean of mean month/year of year of trawl to get a YEARLY mean to represent the whole region. region_year_mean_sst For maximum temperature experienced in a year, I will take maximum of mean month/year and for minimum I will take minimum of mean month/year. region_year_max_sst, region_year_min_sst I intend to look at 10 years of possible lags.</span></p>
<p class="p8"><span class="s1">Therefore, the next step is to merge these data with which regions link to which GPS points using hauls$region</span></p>
<p class="p8"><span class="s1">First, I will make a lat lon region key</span></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p4"><span class="s1">latlongreg &lt;- hauls %&gt;%</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">  </span>dplyr::select(lat, lon, region)</span></p>
<p class="p4"><span class="s1">head(latlongreg)</span></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p8"><span class="s1">Then I will link data table with GPS and date and temp with regions using above key, and then take appropriate averages</span></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p4"><span class="s1">date_temp_reg &lt;- left_join(df_long2, latlongreg, by = c("lat", "lon"))</span></p>
<p class="p4"><span class="s1">head(df_long2)</span></p>
<p class="p4"><span class="s1">date_temp_reg_month_avg &lt;- date_temp_reg %&gt;%</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">  </span>group_by(region, year, month) %&gt;%</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">  </span>summarize(region_month_mean_sst = mean(temp))</span></p>
<p class="p4"><span class="s1">head(date_temp_reg_month_avg)</span></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p4"><span class="s1">date_temp_reg_avg &lt;- date_temp_reg_month_avg %&gt;%</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">  </span>group_by(region, year) %&gt;%</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">  </span>summarize(region_year_mean_sst = mean(region_month_mean_sst), region_year_max_sst = max(region_month_mean_sst), region_year_min_sst = min(region_month_mean_sst)) %&gt;%</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">  </span>mutate(region_year_seas_sst = region_year_max_sst - region_year_min_sst)</span></p>
<p class="p4"><span class="s1">head(date_temp_reg_avg)</span></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p4"><span class="s1">ggplot(data=date_temp_reg_avg, aes(x=year, y=region_year_mean_sst)) +</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">  </span>geom_point() +</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">  </span>facet_wrap(~region)</span></p>
<p class="p4"><span class="s1">base::nrow(date_temp_reg_avg)</span></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p8"><span class="s1">I now have the predictor values I need, yearly min and max for entire region per year</span></p>
<p class="p8"><span class="s1">Next, I need to link to regional yearly species data</span></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p4"><span class="s1">load.csv("/Users/zoekitchel/Documents/zjk desktop/grad school/Rutgers/LabWork/Col-Ext/R/col_ext_organized/rawdata/spp_master.RData")</span></p>
<p class="p4"><span class="s1">#compare temps I calculated to temperatures already there</span></p>
<p class="p4"><span class="s1">spp_master_ztemp &lt;- left_join(spp_master, date_temp_reg_avg, by = c("region", "year"))</span></p>
<p class="p4"><span class="s1">spp_master$temp_dif &lt;- spp_master_ztemp$temp-spp_master_ztemp$ztemps</span></p>
<p class="p4"><span class="s1">#hopefully they match up!</span></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p8"><span class="s1">Next step is to calculate change in temp from previous year to now, luckily I can farm this code from 27_acf_timeseries_analysis_covariates.R</span></p>
<p class="p8"><span class="s1">I think I should calculate both change in temperature and lags from date_temp_reg_avg in order to keep years not actually surveyed (i.e. triennial west coast survey)</span></p>
<p class="p8"><span class="s1">Here I am first adding lags</span></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p4"><span class="s1">#adding lag values (1, 2, 3, 4, 5) for seasonality and change in temperature</span></p>
<p class="p4"><span class="s1">nm1 &lt;- grep("*sst*", colnames(date_temp_reg_avg), value=TRUE)</span></p>
<p class="p4"><span class="s1">nm2 &lt;- paste("lag1", nm1, sep=".")</span></p>
<p class="p4"><span class="s1">nm3 &lt;- paste("lag2", nm1, sep=".")</span></p>
<p class="p4"><span class="s1">nm4 &lt;- paste("lag3", nm1, sep=".")</span></p>
<p class="p4"><span class="s1">nm5 &lt;- paste("lag4", nm1, sep=".")</span></p>
<p class="p4"><span class="s1">nm6 &lt;- paste("lag5", nm1, sep=".")</span></p>
<p class="p4"><span class="s1">nm7 &lt;- paste("lag6", nm1, sep=".")</span></p>
<p class="p4"><span class="s1">nm8 &lt;- paste("lag7", nm1, sep=".")</span></p>
<p class="p4"><span class="s1">nm9 &lt;- paste("lag8", nm1, sep=".")</span></p>
<p class="p4"><span class="s1">nm10 &lt;- paste("lag9", nm1, sep=".")</span></p>
<p class="p4"><span class="s1">nm11 &lt;- paste("lag10", nm1, sep=".")</span></p>
<p class="p4"><span class="s1">date_temp_reg_avg_withlags &lt;- data.table(date_temp_reg_avg)</span></p>
<p class="p4"><span class="s1">date_temp_reg_avg_withlags[, (nm2) :=<span class="Apple-converted-space">  </span>shift(.SD, n=1, type = "lag"), by=region, .SDcols=nm1]</span></p>
<p class="p4"><span class="s1">date_temp_reg_avg_withlags[, (nm3) :=<span class="Apple-converted-space">  </span>shift(.SD, n=2, type = "lag"), by=region, .SDcols=nm1]</span></p>
<p class="p4"><span class="s1">date_temp_reg_avg_withlags[, (nm4) :=<span class="Apple-converted-space">  </span>shift(.SD, n=3, type = "lag"), by=region, .SDcols=nm1]</span></p>
<p class="p4"><span class="s1">date_temp_reg_avg_withlags[, (nm5) :=<span class="Apple-converted-space">  </span>shift(.SD, n=4, type = "lag"), by=region, .SDcols=nm1]</span></p>
<p class="p4"><span class="s1">date_temp_reg_avg_withlags[, (nm6) :=<span class="Apple-converted-space">  </span>shift(.SD, n=5, type = "lag"), by=region, .SDcols=nm1]</span></p>
<p class="p4"><span class="s1">date_temp_reg_avg_withlags[, (nm7) :=<span class="Apple-converted-space">  </span>shift(.SD, n=6, type = "lag"), by=region, .SDcols=nm1]</span></p>
<p class="p4"><span class="s1">date_temp_reg_avg_withlags[, (nm8) :=<span class="Apple-converted-space">  </span>shift(.SD, n=7, type = "lag"), by=region, .SDcols=nm1]</span></p>
<p class="p4"><span class="s1">date_temp_reg_avg_withlags[, (nm9) :=<span class="Apple-converted-space">  </span>shift(.SD, n=8, type = "lag"), by=region, .SDcols=nm1]</span></p>
<p class="p4"><span class="s1">date_temp_reg_avg_withlags[, (nm10) :=<span class="Apple-converted-space">  </span>shift(.SD, n=9, type = "lag"), by=region, .SDcols=nm1]</span></p>
<p class="p4"><span class="s1">date_temp_reg_avg_withlags[, (nm11) :=<span class="Apple-converted-space">  </span>shift(.SD, n=10, type = "lag"), by=region, .SDcols=nm1]</span></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p8"><span class="s1">Now, I’m adding change since last year</span></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p4"><span class="s1">date_temp_reg_avg_withlags[,c("sst_mean_change") := (region_year_mean_sst - lag1.region_year_mean_sst)]</span></p>
<p class="p4"><span class="s1">date_temp_reg_avg_withlags[,c("sst_max_change") := (region_year_max_sst - lag1.region_year_max_sst)]</span></p>
<p class="p4"><span class="s1">date_temp_reg_avg_withlags[,c("sst_min_change") := (region_year_min_sst - lag1.region_year_min_sst)]</span></p>
<p class="p4"><span class="s1">date_temp_reg_avg_withlags[,c("sst_seas_change") := (region_year_seas_sst - lag1.region_year_seas_sst)]</span></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p8"><span class="s1">Another way to look at lags</span></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p4"><span class="s1">ccf()</span></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p7"><span class="s1"></span><br></p>
<p class="p12"><span class="s1"></span><br></p>
<p class="p12"><span class="s1"></span><br></p>
<p class="p12"><span class="s1"></span><br></p>
<p class="p12"><span class="s1"></span><br></p>
<p class="p12"><span class="s1"></span><br></p>
<p class="p12"><span class="s1"></span><br></p>
<p class="p12"><span class="s1"></span><br></p>
<p class="p12"><span class="s1"></span><br></p>
<p class="p12"><span class="s1"></span><br></p>
</body>
</html>
