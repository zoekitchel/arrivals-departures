---
title: "Modeling individual instances of colonizations and extinctions usings traits"
output: html_notebook
---
Question: do species traits intereact with changes in temperature (current or past) to determine whether or not a given species colonizes a new region in a given year?

binomial regressions:

colonization in a given year? (yes/no) ~ mean temp of year of trawl x traits + max temp of year of trawl x traits + min temp of year of trawl x traits + change in mean temp from last year x traits + lags + traits

extinction in a given year? (yes/no) ~ mean temp of year of trawl x traits + max temp of year of trawl x traits + min temp of year of trawl x traits + change in mean temp from last year x traits + lags + traits

Traits to use?
  Ideal:
  generalism
  dispersal syndrome
  longevity
  body size
  generation time
  trophic level
  current range size
  mobility (fish, yes/no)

What we actually have from Tim: (** = ideal)
  trophic level:
    feeding.mode (generalism?)**
    tl (trophic level)**
  Reproduction: (probably whichever we have more data for)
    spawning.type (open_water/substratum, etc. )**
    egg.size**
  Growth:
    Linf (body size)
    Lmax (body size)*
    K (growth rate, 1/y)
    Lm (length at maturity)**
    Tmax (maximum age)
    tm (age maturity)**

*NB: I'm noticing that some species have multiple records in Tim's database, and that some stats are not quite matching up with what I find on fishbase.org (ie BSB max size and such)*

```{r setup}
library(MuMIn)
library(lme4)
library(dplyr)
library(tidyr)
read.csv("traits_formanip.csv")
load("date_ssttemp_avg_SODA_withlags.Rdata")
load("spp_master.RData")

```
Let's link species data from spp_master to temp data with lags and changes
```{r}
#compare temps I calculated to temperatures already there
#match region names between two data tables
date_temp_reg_avg_withlags$region <- as.factor(date_temp_reg_avg_withlags$region)
levels(date_temp_reg_avg_withlags$region)[levels(date_temp_reg_avg_withlags$region)=="AFSC_Aleutians"] <- "ai"
levels(date_temp_reg_avg_withlags$region)[levels(date_temp_reg_avg_withlags$region)=="AFSC_EBS"] <- "ebs"
levels(date_temp_reg_avg_withlags$region)[levels(date_temp_reg_avg_withlags$region)=="AFSC_GOA"] <- "goa"
levels(date_temp_reg_avg_withlags$region)[levels(date_temp_reg_avg_withlags$region)=="AFSC_WCTri"] <- "wctri"
levels(date_temp_reg_avg_withlags$region)[levels(date_temp_reg_avg_withlags$region)=="DFO_Newfoundland"] <- "newf"
levels(date_temp_reg_avg_withlags$region)[levels(date_temp_reg_avg_withlags$region)=="DFO_ScotianShelf"] <- "shelf"
levels(date_temp_reg_avg_withlags$region)[levels(date_temp_reg_avg_withlags$region)=="NEFSC_NEUS"] <- "neus"
levels(date_temp_reg_avg_withlags$region)[levels(date_temp_reg_avg_withlags$region)=="SCDNR_SEUS"] <- "se"
levels(date_temp_reg_avg_withlags$region)[levels(date_temp_reg_avg_withlags$region)=="SEFSC_GOMex"] <- "gmex"
colnames(date_temp_reg_avg_withlags)[colnames(date_temp_reg_avg_withlags) == "region"] <- "reg"

date_temp_reg_avg$year <- as.numeric(date_temp_reg_avg$year)
spp_master_ztemp <- left_join(spp_master, date_temp_reg_avg_withlags, by = c("reg", "year"))
```
First, let's ignore traits, and just look at temperature as predictors of yes no colonization and yes no extinction
Colonization in this year: col
Goes extinct in this year (here last year, gone now) : now_ext
Mean temp: region year mean sst
Max temp:region year max sst
Min temp: region year min sst
Seasonality: region year seas sst

Colonization base mod
```{r}
col_mod <- glmer(col ~ region_year_mean_sst + region_year_max_sst + region_year_min_sst + region_year_seas_sst + (1|reg) + (1|year), data = spp_master_ztemp, family = binomial)
summary(col_mod)
```

Extinction base mod
```{r}
ext_mod <- glmer(now_ext ~ region_year_mean_sst + region_year_max_sst + region_year_min_sst + region_year_seas_sst + (1|reg) + (1|year), data = spp_master_ztemp, family = binomial)
summary(ext_mod)
```
The above models perform really poorly, but this doesn't really surprise me. I think change in temperature is a bigger deal, although I am surprised that seasonality doesn't do anything. 

Let's now take a look at change only 

```{r}
col_mod_change <- glmer(col ~ sst_mean_change + sst_max_change + sst_min_change + sst_seas_change + (1|reg) + (1|year), data = spp_master_ztemp, family = binomial)
summary(col_mod_change)
ext_mod_change <- glmer(now_ext ~ sst_mean_change + sst_max_change + sst_min_change + sst_seas_change + (1|reg) + (1|year), data = spp_master_ztemp, family = binomial)
summary(ext_mod_change)
```

Let's now take a look at absolute value of temp change from previous year only
```{r}
col_mod_change_abs <- glmer(col ~ sst_mean_change_abs + sst_max_change_abs + sst_min_change_abs + sst_seas_change_abs + (1|reg) + (1|year), data = spp_master_ztemp, family = binomial)
summary(col_mod_change_abs)
```
This one above actually gives really good results, this is exciting!
When absolute change in max yearly temperature INCREASES, likelihood of colonization increase
When absolute change in seasonality INCREASES, likelihood of colonizations decreases
When absolute change in mean yearly temperature INCREASES, likelihood of colonization increases

How do we feel about the mixed effects? Let's compare AIC
```{r}
options(na.action = "na.omit")
col_mod_change_abs_regasrandom <- glmer(col ~ sst_mean_change_abs + sst_max_change_abs + sst_min_change_abs + sst_seas_change_abs + (1|reg), data = spp_master_ztemp, family = binomial)
col_mod_change_abs_yearasrandom <- glmer(col ~ sst_mean_change_abs + sst_max_change_abs + sst_min_change_abs + sst_seas_change_abs + (1|year), data = spp_master_ztemp, family = binomial)
col_mod_change_abs_norandom <- glm(col ~ sst_mean_change_abs + sst_max_change_abs + sst_min_change_abs + sst_seas_change_abs, data = spp_master_ztemp, family = binomial)
AICc(col_mod_change_abs, col_mod_change_abs_regasrandom,col_mod_change_abs_yearasrandom, col_mod_change_abs_norandom)
```
Best with both random effects!!


```{r}
ext_mod_change_abs <- glmer(now_ext ~ sst_mean_change_abs + sst_max_change_abs + sst_min_change_abs + sst_seas_change_abs + (1|reg) + (1|year), data = spp_master_ztemp, family = binomial)
summary(ext_mod_change_abs)
```
Not as exciting as colonizations, but not surprised.
When absolute change in mean yearly temperature INCREASES, likelihood of extinction ALSO increases

Again, how do we feel about the mixed effects in our extinction model? Let's compare AIC
```{r}
options(na.action = "na.omit")
ext_mod_change_abs_regasrandom <- glmer(now_ext ~ sst_mean_change_abs + sst_max_change_abs + sst_min_change_abs + sst_seas_change_abs + (1|reg), data = spp_master_ztemp, family = binomial)
ext_mod_change_abs_yearasrandom <- glmer(now_ext ~ sst_mean_change_abs + sst_max_change_abs + sst_min_change_abs + sst_seas_change_abs + (1|year), data = spp_master_ztemp, family = binomial)
ext_mod_change_abs_norandom <- glm(now_ext ~ sst_mean_change_abs + sst_max_change_abs + sst_min_change_abs + sst_seas_change_abs, data = spp_master_ztemp, family = binomial)
AICc(ext_mod_change_abs, ext_mod_change_abs_regasrandom,ext_mod_change_abs_yearasrandom, ext_mod_change_abs_norandom)
```
Best with both random effects!!

Now, let's play around with lags a bit using dredge, 
#this didn't work because of NA's, I guess I'll compare one by one then??
https://rdrr.io/cran/MuMIn/src/demo/dredge.subset.R
```{r}
colnames(spp_master_ztemp)
#I want to look at columns 89:136 as possible predictors
subset <- spp_master_ztemp[,c(6, 89:136)]
#let's get rid of na's
options(na.action = "na.fail")
#fitting global model
fm_col <- glm(col ~ ., family = binomial, data = subset)
dd <- dredge(fm_col)
variables_dredge <- colnames(spp_master_ztemp[89:136])
list_variables <- gsub("," , " + " , toString(variables_dredge))
```

What model performs better? a model with changes in the past year? or a model with changes in the year before last?

First, let's make a model with changes from the year before last for colonization
```{r}
col_mod_change_abs_lag1 <- glmer(col ~ sst_mean_change_lag1_abs + sst_max_change_lag1_abs + sst_min_change_lag1_abs + sst_seas_change_lag1_abs + (1|reg) + (1|year), data = spp_master_ztemp, family = binomial)
summary(col_mod_change_abs_lag1)
```
Not much info from summary, but let's compare using AICc with other model
```{r}
AICc(col_mod_change_abs, col_mod_change_abs_lag1)
```

Poor results here! What about extinction?
```{r}
ext_mod_change_abs_lag1 <- glmer(now_ext ~ sst_mean_change_lag1_abs + sst_max_change_lag1_abs + sst_min_change_lag1_abs + sst_seas_change_lag1_abs + (1|reg) + (1|year), data = spp_master_ztemp, family = binomial)
summary(ext_mod_change_abs_lag1)
```
For extinction and lag 1 of changes, both absolute value of change in mean experienced last year and absolute value of change in max temp experienced last year appear significant
As absolute value of change in mean experienced last year increases, likelihood of extinction decreases
As absolute value of change in max temp experienced last year increases, likelihood of extinction increases

But what about comparing this to other model?
```{r}
AICc(ext_mod_change_abs, ext_mod_change_abs_lag1)
```
Here, unlike colonization, it appears that changes experienced LAST year are better than changes experienced this year at predicting extinction

Let's go back once more in time for each for kicks

Colonization based on changes in temp experienced between 2-3 years ago
```{r}
col_mod_change_abs_lag2 <- glmer(col ~ sst_mean_change_lag2_abs + sst_max_change_lag2_abs + sst_min_change_lag2_abs + sst_seas_change_lag2_abs + (1|reg) + (1|year), data = spp_master_ztemp, family = binomial)
summary(col_mod_change_abs_lag2)
```
And compare this using AICc to other models
```{r}
AICc(col_mod_change_abs, col_mod_change_abs_lag1, col_mod_change_abs_lag2)
```
Both incorporating lags in changes are equally poor for colonization, so we'll stick with most recent changes in temp variables. 

Next step, I will take away variables and see what's best for colonization using AIC
```{r}
summary(col_mod_change_abs)
```

```{r}
#remember, variables with best P values for colonization ARE seas, and then max, and then mean (min not significant)
col_mod_change_abs_3_var <- glmer(col ~ sst_mean_change_abs + sst_max_change_abs + sst_seas_change_abs + (1 | reg) + (1 | year), family = binomial, data = spp_master_ztemp)

col_mod_change_abs_2_var <- glmer(col ~ sst_max_change_abs + sst_seas_change_abs + (1 | reg) + (1 | year), family = binomial, data = spp_master_ztemp)

col_mod_change_abs_1_var <- glmer(col ~ sst_seas_change_abs + (1 | reg) + (1 | year), family = binomial, data = spp_master_ztemp)

AICc(col_mod_change_abs_1_var, col_mod_change_abs_2_var, col_mod_change_abs_3_var, col_mod_change_abs)
summary(col_mod_change_abs_1_var)
```
**The best model uses only seasonality as a predictor**
col_mod_change_abs_1_var <- glmer(col ~ sst_seas_change_abs + (1 | reg) + (1 | year), family = binomial, data = spp_master_ztemp)

Extinction based on changes in temp experienced between 2-3 years ago
```{r}
ext_mod_change_abs_lag2 <- glmer(now_ext ~ sst_mean_change_lag2_abs + sst_max_change_lag2_abs + sst_min_change_lag2_abs + sst_seas_change_lag2_abs + (1|reg) + (1|year), data = spp_master_ztemp, family = binomial)
summary(ext_mod_change_abs_lag2)
```
And compare this using AICc to other models
```{r}
AICc(ext_mod_change_abs, ext_mod_change_abs_lag1, ext_mod_change_abs_lag2)
```
Both lags improve model, so I'll go another level back in changes are equally poor, so we'll stick with most recent changes. 
```{r}
ext_mod_change_abs_lag3 <- glmer(now_ext ~ sst_mean_change_lag3_abs + sst_max_change_lag3_abs + sst_min_change_lag3_abs + sst_seas_change_lag3_abs + (1|reg) + (1|year), data = spp_master_ztemp, family = binomial)
summary(ext_mod_change_abs_lag3)
AICc(ext_mod_change_abs, ext_mod_change_abs_lag1, ext_mod_change_abs_lag2, ext_mod_change_abs_lag3)
```
The best is lag 2, so the change from 2-3 years ago is best at determining extinction probability

Next step, I will take away variables and see what's best for extinction using AIC

```{r}
summary(ext_mod_change_abs_lag2)
```

```{r}
#remember, variables with best P values for extinction with 2 lag are max change lag 2 abs, mean change lag 2 abs, seas change lag 2 abs, and last min change lag 2 abs
ext_mod_change_lag2_abs_3_var <- glmer(now_ext ~ sst_mean_change_lag2_abs + sst_max_change_lag2_abs + sst_seas_change_lag2_abs + (1 | reg) + (1 | year), family = binomial, data = spp_master_ztemp)
ext_mod_change_lag2_abs_2_var <- glmer(now_ext ~ sst_mean_change_lag2_abs + sst_max_change_lag2_abs + (1 | reg) + (1 | year), family = binomial, data = spp_master_ztemp)
ext_mod_change_lag2_abs_1_var <- glmer(now_ext ~ sst_max_change_lag2_abs + (1 | reg) + (1 | year), family = binomial, data = spp_master_ztemp)

AICc(ext_mod_change_lag2_abs_3_var, ext_mod_change_lag2_abs_1_var, ext_mod_change_lag2_abs_2_var, ext_mod_change_abs_lag2)
```
The best model is less clear here, ext_mod_change_lag2_abs_2_var has the lowest AICc, but, it's not substantially lower, and ext_mod_change_lag2_abs_1_var has fewer predictors, so let's go with that
**ext_mod_change_lag2_abs_1_var <- glmer(now_ext ~ sst_max_change_lag2_abs + (1 | reg) + (1 | year), family = binomial, data = spp_master_ztemp)**: best model for extinction
```{r}
summary(ext_mod_change_lag2_abs_1_var)
```
We're able to explain 12% of variation in extinction from the change in maximum temperature between 2-3 years ago (extinction debt?)

**col_mod_change_abs_1_var <- glmer(col ~ sst_seas_change_abs + (1 | reg) + (1 | year), family = binomial, data = spp_master_ztemp)**: best model for colonization
```{r}
summary(col_mod_change_abs_1_var)
```
We're able to explain 13% of the variation in colonization with change in seasonality from last year

_______________

Now we will see if adding traits can improve the model, we only have traits for fish at this point, so we only care about fish so let's go back to earlier code to extract fish only

```{r}
load("fish_nofishkey.RData")
```

We will now limit spp_master_z to fish

```{r}
spp_master_ztemp_fishnofish <- left_join(spp_master_ztemp, fish_nofishkey, by = c("reg", "spp"))
spp_master_ztemp_fishnofish$fish <- as.factor(spp_master_ztemp_fishnofish$fish)
spp_master_ztemp_fishonly <- spp_master_ztemp_fishnofish %>%
  filter(fish == "Y")
?filter
summary(spp_master_ztemp_fishnofish$fish) # I have NA's but I will ignore for now
```
Let's now link to traits!
```{r}
traits <- read.csv("traits_formanip.csv")
traits$spp <- paste(traits$genus, traits$species, sep = " ")
#restrict to LME 1:9 and 54 according to https://www.st.nmfs.noaa.gov/ecosystems/lme/
levels(as.factor(traits$lme))
traits_NA <- traits %>%
  dplyr::filter(lme < 10 | lme == 54) %>%
  group_by(spp) %>%
  filter(row_number() == 1) #this means we only have one observation per species

spp_master_ztemp_fishonly_traits <- left_join(spp_master_ztemp_fishonly, traits_NA, by = "spp")
```

Traits that actually look reasonable to use

feeding.mode: benthivorous, generalist, herbivorous, piscivorous, planktivorous
  *maybe make this into generalist or specialist? (only 2 NA's) --> $generalist

tl: 2-4.65 (no NA's)

egg.size: 
  *(looks like I need to make this numeric or something) 111 NA's
  
spawning.type ( open_water-substratum, guarder, nonguarder, internal_bearer, external_bearer) 63 NA's

Lmax (2.5-1520) only 1 NA!

tmax (0.55 - 223) 181 NA's

tm (156 NA's) 

Lm (712 NA's) *exclude


Let's simplify feeding.mode to just generalist vs. specialist
```{r}
spp_master_ztemp_fishonly_traits$generalist <- NA
spp_master_ztemp_fishonly_traits$generalist[spp_master_ztemp_fishonly_traits$feeding.mode == "generalists"] <- 1
spp_master_ztemp_fishonly_traits$generalist[spp_master_ztemp_fishonly_traits$feeding.mode != "generalists"] <- 0
```
Let's look at egg size
```{r}
spp_master_ztemp_fishonly_traits$egg.size <- as.numeric(spp_master_ztemp_fishonly_traits$egg.size)
summary(spp_master_ztemp_fishonly_traits$egg.size)
#much better
```
For this analysis, I'm just going to look at trait values we have a lot of
generalist
tl
spawning.type
Lmax

Let's first run best models now that we're looking only at fish
reminders of best models:
col_mod_change_abs_1_var <- glmer(col ~ sst_seas_change_abs + (1 | reg) + (1 | year), family = binomial, data = spp_master_ztemp)
ext_mod_change_lag2_abs_1_var <- glmer(now_ext ~ sst_max_change_lag2_abs + (1 | reg) + (1 | year), family = binomial, data = spp_master_ztemp)

First colonization
```{r}
col_mod_change_abs_1_var_fishonly <- glmer(col ~ sst_seas_change_abs + (1 | reg) + (1 | year), family = binomial, data = spp_master_ztemp_fishonly_traits)
summary(col_mod_change_abs_1_var_fishonly)
AICc(col_mod_change_abs_1_var_fishonly, col_mod_change_abs_1_var)
#unclear, but the AICc value for the fish only model is much better even though it appears dismal interms of p value, let's try with all variables again
col_mod_change_abs_fishonly <- glmer(col ~ sst_mean_change_abs + sst_max_change_abs + sst_min_change_abs + sst_seas_change_abs + (1|reg) + (1|year), data = spp_master_ztemp_fishonly_traits, family = binomial)
summary(col_mod_change_abs_fishonly) #nothing is significant
#still we'll try to add in traits
col_mod_change_abs_1_var_fishonly_wtraits <- glmer(col ~ sst_seas_change_abs*generalist + (1 | reg) + (1 | year), family = binomial, data = spp_master_ztemp_fishonly_traits)
summary(col_mod_change_abs_1_var_fishonly_wtraits)
summary(col_mod_change_abs_1_var_fishonly)
AICc(col_mod_change_abs_1_var_fishonly_wtraits, col_mod_change_abs_1_var_fishonly)
```
Let's try the same with extinction
```{r}
ext_mod_change_lag2_abs_1_var_fishonly_wtraits <- glmer(now_ext ~ sst_max_change_lag2_abs*generalist + (1 | reg) + (1 | year), family = binomial, data = spp_master_ztemp_fishonly_traits)
summary(ext_mod_change_lag2_abs_1_var_fishonly_wtraits)
```


One idea would just be to seperate by mobility as Malin did in Nature 2019
Reminder, best Model Colonization:
col_mod_change_abs_1_var <- glmer(col ~ sst_seas_change_abs + (1 | reg) + (1 | year), family = binomial, data = spp_master_ztemp)

```{r}
#import Malin's dataset
mobility_traits <- read.csv("dataset_1_traits_nature.csv")
spp_master_ztemp_fishnofish_mobility <- inner_join(spp_master_ztemp_fishnofish, mobility_traits, by = "spp")
col_mod_change_abs_1_var_mobility <- glmer(col ~ sst_seas_change_abs*fish + (1 | reg) + (1 | year), family = binomial, data = spp_master_ztemp_fishnofish)
summary(col_mod_change_abs_1_var_sessilemobile)
AICc(col_mod_change_abs_1_var_sessilemobile, col_mod_change_abs_1_var)
```
Including sessile/mobile improves our ability to predict likelihood of colonization

What about extinction?
```{r}
ext_mod_change_lag2_abs_1_var_sessilemobile <- glmer(now_ext ~ sst_max_change_lag2_abs*fish + (1 | reg) + (1 | year), family = binomial, data = spp_master_ztemp_fishnofish)
summary(ext_mod_change_lag2_abs_1_var_sessilemobile)
AICc(ext_mod_change_lag2_abs_1_var, ext_mod_change_lag2_abs_1_var_sessilemobile)
```
Here, sessile/mobile also improves fit and also the interaction with change in maximum temperature. The role of mobility changes with the size of the change in temperature between years. 
