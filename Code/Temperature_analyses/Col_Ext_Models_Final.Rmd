---
title: "Gain and Loss Final Models"
output: html_notebook
---

This is a cleaned version of 04_24_19 Temp link trait fish.Rmd/11_20_19_Temp_link_traits_fish.Rmd.
Changes
* improved formatting
* easier to follow
* species and region as random effects
* scaling temperature values
* setting nACQ to 0, see why  [here](https://stats.stackexchange.com/questions/77313/why-cant-i-match-glmmTMB-family-binomial-output-with-manual-implementation-of-g). 

August 11, 2022: Working on Revisions from Global Ecology and Biogeography
* Add random effects for order, genus, family, etc.

```{r setup}
library(MuMIn)
library(lme4)
library(data.table)
library(ggplot2)
library(here)
library(wesanderson) # to color plots
library(taxize) #to obtain order, genus, family
library(dplyr)
library(DHARMa)

spp_master_ztemp_seus_buoy_scaled <- readRDS(here::here("Data","Spp_master", "spp_master_ztemp_seus_buoy_scaled.rds"))

```

Link up with spp key to add phylum, order, family, etc.
*Be careful not to run this more than once, or it will keep deleting more years
```{r pull in spp, order, family, etc.}
spp_key <- fread(here::here("Data","Spp_master","spp_key.csv")) #bring in list of species with phylogenetic classifications

#merge with spp_master
spp_master_ztemp_seus_buoy_scaled <- spp_key[spp_master_ztemp_seus_buoy_scaled, on = "spp", nomatch = NULL]

#delete first year each region is sampled (because gains and losses are based on transitions between years, so we need 2 years of observations)

spp_master_ztemp_seus_buoy_scaled[,min_year := min(year),.(reg)]

spp_master_ztemp_seus_buoy_scaled <- spp_master_ztemp_seus_buoy_scaled[year != min_year]

nrow(spp_master_ztemp_seus_buoy_scaled) == 17997    
```
*^check, is spp_master 17997 rows (down from 18856)?

Edit column names for understanding
```{r}
spp_master_ztemp_seus_buoy_scaled[,gain :=col][,loss := now_ext]
```


Running, and ranking gain models without traits

##Here, I scaled all temperature values across all regions, and included species as a random effect. In order to do this, I had to change the algorithm slightly--nAGQ = 0.

Gain Models with Additional random effects

```{r gain models without traits additional random effects for phylogeny }
#names of scaled columns
variables_scaled <- grep("*_scaled", names(spp_master_ztemp_seus_buoy_scaled), value = T)
#going to make loop to make all models I need to look at with a single temperature variable

#we don't end up looking at mean, delete here
variables_scaled <- variables_scaled[-grep('mean',variables_scaled)]

gain_model_comparison_taxonomy <- as.data.table(matrix(nrow = length(variables_scaled)))
gain_model_comparison_taxonomy[, variable:=as.factor(V1)][, coef:=as.numeric(V1)][, p_value:=as.numeric(V1)][, AICc:=as.numeric(V1)]
gain_model_comparison_taxonomy[, V1 := NULL]

for (i in 1:length(variables_scaled)){
  mod <- glmer(gain ~ get(variables_scaled[i]) + (1|reg) + (1|phylum) + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp),
               family = binomial, data = spp_master_ztemp_seus_buoy_scaled, nAGQ = 0)
  gain_model_comparison_taxonomy[i,variable := variables_scaled[i]]
  gain_model_comparison_taxonomy[i,coef := coef(summary(mod))[,"Estimate"][2]]
  gain_model_comparison_taxonomy[i,p_value := coef(summary(mod))[,"Pr(>|z|)"][2]]
  gain_model_comparison_taxonomy[i,AICc := AICc(mod)]
  
  print(paste(i, length(variables_scaled), sep = "/"))
    
}
saveRDS(object = gain_model_comparison_taxonomy, file = "gain_model_comparison_taxonomy.rds")


#by setting nACQ to 0, all models converged

saveRDS(object = gain_model_comparison_taxonomy, file = here("Model_results","gain_model_comparison_taxonomy.rds"))

#saveRDS(object = gain_model_comparison_taxonomy, file = "gain_model_comparison_taxonomy.rds") #annotate file structure

fwrite(gain_model_comparison_taxonomy, file = here("Model_results","gain_model_comparison_taxonomy.csv"))

gain_model_comparison_taxonomy <- readRDS(here::here("Model_results","gain_model_comparison_taxonomy.rds"))

```

Model performance and assumptions and temporal autocorrelation. 
```{r}
#let's take a look at best performing model, and check assumptions
mod_extrarandom_gain <- glmer(gain ~ seas_sst_temp_scaled  + (1|reg) + (1|phylum) + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp), family = binomial, data = spp_master_ztemp_seus_buoy_scaled, nAGQ = 0)

#Performance
#R-Squared
r.squaredGLMM(mod_extrarandom_gain)
summary(mod_extrarandom_gain)

#theoretical variance:
  #the variance explained by the fixed effects: 0.04386344
  #a variance explained by the entire model, including both fixed and random effects: 0.4576593

#delta (observational) variance:
  #the variance explained by the fixed effects: 0.01999300
  #a variance explained by the entire model, including both fixed and random effects: 0.2086015

#coef =  -0.52
#how much the probability changes with a given change in temperature
spp_master_ztemp_seus_buoy_scaled.r <- spp_master_ztemp_seus_buoy_scaled[complete.cases(spp_master_ztemp_seus_buoy_scaled[ , .(seas_sst_temp_scaled, gain, loss, reg, phylum, class, order, family, genus, spp)]),]

#Model assumptions using DHARMa package
#Test for overdispersion
#grouping basically transforms 0/1 response (bernoulli) in a k/n response (true binomial)
#https://cran.r-project.org/web/packages/DHARMa/vignettes/DHARMa.html#binomial-data
#group by region
simulationOutput <- simulateResiduals(fittedModel = mod_extrarandom_gain)
simulationOutput.groupedbyreg <- recalculateResiduals(simulationOutput, group = spp_master_ztemp_seus_buoy_scaled.r$reg)
testDispersion(simulationOutput)
testDispersion(simulationOutput.groupedbyreg)
plot(simulationOutput.groupedbyreg)

#group by spp
simulationOutput.groupedbyspp <- recalculateResiduals(simulationOutput, group = spp_master_ztemp_seus_buoy_scaled.r$spp)
testDispersion(simulationOutput)
testDispersion(simulationOutput.groupedbyspp)
plot(simulationOutput.groupedbyspp)

#group by time
simulationOutput.groupedbyyear <- recalculateResiduals(simulationOutput, group = spp_master_ztemp_seus_buoy_scaled.r$year)
testDispersion(simulationOutput)
testDispersion(simulationOutput.groupedbyyear)
plot(simulationOutput.groupedbyyear)

#temporal autocorrelation
testTemporalAutocorrelation(simulationOutput.groupedbyyear, unique(spp_master_ztemp_seus_buoy_scaled.r$year))


```
"The estimate for seasonality of -0.52 means that a 1 degree increase in seasonality is associated with a 0.52 decrease in the log-odds of a Gain occuring, compared to no Gain occuring. If we exponentiate this number then we obtain the odds ratio of 0.59, which means that for a 1 degree increase in Seasonality we expect to see (approximately) a 41% decrease in the odds of a Gain Occurring." From this [Stack Exchange post](https://stats.stackexchange.com/questions/444797/interpreting-a-generalised-linear-mixed-model-with-binomial-data). 

###Loss Models without Traits but with random effects for phylogeny
```{r loss models without traits with random effect phylogeny}

loss_model_comparison_taxonomy <- as.data.table(matrix(nrow = length(variables_scaled)))
loss_model_comparison_taxonomy[, variable:=as.factor(V1)][, coef:=as.numeric(V1)][, p_value:=as.numeric(V1)][, AICc:=as.numeric(V1)]
loss_model_comparison_taxonomy[, V1 := NULL]

for (i in 1:length(variables_scaled)){
  mod <- glmer(loss ~ get(variables_scaled[i]) + (1|reg) + (1|phylum) + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp), family = binomial, data = spp_master_ztemp_seus_buoy_scaled, nAGQ = 0)
  loss_model_comparison_taxonomy[i,variable := variables_scaled[i]]
  loss_model_comparison_taxonomy[i,coef := coef(summary(mod))[,"Estimate"][2]]
  loss_model_comparison_taxonomy[i,p_value := coef(summary(mod))[,"Pr(>|z|)"][2]]
  loss_model_comparison_taxonomy[i,AICc := AICc(mod)]
  
  print(paste(i, length(variables_scaled), sep = "/"))
    
}


saveRDS(object = loss_model_comparison_taxonomy, file = here("Model_results","loss_model_results_taxonomy.rds"))
fwrite(loss_model_comparison_taxonomy, file = here("Model_results","loss_model_results_taxonomy.csv"))

loss_model_comparison_taxonomy <- readRDS(here::here("Model_results","loss_model_results_taxonomy.rds"))

#let's take a look at best performing model, and check assumptions
mod_extrarandom_loss <- glmer(loss ~ seas_sst_temp_lag3_scaled  + (1|reg) + (1|phylum) + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp), family = binomial, data = spp_master_ztemp_seus_buoy_scaled, nAGQ = 0)

#let's also look at best performing model without random effects
mod_extrarandom_loss_noRE <- glm(loss ~ seas_sst_temp_lag3_scaled, family = binomial, data = spp_master_ztemp_seus_buoy_scaled)

#R-Squared
r.squaredGLMM(mod_extrarandom_loss)

#theoretical variance:
  #the variance explained by the fixed effects: 0.04446483
  #a variance explained by the entire model, including both fixed and random effects: 0.5042519

#delta (observational) variance:
  #the variance explained by the fixed effects: 0.01527950
  #a variance explained by the entire model, including both fixed and random effects: 0.1732767

#coef =  -0.545
#how much the probability changes with a given change in temperature

#Model assumptions using DHARMa package
#Test for overdispersionx
#grouping basically transforms 0/1 response (bernoulli) in a k/n response (true binomial)
#https://cran.r-project.org/web/packages/DHARMa/vignettes/DHARMa.html#binomial-data
#group by region
simulationOutput_loss <- simulateResiduals(fittedModel = mod_extrarandom_loss)
simulationOutput.groupedbyreg_loss <- recalculateResiduals(simulationOutput_loss, group = spp_master_ztemp_seus_buoy_scaled.r$reg)
testDispersion(simulationOutput_loss)
testDispersion(simulationOutput.groupedbyreg_loss)
plot(simulationOutput.groupedbyreg_loss)

#no random effects
simulationOutput_loss_noRE <- simulateResiduals(fittedModel = mod_extrarandom_loss_noRE)
simulationOutput.groupedbyreg_loss_noRE <- recalculateResiduals(simulationOutput_loss_noRE, group = spp_master_ztemp_seus_buoy_scaled.r$reg)
testDispersion(simulationOutput_loss_noRE)
testDispersion(simulationOutput.groupedbyreg_loss_noRE)
plot(simulationOutput.groupedbyreg_loss_noRE)



#group by spp
simulationOutput.groupedbyspp_loss <- recalculateResiduals(simulationOutput_loss, group = spp_master_ztemp_seus_buoy_scaled.r$spp)
testDispersion(simulationOutput_loss)
testDispersion(simulationOutput.groupedbyspp_loss)
plot(simulationOutput.groupedbyspp_loss)

#with no random effects
simulationOutput.groupedbyspp_loss_noRE <- recalculateResiduals(simulationOutput_loss_noRE, group = spp_master_ztemp_seus_buoy_scaled.r$spp)
testDispersion(simulationOutput_loss_noRE)
testDispersion(simulationOutput.groupedbyspp_loss_noRE)
plot(simulationOutput.groupedbyspp_loss_noRE)

#group by time
simulationOutput.groupedbyyear_loss <- recalculateResiduals(simulationOutput_loss, group = spp_master_ztemp_seus_buoy_scaled.r$year)
testDispersion(simulationOutput_loss)
testDispersion(simulationOutput.groupedbyyear_loss)
plot(simulationOutput.groupedbyyear_loss)

#temporal autocorrelation
testTemporalAutocorrelation(simulationOutput.groupedbyyear_loss, unique(spp_master_ztemp_seus_buoy_scaled.r$year))

```
"The estimate for seasonality of -0.3242 means that a 1 degree increase in seasonality is associated with a 0.3242 decrease in the log-odds of a Loss occuring, compared to no Loss occuring. If we exponentiate this number then we obtain the odds ratio of 0.7231, which means that for a 1 degree increase in Seasonality we expect to see (approximately) a 18% decrease in the odds of a Loss Occurring." From this [Stack Exchange post](https://stats.stackexchange.com/questions/444797/interpreting-a-generalised-linear-mixed-model-with-binomial-data). 



##Relative Variable Importance

How does the null model with only random effects perform?
```{r null models}
#add null to tables
intercept_gain_mod_scaled <- glmer(gain ~ (1|reg) + (1|phylum) + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp), family = binomial, data = spp_master_ztemp_seus_buoy_scaled, nAGQ = 0)

r.squaredGLMM(intercept_gain_mod_scaled)

intercept_loss_mod_scaled <- glmer(loss ~ (1|reg) + (1|phylum) + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp), family = binomial, data = spp_master_ztemp_seus_buoy_scaled, nAGQ = 0)

r.squaredGLMM(intercept_loss_mod_scaled)

#            R2m       R2c
#theoretical   0 0.4233395
#delta         0 0.1370641

#best model better than null? yes
AICc(intercept_gain_mod_scaled)-AICc(mod_extrarandom_gain)
AICc(intercept_loss_mod_scaled)-AICc(mod_extrarandom_loss)


```

Relative Variable Importance for Gain Models
```{r RVI gains}
#add ∆AIC to tables
min_gain_AICc <- min(gain_model_comparison_taxonomy[, AICc])
gain_model_comparison_taxonomy[,"deltaAICc" := (AICc - min_gain_AICc)]

#add relative likelihood exp( -0.5 * ∆AIC score for that model)
gain_model_comparison_taxonomy[,"rel_likelihood" := exp((-0.5 * deltaAICc))]
#sum relative likelihoods across all models
gain_model_comparison_taxonomy.likelihoodsum <- sum(gain_model_comparison_taxonomy[, rel_likelihood])
#Akaike weight for a model is this rel_likelihood divided by the sum of these values across all models
gain_model_comparison_taxonomy[,"akaike_weight" := rel_likelihood/gain_model_comparison_taxonomy.likelihoodsum]

#I want to look at relative importance FOR:

#bottom/surface (bottom = includes sbt, grepl("sbt", variable))
gain_bottom_importance <- sum(gain_model_comparison_taxonomy[grep("sbt", variable), ]$akaike_weight)
gain_surface_importance <- sum(gain_model_comparison_taxonomy[grep("sst", variable), ]$akaike_weight)

#lag/not lagged (grepl("lag", variable))
gain_lag_importance <- sum(gain_model_comparison_taxonomy[grep("lag", variable), ]$akaike_weight)
gain_nolag_importance <- sum(gain_model_comparison_taxonomy[!grep("lag", variable), ]$akaike_weight)

#absolute (grepl("abs", variable))
gain_abs_importance <- sum(gain_model_comparison_taxonomy[grep("abs", variable), ]$akaike_weight)

#raw (!grepl("change"))
gain_raw_importance <- sum(gain_model_comparison_taxonomy[!grep("change", variable), ]$akaike_weight)

#change (grepl("change", variable), (!grepl("abs")))
gain_change_importance <- sum(gain_model_comparison_taxonomy[grep("change", variable), ][!grep("abs", variable),]$akaike_weight)

#type of temp variable (max, min, seas)
gain_max_temp_importance <- sum(gain_model_comparison_taxonomy[grep("max", variable), ]$akaike_weight)
gain_min_temp_importance <- sum(gain_model_comparison_taxonomy[grep("min", variable), ]$akaike_weight)
gain_seas_temp_importance <- sum(gain_model_comparison_taxonomy[grep("seas", variable), ]$akaike_weight)

gain_model_comparison_taxonomy_akaikeweights <- gain_model_comparison_taxonomy

saveRDS(gain_model_comparison_taxonomy_akaikeweights, file = here("Model_results","gain_model_comparison_taxonomy_akaikeweights.rds"))
saveRDS(gain_model_comparison_taxonomy_akaikeweights, file = here("tables","gain_model_comparison_taxonomy_akaikeweights.rds"))
gain_model_comparison_taxonomy_akaikeweights <- readRDS(file = here("Model_results","gain_model_comparison_taxonomy_akaikeweights.rds"))

```

Relative Variable Importance for different Pairs of Transformation and Metric
```{r RVI gain Pairs Transformation and Metric}

#I want to look at relative importance FOR 
#models with raw and min
gain_raw_min_importance <- sum(gain_model_comparison_taxonomy[grep("min", variable), ][!grep("change", variable)]$akaike_weight)

#models with raw and max
gain_raw_max_importance <- sum(gain_model_comparison_taxonomy[grep("max", variable), ][!grep("change", variable)]$akaike_weight)

#models with raw and seas
gain_raw_seas_importance <- sum(gain_model_comparison_taxonomy[grep("seas", variable), ][!grep("change", variable)]$akaike_weight)


#models with change and min
gain_change_min_importance <- sum(gain_model_comparison_taxonomy[grep("min_s.t_temp_change", variable), ][!grep("abs", variable)]$akaike_weight)

#models with change and max
gain_change_max_importance <- sum(gain_model_comparison_taxonomy[grep("max_s.t_temp_change", variable), ][!grep("abs", variable)]$akaike_weight)

#models with change and seas
gain_change_seas_importance <- sum(gain_model_comparison_taxonomy[grep("seas_s.t_temp_change", variable), ][!grep("abs", variable)]$akaike_weight)

#models with abs change and min
gain_abs_change_min_importance <- sum(gain_model_comparison_taxonomy[grep("min_s.t_temp_change_abs", variable), ]$akaike_weight)

#models with abs change and max
gain_abs_change_max_importance <- sum(gain_model_comparison_taxonomy[grep("max_s.t_temp_change_abs", variable), ]$akaike_weight)

#models with abs change and seas
gain_abs_change_seas_importance <- sum(gain_model_comparison_taxonomy[grep("seas_s.t_temp_change_abs", variable), ]$akaike_weight)

gain_transform_metric_comparison <- data.table(Transformation =
                                                c("raw", "raw", "raw", "change", "change", "change", "abs_change", "abs_change", "abs_change"), 
                                              Metric = 
                                                rep(c("min", "max", "seas"), 3), 
                                              RVI = 
                                                c(gain_raw_min_importance, gain_raw_max_importance, 
                                                  gain_raw_seas_importance, gain_change_min_importance, 
                                                  gain_change_max_importance, gain_change_seas_importance, 
                                                  gain_abs_change_min_importance, gain_abs_change_max_importance, 
                                                  gain_abs_change_seas_importance))


```


Relative Variable Importance Loss Models
```{r RVI loss}
#add ∆AIC to tables
min_loss_AICc <- min(loss_model_comparison_taxonomy[, AICc])
loss_model_comparison_taxonomy[,"deltaAICc" := (AICc - min_loss_AICc)]

#add relative likelihood exp( -0.5 * ∆AIC score for that model)
loss_model_comparison_taxonomy[,"rel_likelihood" := exp((-0.5 * deltaAICc))]
#sum relative likelihoods across all models
loss_model_comparison_taxonomy.likelihoodsum <- sum(loss_model_comparison_taxonomy[, rel_likelihood])
#Akaike weight for a model is this rel_likelihood devided by the sum of these values across all models
loss_model_comparison_taxonomy[,"akaike_weight" := rel_likelihood/loss_model_comparison_taxonomy.likelihoodsum]

#I want to look at relative importance FOR 
#bottom/surface (bottom = includes sbt, grepl("sbt", variable))
loss_bottom_importance <- sum(loss_model_comparison_taxonomy[grep("sbt", variable), ]$akaike_weight)
loss_surface_importance <- sum(loss_model_comparison_taxonomy[grep("sst", variable), ]$akaike_weight)

#lag/not lagged (grepl("lag", variable))
loss_lag_importance <- sum(loss_model_comparison_taxonomy[grep("lag", variable), ]$akaike_weight)
loss_nolag_importance <- sum(loss_model_comparison_taxonomy[!grep("lag", variable), ]$akaike_weight)

#absolute (grepl("abs", variable))
loss_abs_importance <- sum(loss_model_comparison_taxonomy[grep("abs", variable), ]$akaike_weight)

#raw (!grepl("change"))
loss_raw_importance <- sum(loss_model_comparison_taxonomy[!grep("change", variable), ]$akaike_weight)

#change (grepl("change", variable), (!grepl("abs")))
loss_change_importance <- sum(loss_model_comparison_taxonomy[grep("change", variable), ][!grep("abs", variable),]$akaike_weight)

#type of temp variable (max, min, seas)
loss_max_temp_importance <- sum(loss_model_comparison_taxonomy[grep("max", variable), ]$akaike_weight)
loss_min_temp_importance <- sum(loss_model_comparison_taxonomy[grep("min", variable), ]$akaike_weight)
loss_seas_temp_importance <- sum(loss_model_comparison_taxonomy[grep("seas", variable), ]$akaike_weight)

loss_model_comparison_taxonomy_akaikeweights <- loss_model_comparison_taxonomy

saveRDS(loss_model_comparison_taxonomy_akaikeweights, file = here("Model_results","loss_model_comparison_taxonomy_akaikeweights.rds"))
saveRDS(loss_model_comparison_taxonomy_akaikeweights, file = here("tables","loss_model_comparison_taxonomy_akaikeweights.rds"))
loss_model_comparison_taxonomy_akaikeweights <- readRDS(file = here("Model_results","loss_model_comparison_taxonomy_akaikeweights.rds"))

```

Relative Variable Importance for Pairs of Transformation and Metric Predicting loss
```{r RVI loss Pairs Transformation and Metric}

#I want to look at relative importance FOR 
#models with raw and min
loss_raw_min_importance <- sum(loss_model_comparison_taxonomy[grep("min", variable), ][!grep("change", variable)]$akaike_weight)

#models with raw and max
loss_raw_max_importance <- sum(loss_model_comparison_taxonomy[grep("max", variable), ][!grep("change", variable)]$akaike_weight)

#models with raw and seas
loss_raw_seas_importance <- sum(loss_model_comparison_taxonomy[grep("seas", variable), ][!grep("change", variable)]$akaike_weight)


#models with change and min
loss_change_min_importance <- sum(loss_model_comparison_taxonomy[grep("min_s.t_temp_change", variable), ][!grep("abs", variable)]$akaike_weight)

#models with change and max
loss_change_max_importance <- sum(loss_model_comparison_taxonomy[grep("max_s.t_temp_change", variable), ][!grep("abs", variable)]$akaike_weight)

#models with change and seas
loss_change_seas_importance <- sum(loss_model_comparison_taxonomy[grep("seas_s.t_temp_change", variable), ][!grep("abs", variable)]$akaike_weight)

#models with abs change and min
loss_abs_change_min_importance <- sum(loss_model_comparison_taxonomy[grep("min_s.t_temp_change_abs", variable), ]$akaike_weight)

#models with abs change and max
loss_abs_change_max_importance <- sum(loss_model_comparison_taxonomy[grep("max_s.t_temp_change_abs", variable), ]$akaike_weight)

#models with abs change and seas
loss_abs_change_seas_importance <- sum(loss_model_comparison_taxonomy[grep("seas_s.t_temp_change_abs", variable), ]$akaike_weight)

loss_transform_metric_comparison <- data.table(Transformation =
                                                c("raw", "raw", "raw", "change", "change", "change", "abs_change", "abs_change", "abs_change"), 
                                              Metric = 
                                                rep(c("min", "max", "seas"), 3), 
                                              RVI = 
                                                c(loss_raw_min_importance, loss_raw_max_importance, 
                                                  loss_raw_seas_importance, loss_change_min_importance, 
                                                  loss_change_max_importance, loss_change_seas_importance, 
                                                  loss_abs_change_min_importance, loss_abs_change_max_importance, 
                                                  loss_abs_change_seas_importance))

```


Let's see how the RVI importance varies by looking at specific lag values
```{r make a plot here for variability across lag values}

#first, table for lags
lags_RVI_scaled <- data.table(gain_lag = c(0:9), gain_RVI = 0, loss_RVI = 0)

#gains
lags_RVI_scaled[1,2] <- 1-sum(gain_model_comparison_taxonomy[grep("lag", variable), ]$akaike_weight)
lags_RVI_scaled[2,2] <- sum(gain_model_comparison_taxonomy[grep("lag1", variable), ]$akaike_weight)
lags_RVI_scaled[3,2] <- sum(gain_model_comparison_taxonomy[grep("lag2", variable), ]$akaike_weight)
lags_RVI_scaled[4,2] <- sum(gain_model_comparison_taxonomy[grep("lag3", variable), ]$akaike_weight)
lags_RVI_scaled[5,2] <- sum(gain_model_comparison_taxonomy[grep("lag4", variable), ]$akaike_weight)
lags_RVI_scaled[6,2] <- sum(gain_model_comparison_taxonomy[grep("lag5", variable), ]$akaike_weight)
lags_RVI_scaled[7,2] <- sum(gain_model_comparison_taxonomy[grep("lag6", variable), ]$akaike_weight)
lags_RVI_scaled[8,2] <- sum(gain_model_comparison_taxonomy[grep("lag7", variable), ]$akaike_weight)
lags_RVI_scaled[9,2] <- sum(gain_model_comparison_taxonomy[grep("lag8", variable), ]$akaike_weight)
lags_RVI_scaled[10,2] <- sum(gain_model_comparison_taxonomy[grep("lag9", variable), ]$akaike_weight)

#losss
lags_RVI_scaled[1,3] <- 1-sum(loss_model_comparison_taxonomy[grep("lag", variable), ]$akaike_weight)
lags_RVI_scaled[2,3] <- sum(loss_model_comparison_taxonomy[grep("lag1", variable), ]$akaike_weight)
lags_RVI_scaled[3,3] <- sum(loss_model_comparison_taxonomy[grep("lag2", variable), ]$akaike_weight)
lags_RVI_scaled[4,3] <- sum(loss_model_comparison_taxonomy[grep("lag3", variable), ]$akaike_weight)
lags_RVI_scaled[5,3] <- sum(loss_model_comparison_taxonomy[grep("lag4", variable), ]$akaike_weight)
lags_RVI_scaled[6,3] <- sum(loss_model_comparison_taxonomy[grep("lag5", variable), ]$akaike_weight)
lags_RVI_scaled[7,3] <- sum(loss_model_comparison_taxonomy[grep("lag6", variable), ]$akaike_weight)
lags_RVI_scaled[8,3] <- sum(loss_model_comparison_taxonomy[grep("lag7", variable), ]$akaike_weight)
lags_RVI_scaled[9,3] <- sum(loss_model_comparison_taxonomy[grep("lag8", variable), ]$akaike_weight)
lags_RVI_scaled[10,3] <- sum(loss_model_comparison_taxonomy[grep("lag9", variable), ]$akaike_weight)

saveRDS(lags_RVI_scaled, here("Model_results","lags_RVI_scaled.rds"))

#visualize lags through time
ggplot(data = lags_RVI_scaled, aes(x = gain_lag)) +
  geom_line(aes(y = gain_RVI), ) +
  geom_line(aes(y = loss_RVI), linetype = "dashed") +
  labs(x = "Lag (years)", y = "Relative Variable Importance") +
  scale_color_discrete() + #how to make a legend
  theme_classic() +
  theme(text = element_text(size = 20)) +
  scale_x_continuous(breaks = c(0:9))

```

Table for RVI data for gain
```{r put RVIs for gain into data table}
gain_loss <- c("gain","gain","gain","gain","gain", "gain","gain", "gain", "gain","gain","gain","gain","gain","gain", "gain","gain", "gain", "gain","gain")
type <- c("Depth", "Depth", "lag", "lag", "Transformation", "Transformation", "Transformation", "Metric", "Metric", "Metric", "Transformation x Metric", "Transformation x Metric", "Transformation x Metric", "Transformation x Metric", "Transformation x Metric", "Transformation x Metric", "Transformation x Metric", "Transformation x Metric", "Transformation x Metric")
variable <- c("Bottom", "Surface", "no_lag", "lagged", "|Change|", "Change", "Raw", "Min", "Max", "Seas", "Raw x Min", "Raw x Max", "Raw x Seas", "Change x Min", "Change x Max", "Change x Seas", "|Change| x Min", "|Change| x Max", "|Change| x Seas")


value <- c(gain_bottom_importance, gain_surface_importance, gain_nolag_importance, gain_lag_importance, gain_abs_importance, gain_change_importance, gain_raw_importance, gain_min_temp_importance, gain_max_temp_importance, gain_seas_temp_importance, gain_raw_min_importance, gain_raw_max_importance, gain_raw_seas_importance, gain_change_min_importance, gain_change_max_importance, gain_change_seas_importance, gain_abs_change_min_importance, gain_abs_change_max_importance, gain_abs_change_seas_importance)

RVI_gain <- data.table(gain_loss, type, variable, value)
```

Table for RVI data for loss
```{r put RVIs for loss into data table}
gain_loss <- c("loss","loss","loss","loss","loss", "loss","loss", "loss", "loss","loss","loss","loss","loss","loss", "loss","loss", "loss", "loss","loss")
type <- c("Depth", "Depth", "lag", "lag", "Transformation", "Transformation", "Transformation", "Metric", "Metric", "Metric", "Transformation x Metric", "Transformation x Metric", "Transformation x Metric", "Transformation x Metric", "Transformation x Metric", "Transformation x Metric", "Transformation x Metric", "Transformation x Metric", "Transformation x Metric")
variable <- c("Bottom", "Surface", "no_lag", "lagged", "|Change|", "Change", "Raw", "Min", "Max", "Seas", "Raw x Min", "Raw x Max", "Raw x Seas", "Change x Min", "Change x Max", "Change x Seas", "|Change| x Min", "|Change| x Max", "|Change| x Seas")
value <- c(loss_bottom_importance, loss_surface_importance, loss_nolag_importance, loss_lag_importance, loss_abs_importance, loss_change_importance, loss_raw_importance, loss_min_temp_importance, loss_max_temp_importance, loss_seas_temp_importance, loss_raw_min_importance, loss_raw_max_importance, loss_raw_seas_importance, loss_change_min_importance, loss_change_max_importance, loss_change_seas_importance, loss_abs_change_min_importance, loss_abs_change_max_importance, loss_abs_change_seas_importance)

RVI_loss <- data.table(gain_loss, type, variable, value)
```

Merge RVI tables for gain and loss, and then graph
```{r merge RVI tables and plot}
RVI_table <- as.data.table(rbind(RVI_gain, RVI_loss)) #bind RVI for gains and losss

RVI_table.r <- RVI_table[!grep("Surface", variable)][!grep("lagged", variable)]

#change order of factor levels
RVI_table.r[, variable := factor(variable, levels = c("Bottom", "no_lag", "Raw", "Change", "|Change|", "Min", "Max", "Seas"))]

saveRDS(RVI_table, file = here("Model_results", "RVI_table.rds"))

ggplot(data = RVI_table.r, aes(x=variable, y = value, fill = gain_loss)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_x_discrete(breaks = c("Bottom", "no_lag", "Raw", "Change", "|Change|", "Min", "Max", "Seas"), 
                   labels = c("Bottom Temp", "No Lag", "Raw Temp", "Change in \nTemp", "| Change in\n Temp |", "Min Temp", "Max Temp", "Seas")) +
  labs(x = "Temperature Variables", y = "Relative Variable Importance")  +
  theme_bw()

```

Another way to visualize is stacked bar plot.

```{r RVI stacked plot}
#put levels into correct order for viewing, and add dummy level for legend
RVI_gain[, variable := factor(variable, levels = c("Bottom", "Surface","  ", "Raw", "Change", "|Change|","", "no_lag", "lagged", "Min", "Max", "Seas"))]
RVI_gain[, type := factor(type, levels = c("Depth", "Transformation", "Metric", "lag"))]

RVI_gain_nolag <- RVI_gain[type != "lag",]
RVI_gain_nolag[, type := factor(type, levels = c("Depth", "Transformation", "Metric"))][, variable := factor(variable, levels = c("Bottom", "Surface","  ", "Raw", "Change", "|Change|","", "Min", "Max", "Seas"))]

saveRDS(RVI_gain_nolag, here("Model_results", "RVI_gain_nolag.rds"))

#and again for loss
RVI_loss[, variable := factor(variable, levels = c("Bottom", "Surface","  ", "Raw", "Change", "|Change|","", "no_lag", "lagged", "Min", "Max", "Seas"))]
RVI_loss[, type := factor(type, levels = c("Depth", "Transformation", "Metric", "lag"))]

RVI_loss_nolag <- RVI_loss[type != "lag",]
RVI_loss_nolag[, type := factor(type, levels = c("Depth", "Transformation", "Metric"))][, variable := factor(variable, levels = c("Bottom", "Surface","  ", "Raw", "Change", "|Change|","", "Min", "Max", "Seas"))]

saveRDS(RVI_loss_nolag, here("Model_results", "RVI_loss_nolag.rds"))


#plotting
pal <- wes_palette("GrandBudapest1", 8, type = "continuous")
colors <- c(pal[1], pal[2], "#FFFFFF", pal[3], pal[4], pal[5],"#FFFFFF", pal[6], pal[7], pal[8])

#gains
RVI_gain_plot <- ggplot(data = RVI_gain_nolag, aes(x=type, y = value, fill = variable)) +
  geom_bar(stat="identity", color = "black", size = 0, width = 0.8) +
  scale_x_discrete(breaks = c("Depth", "Transformation", "Metric"), labels = c("Depth", "Transformation", "Metric")) +
  labs(x = "Temperature Variables", y = "Relative Variable Importance") +
  theme_classic() +
  theme(text = element_text(size = 11.5), 
        legend.position = "right", 
        legend.title = element_blank(), 
        legend.spacing.x = unit(0.2, 'cm'),
        legend.justification = "center",
        aspect.ratio = (1),
        #, legend.position = "none"
        ) +
  guides(fill=guide_legend(ncol=1)) +
  scale_fill_manual(values = colors,
                    drop = F)

#loss
RVI_loss_plot <- ggplot(data = RVI_loss_nolag, aes(x=type, y = value, fill = variable)) +
  geom_bar(stat="identity", color = "black", size = 0, width = 0.8) +
  scale_x_discrete(breaks = c("Depth", "Transformation", "Metric"), labels = c("Depth", "Transformation", "Metric")) +
  labs(x = "Temperature Variables", y = "Relative Variable Importance") +
  theme_classic() +
  theme(text = element_text(size = 11.5), 
        legend.position = "right", 
        legend.title = element_blank(), 
        legend.spacing.x = unit(0.2, 'cm'),
        legend.justification = "center",
        aspect.ratio = (1),
        #, legend.position = "none"
        ) +
  guides(fill=guide_legend(ncol=1)) +
  scale_fill_manual(values = colors,
                    drop = F)

RVI_table
RVI_gain_plot
RVI_loss_plot
```
Next step is to add the coefficients on to the bar chart. To do this, I will need to sum (aikake weight of model including variable x coefficient). I think this will be easy enough Using gain_model_comparison_taxonomy data frame. I will add new column to data frame of aikaike weight x coefficient

```{r avg coefficients for gain models}
#for some reason the coefficient is a factor
gain_model_comparison_taxonomy[,coef_num := as.numeric(as.character(coef))]
gain_model_comparison_taxonomy[,aw_coef := akaike_weight * coef_num]

#bottom temperature avg coefficient
gain_bottom_temp_avg_coef <- sum(gain_model_comparison_taxonomy[grep("sbt", variable)]$coef_num)

#surface temperature avg coefficient
gain_surface_temp_avg_coef <- sum(gain_model_comparison_taxonomy[grep("sst", variable)]$coef_num)

#raw seasonality avg coefficient
gain_seas_raw_avg_coef <- 
  sum(gain_model_comparison_taxonomy[grep("seas", variable), ][!grep("change", variable)]$coef_num)

#max abs change avg coefficient
gain_max_abs_change_avg_coef <- 
  sum(gain_model_comparison_taxonomy[grep("max_s.t_temp_change_abs", variable), ]$coef_num)


```

```{r avg coefficients for loss models}
#for some reason the coefficient is a factor
loss_model_comparison_taxonomy[,coef_num := as.numeric(as.character(coef))]
loss_model_comparison_taxonomy[,aw_coef := akaike_weight * coef_num]

#bottom temperature avg coefficient
loss_bottom_temp_avg_coef <- sum(loss_model_comparison_taxonomy[grep("sbt", variable)]$coef_num)

#surface temperature avg coefficient
loss_surface_temp_avg_coef <- sum(loss_model_comparison_taxonomy[grep("sst", variable)]$coef_num)

#raw seasonality avg coefficient
loss_seas_raw_avg_coef <- 
  sum(loss_model_comparison_taxonomy[grep("seas", variable), ][!grep("change", variable)]$coef_num)

#min change avg coefficient
loss_min_abs_change_avg_coef <- 
  sum(loss_model_comparison_taxonomy[grep("min_s.t_temp_change", variable), ][!grep("abs", variable)]$coef_num)

#seas change avg coefficient
loss_seas_change_avg_coef <- 
  sum(loss_model_comparison_taxonomy[grep("seas_s.t_temp_change", variable), ][!grep("abs", variable)]$coef_num)


```


*************************
*************************
*************************
*************************
(These analyses were irrelevant and therefore not repeated for revisions)
##What if we run these models with fish only? No traits? How do inverts change the story? Because it looks like above, not a ton of invertebrates are going in and out. 

```{r fish only}
#list of fish names from trait database
traits <- fread("TraitCollectionFishNAtlanticNEPacificContShelf (3).csv")

#make fish no fish key
fish <- data.table(spp = unique(traits$taxon), fish = "Y")

#combine with spp master
spp_master_ztemp_seus_buoy_scaled_fishonly <- merge(spp_master_ztemp_seus_buoy_scaled, fish, all.x = T)

#get rid of any rows that aren't observations of fish
spp_master_ztemp_seus_buoy_scaled_fishonly2 <- spp_master_ztemp_seus_buoy_scaled_fishonly[fish == "Y",]

```

Running models for fish only

```{r gain models without traits for fish only}

#names of scaled columns
scaled_cols <- grep("*_scaled", names(spp_master_ztemp_seus_buoy_scaled_fishonly2), value = T)

#going to make loop to make all models I need to look at with single variables
variables_scaled <- colnames(spp_master_ztemp_seus_buoy_scaled_fishonly2[,scaled_cols, with = FALSE])

gain_model_comparison_spprandom_scaled_seus_update_fishonly <- as.data.table(matrix(nrow = length(variables_scaled)))
gain_model_comparison_spprandom_scaled_seus_update_fishonly[, variable:=as.factor(V1)][, coef:=as.numeric(V1)][, p_value:=as.numeric(V1)][, AICc:=as.numeric(V1)]
gain_model_comparison_spprandom_scaled_seus_update_fishonly[, V1 := NULL]

for (i in 1:length(variables_scaled)){
  mod <- glmer(gain ~ get(variables_scaled[i]) + (1|reg) + (1|spp), family = binomial, data = spp_master_ztemp_seus_buoy_scaled_fishonly2, nAGQ = 0)
  gain_model_comparison_spprandom_scaled_seus_update_fishonly[i,variable := variables_scaled[i]]
  gain_model_comparison_spprandom_scaled_seus_update_fishonly[i,coef := coef(summary(mod))[,"Estimate"][2]]
  gain_model_comparison_spprandom_scaled_seus_update_fishonly[i,p_value := coef(summary(mod))[,"Pr(>|z|)"][2]]
  gain_model_comparison_spprandom_scaled_seus_update_fishonly[i,AICc := AICc(mod)]
  
  print(paste(i, length(variables_scaled), sep = "/"))
    
}

#by setting nACQ to 0, all models converged


```

loss Models without Traits
```{r loss models without traits for fish only}
#see setup above

loss_model_comparison_spprandom_scaled_seus_update_fishonly <- as.data.table(matrix(nrow = length(variables_scaled)))
loss_model_comparison_spprandom_scaled_seus_update_fishonly[, variable:=as.factor(V1)][, coef:=as.numeric(V1)][, p_value:=as.numeric(V1)][, AICc:=as.numeric(V1)]
loss_model_comparison_spprandom_scaled_seus_update_fishonly[, V1 := NULL]

for (i in 1:length(variables_scaled)){
  mod <- glmer(loss ~ get(variables_scaled[i]) + (1|reg) + (1|spp), family = binomial, data = spp_master_ztemp_seus_buoy_scaled_fishonly2, nAGQ = 0)
  loss_model_comparison_spprandom_scaled_seus_update_fishonly[i,variable := variables_scaled[i]]
  loss_model_comparison_spprandom_scaled_seus_update_fishonly[i,coef := coef(summary(mod))[,"Estimate"][2]]
  loss_model_comparison_spprandom_scaled_seus_update_fishonly[i,p_value := coef(summary(mod))[,"Pr(>|z|)"][2]]
  loss_model_comparison_spprandom_scaled_seus_update_fishonly[i,AICc := AICc(mod)]
  
  print(paste(i, length(variables_scaled), sep = "/"))
    
}

#by setting nACQ to 0, all models converged


```

Relative Variable Importance
```{r get rid of any models using mean for fish only}
gain_model_comparison_spprandom_scaled_seus_update_fishonly_nomean <- gain_model_comparison_spprandom_scaled_seus_update_fishonly[!grepl("mean",variable),]

loss_model_comparison_spprandom_scaled_seus_update_fishonly_nomean <- loss_model_comparison_spprandom_scaled_seus_update_fishonly[!grepl("mean",variable),]

#comparison to null
col_mod_null <- glmer(gain ~ (1|reg) + (1|spp), family = binomial, data = spp_master_ztemp_seus_buoy_scaled_fishonly2, nAGQ = 0)
AICc(col_mod_null)-min(gain_model_comparison_spprandom_scaled_seus_update_fishonly_nomean$AICc)

ext_mod_null <- glmer(ext ~ (1|reg) + (1|spp), family = binomial, data = spp_master_ztemp_seus_buoy_scaled_fishonly2, nAGQ = 0)
AICc(ext_mod_null)-min(loss_model_comparison_spprandom_scaled_seus_update_fishonly_nomean$AICc)
```

Relative Variable Importance for gain Models
```{r RVI gain for fish only}
#add ∆AIC to tables
min_col_AICc_fishonly <- min(gain_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[, AICc])
gain_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[,"deltaAICc" := (AICc - min_col_AICc_fishonly)]

#add relative likelihood exp( -0.5 * ∆AIC score for that model)
gain_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[,"rel_likelihood" := exp((-0.5 * deltaAICc))]
#sum relative likelihoods across all models
gain_model_comparison_spprandom_scaled_seus_update_fishonly_nomean.likelihoodsum <- sum(gain_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[, rel_likelihood])
#Akaike weight for a model is this rel_likelihood devided by the sum of these values across all models
gain_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[,"akaike_weight" := rel_likelihood/gain_model_comparison_spprandom_scaled_seus_update_fishonly_nomean.likelihoodsum]

#I want to look at relative importance FOR 
#bottom/surface (bottom = includes sbt, grepl("sbt", variable))
col_bottom_importance_fishonly <- sum(gain_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("sbt", variable), ]$akaike_weight)
col_surface_importance_fishonly <- sum(gain_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("sst", variable), ]$akaike_weight)

#lag/not lagged (grepl("lag", variable))
col_lag_importance_fishonly <- sum(gain_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("lag", variable), ]$akaike_weight)
col_nolag_importance_fishonly <- sum(gain_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[!grep("lag", variable), ]$akaike_weight)

#absolute (grepl("abs", variable))
col_abs_importance_fishonly <- sum(gain_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("abs", variable), ]$akaike_weight)

#raw (!grepl("change"))
col_raw_importance_fishonly <- sum(gain_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[!grep("change", variable), ]$akaike_weight)

#change (grepl("change", variable), (!grepl("abs")))
col_change_importance_fishonly <- sum(gain_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("change", variable), ][!grep("abs", variable),]$akaike_weight)

#type of temp variable (max, min, seas)
col_max_temp_importance_fishonly <- sum(gain_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("max", variable), ]$akaike_weight)
col_min_temp_importance_fishonly <- sum(gain_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("min", variable), ]$akaike_weight)
col_seas_temp_importance_fishonly <- sum(gain_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("seas", variable), ]$akaike_weight)
```

Relative Variable Importance for loss Models
```{r RVI loss for fish only}
#add ∆AIC to tables
min_ext_AICc_fishonly <- min(loss_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[, AICc])
loss_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[,"deltaAICc" := (AICc - min_ext_AICc_fishonly)]

#add relative likelihood exp( -0.5 * ∆AIC score for that model)
loss_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[,"rel_likelihood" := exp((-0.5 * deltaAICc))]
#sum relative likelihoods across all models
loss_model_comparison_spprandom_scaled_seus_update_fishonly_nomean.likelihoodsum <- sum(loss_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[, rel_likelihood])
#Akaike weight for a model is this rel_likelihood devided by the sum of these values across all models
loss_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[,"akaike_weight" := rel_likelihood/loss_model_comparison_spprandom_scaled_seus_update_fishonly_nomean.likelihoodsum]

#I want to look at relative importance FOR 
#bottom/surface (bottom = includes sbt, grepl("sbt", variable))
ext_bottom_importance_fishonly <- sum(loss_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("sbt", variable), ]$akaike_weight)
ext_surface_importance_fishonly <- sum(loss_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("sst", variable), ]$akaike_weight)

#lag/not lagged (grepl("lag", variable))
ext_lag_importance_fishonly <- sum(loss_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("lag", variable), ]$akaike_weight)
ext_nolag_importance_fishonly <- sum(loss_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[!grep("lag", variable), ]$akaike_weight)

#absolute (grepl("abs", variable))
ext_abs_importance_fishonly <- sum(loss_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("abs", variable), ]$akaike_weight)

#raw (!grepl("change"))
ext_raw_importance_fishonly <- sum(loss_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[!grep("change", variable), ]$akaike_weight)

#change (grepl("change", variable), (!grepl("abs")))
ext_change_importance_fishonly <- sum(loss_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("change", variable), ][!grep("abs", variable),]$akaike_weight)

#type of temp variable (max, min, seas)
ext_max_temp_importance_fishonly <- sum(loss_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("max", variable), ]$akaike_weight)
ext_min_temp_importance_fishonly <- sum(loss_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("min", variable), ]$akaike_weight)
ext_seas_temp_importance_fishonly <- sum(loss_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("seas", variable), ]$akaike_weight)
```

Let's see how the RVI importance varies by looking at specific lag values
```{r make a plot here for variability across lag values for fish only}
#first, table for lags
lags_v_RVI_spprandom_scaled_fishonly <- data.table(col_lag = c(0:9), col_RVI = 0, loss_RVI = 0)
#gain
lags_v_RVI_spprandom_scaled_fishonly[1,2] <- 1-sum(gain_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("lag", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled_fishonly[2,2] <- sum(gain_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("lag1", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled_fishonly[3,2] <- sum(gain_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("lag2", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled_fishonly[4,2] <- sum(gain_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("lag3", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled_fishonly[5,2] <- sum(gain_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("lag4", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled_fishonly[6,2] <- sum(gain_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("lag5", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled_fishonly[7,2] <- sum(gain_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("lag6", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled_fishonly[8,2] <- sum(gain_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("lag7", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled_fishonly[9,2] <- sum(gain_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("lag8", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled_fishonly[10,2] <- sum(gain_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("lag9", variable), ]$akaike_weight)
#loss
lags_v_RVI_spprandom_scaled_fishonly[1,3] <- 1-sum(loss_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("lag", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled_fishonly[2,3] <- sum(loss_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("lag1", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled_fishonly[3,3] <- sum(loss_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("lag2", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled_fishonly[4,3] <- sum(loss_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("lag3", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled_fishonly[5,3] <- sum(loss_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("lag4", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled_fishonly[6,3] <- sum(loss_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("lag5", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled_fishonly[7,3] <- sum(loss_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("lag6", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled_fishonly[8,3] <- sum(loss_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("lag7", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled_fishonly[9,3] <- sum(loss_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("lag8", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled_fishonly[10,3] <- sum(loss_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("lag9", variable), ]$akaike_weight)

ggplot(data = lags_v_RVI_spprandom_scaled_fishonly, aes(x = col_lag)) +
  geom_line(aes(y = col_RVI), col = "blue") +
  geom_line(aes(y = loss_RVI), col = "red") +
  labs(x = "Lag", y = "Relative Variable Importance") +
  scale_color_discrete() + #how to make a legend
  theme_bw()
```

Table for RVI data for gain
```{r put RVIs for gain into data table for fish only}
col_ext <- c("col","col","col","col","col", "col","col", "col", "col","col")
type <- c("depth", "depth", "lag", "lag", "Change?", "Change?", "Change?", "Temp", "Temp", "Temp")
variable <- c("bottom", "surface", "no_lag", "lagged", "absolute_value_change", "change", "raw", "Min", "Max", "Seas")
value <- c(col_bottom_importance_fishonly, col_surface_importance_fishonly, col_nolag_importance_fishonly, col_lag_importance_fishonly, col_abs_importance_fishonly, col_change_importance_fishonly, col_raw_importance_fishonly, col_min_temp_importance_fishonly, col_max_temp_importance_fishonly, col_seas_temp_importance_fishonly)

RVI_col_fishonly <- data.table(col_ext, type, variable, value)
```

Table for RVI data for loss
```{r put RVIs for loss into data table for fish only}
col_ext <- c("ext","ext","ext","ext","ext", "ext", "ext", "ext", "ext", "ext")
type <- c("depth", "depth", "lag", "lag", "Change?", "Change?", "Change?", "Temp", "Temp", "Temp")
variable <- c("bottom", "surface", "no_lag", "lagged", "absolute_value_change", "change", "raw", "Min", "Max", "Seas")
value <- c(ext_bottom_importance_fishonly, ext_surface_importance_fishonly, ext_nolag_importance_fishonly, ext_lag_importance_fishonly, ext_abs_importance_fishonly, ext_change_importance_fishonly, ext_raw_importance_fishonly, ext_min_temp_importance_fishonly, ext_max_temp_importance_fishonly, ext_seas_temp_importance_fishonly)

RVI_ext_fishonly <- data.table(col_ext, type, variable, value)
```

Merge RVI tables for gain and loss, and then graph
```{r merge RVI tables and plot for fish only}
RVI_table_fishonly <- as.data.table(rbind(RVI_col_fishonly, RVI_ext_fishonly)) #bind RVI for gains and losss

RVI_table.r_fishonly <- RVI_table_fishonly[!grep("surface", variable)][!grep("lagged", variable)]

#change order of factor levels
RVI_table.r_fishonly[, variable := factor(variable, levels = c("bottom", "no_lag", "raw", "change", "absolute_value_change", "Min", "Max", "Seas"))]

save(RVI_table_fishonly, file = "RVI_table_fishonly.Rdata")

ggplot(data = RVI_table.r_fishonly, aes(x=variable, y = value, fill = col_ext)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_x_discrete(breaks = c("bottom", "no_lag", "raw", "change", "absolute_value_change", "Min", "Max", "Seas"), labels = c("Bottom Temp", "No Lag", "Raw Temp", "Change in \nTemp", "| Change in\n Temp |", "Min Temp", "Max Temp", "Seas")) +
  labs(x = "Temperature Variables", y = "Relative Variable Importance")  +
  theme_bw()

```

Another way to visualize is stacked bar plot.

```{r RVI stacked plot for fish only}
#put levels into correct order for viewing
RVI_table_fishonly[, variable := factor(variable, levels = c("bottom", "surface", "absolute_value_change", "change", "raw", "no_lag", "lagged", "Min", "Max", "Seas"))]
#make types factors as well
RVI_table_fishonly[,type := as.factor(type)]

#gain
RVI_col_plot_fishonly <- ggplot(data = RVI_table_fishonly[col_ext == "col",], aes(x=type, y = value, fill = variable)) +
  geom_bar(stat="identity", color = "black") +
  scale_x_discrete(breaks = c("Change?", "depth", "lag", "Temp"), labels = c("Change in\ntemp?", "Metric\nDepth", "Lagged?", "Temp")) +
  labs(x = "Temperature Variables", y = "Relative Variable Importance") +
  theme_classic() +
  theme(text = element_text(size = 22)
        #, legend.position = "none"
        )

#loss
RVI_ext_plot_fishonly <- ggplot(data = RVI_table_fishonly[col_ext == "ext",], aes(x=type, y = value, fill = variable)) +
  geom_bar(stat="identity", color = "black") +
  scale_x_discrete(breaks = c("Change?", "depth", "lag", "Temp"), labels = c("Change in\ntemp?", "Metric\nDepth", "Lagged?", "Temp")) +
  labs(x = "Temperature Variables", y = "Relative Variable Importance") +
  theme_classic()  +
  theme(text = element_text(size = 22)
        #, legend.position = "none"
        )

RVI_table_fishonly
RVI_col_plot_fishonly
RVI_ext_plot_fishonly


```
