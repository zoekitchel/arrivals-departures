---
title: "Arrival and Departure Final Models with Traits Included: EXCLUDING AI, GOA, WCTRI; NO SLEEPER"
output: html_notebook
---

This is a cleaned version of dredge_trait_models
Changes

* species and region as random effects (not year)
* scaling temperature values
* setting nACQ to 0, see why [here](https://stats.stackexchange.com/questions/77313/why-cant-i-match-glmer-family-binomial-output-with-manual-implementation-of-g). 

```{r setup}
library(MuMIn)
library(lme4)
library(data.table)
library(ggplot2)
library(plyr)

spp_master_ztemp_seus_buoy.traits_scaled <- readRDS(here::here("Data","Spp_master","spp_master_ztemp_seus_buoy.traits_scaled.rds"))

spp_master_ztemp_seus_buoy_scaled <- readRDS(here::here("Data","Spp_master","spp_master_ztemp_seus_buoy_scaled.rds"))

```

I will be looking at:

*trophic level
*maximum age
*age at maturity
*maximum body size

```{r missing values}
summary(spp_master_ztemp_seus_buoy.traits_scaled$age.max) #702 missing
summary(spp_master_ztemp_seus_buoy.traits_scaled$age.maturity) #551 missing
summary(spp_master_ztemp_seus_buoy.traits_scaled$tl) #none missing
summary(spp_master_ztemp_seus_buoy.traits_scaled$length.max) #none missing
summary(spp_master_ztemp_seus_buoy.traits_scaled$length.infinity) #443 missing, this is highly correlated (0.82) with length max, so we'll just use length.max

cor(spp_master_ztemp_seus_buoy.traits_scaled[,.(age.max_ocean_scaled, age.maturity_ocean_scaled, tl_ocean_scaled, length.max_ocean_scaled)], use = "complete.obs")

pairs(spp_master_ztemp_seus_buoy.traits_scaled[,.(age.max_ocean_scaled, age.maturity_ocean_scaled, tl_ocean_scaled, length.max_ocean_scaled)])

```

What's the distribution of trait values?
```{r unique trait values}
spp_master_ztemp_seus_buoy.traits_scaled.unique <- unique(spp_master_ztemp_seus_buoy.traits_scaled[,.(spp, reg, age.maturity_ocean, age.max_ocean, tl_ocean, length.max_ocean)])

ggplot(spp_master_ztemp_seus_buoy.traits_scaled.unique, aes(x = age.maturity_ocean))  +
  geom_histogram() +
  theme_classic()

summary(spp_master_ztemp_seus_buoy.traits_scaled.unique$age.maturity_ocean)

#what about when we leave out ai, goa, and wctri

ggplot(spp_master_ztemp_seus_buoy.traits_scaled.unique[!(reg %in% c("ai","goa","wctri"))][!(reg %in% c("ai","goa","wctri"))], aes(x = age.maturity_ocean))  +
  geom_histogram() +
  theme_classic()

summary(spp_master_ztemp_seus_buoy.traits_scaled.unique[!(reg %in% c("ai","goa","wctri"))][!(reg %in% c("ai","goa","wctri"))]$age.maturity_ocean)
```

Link up with spp key to add phylum, order, family, etc.
```{r pull in spp, order, family, etc.}
spp_key <- fread(here::here("Data","Spp_master","spp_key.csv"))

spp_master_ztemp_seus_buoy.traits_scaled <- spp_master_ztemp_seus_buoy.traits_scaled[spp_key, on = "spp"]
    
```

Prep for model runs
```{r prep for model runs}

#temp scaled vars only
#names of scaled columns
tempvars <- grep(".*temp.*scaled", names(spp_master_ztemp_seus_buoy.traits_scaled[!(reg %in% c("ai","goa","wctri"))]), value = T)

#other reference and trait columns we need
othervars_arrivals <- c("reg", "year", "col", "phylum","class","order","family","genus","spp", "age.max_ocean_scaled", "age.maturity_ocean_scaled", "tl_ocean_scaled", "length.max_ocean_scaled")

colstosaveforarrivals <- c(othervars_arrivals, tempvars)

#Arrival table
arrival.reduced_annual_obs <- spp_master_ztemp_seus_buoy.traits_scaled[,colstosaveforarrivals, with = F][!(reg %in% c("ai","goa","wctri"))] #reduces to columns we need

#Departure table

othervars_departure <- c("reg", "year", "now_ext", "phylum","class","order","family","genus","spp", "age.max_ocean_scaled", "age.maturity_ocean_scaled", "tl_ocean_scaled", "length.max_ocean_scaled")
colstosavefordeparture <- c(othervars_departure, tempvars)

departure.reduced_annual_obs <- spp_master_ztemp_seus_buoy.traits_scaled[,colstosavefordeparture, with = F][!(reg %in% c("ai","goa","wctri"))] #reduces to columns we need

spp_master_ztemp_seus_buoy.traits_scaled.6regions <- spp_master_ztemp_seus_buoy.traits_scaled[!(reg %in% c("ai","goa","wctri"))]

#save for specific figure code
saveRDS(spp_master_ztemp_seus_buoy.traits_scaled.6regions, here::here("figures","Supplemental","annual_sensitivity","spp_master_ztemp_seus_buoy.traits_scaled.6regions.rds"))


```


Making all models for arrival
```{r all models arrival}
#to assist with convergence: year as factor
arrival.reduced_annual_obs[,year := as.factor(year)]

#delete any observations without full trait data
arrival.reduced_annual_obs.r <- arrival.reduced_annual_obs[complete.cases(arrival.reduced_annual_obs[ , .(age.max_ocean_scaled, age.maturity_ocean_scaled, length.max_ocean_scaled, tl_ocean_scaled)]),]

#save for specific figure code
saveRDS(arrival.reduced_annual_obs.r,file = here::here("figures","Supplemental","annual_sensitivity","arrival.reduced_annual_obs.r.rds"))


#for now, going with two traits and one temp variable
#going to make loop to make all models I need to look at with single variables
all.temp.variables <- colnames(arrival.reduced_annual_obs.r[,14:261])
all.temp.variables.0 <- c(0, all.temp.variables) #add 0 as option so models can just include traits
all.temp.variables.0 <- all.temp.variables.0[!grepl("*mean*", all.temp.variables.0)]#get rid of MEAN temp variables
all.trait.variables <- c(0, "tl_ocean_scaled", "age.max_ocean_scaled","age.maturity_ocean_scaled", "length.max_ocean_scaled",
                         "tl_ocean_scaled + age.max_ocean_scaled", "age.max_ocean_scaled + tl_ocean_scaled",
                         "tl_ocean_scaled + age.maturity_ocean_scaled", "age.maturity_ocean_scaled + tl_ocean_scaled",
                         "tl_ocean_scaled + length.max_ocean_scaled", "length.max_ocean_scaled + tl_ocean_scaled",
                         "age.max_ocean_scaled + age.maturity_ocean_scaled", "age.maturity_ocean_scaled + age.max_ocean_scaled",
                         "age.max_ocean_scaled + length.max_ocean_scaled", "length.max_ocean_scaled + age.max_ocean_scaled",
                         "age.maturity_ocean_scaled + length.max_ocean_scaled", "length.max_ocean_scaled + age.maturity_ocean_scaled")

sign <- c("+", "*")

full_var_set <- as.data.table(expand.grid(all.temp.variables.0, sign, all.trait.variables))

#delete repeats (just temperature and both + and *)

full_var_set.r <- full_var_set[!which((Var1 == "0" & Var2 =="*")|(Var3 == "0" & Var2 == "*")),] #this excludes repeats with *

#repeated rows with traits
repeats <- c("age.maturity_ocean_scaled + age.max_ocean_scaled","tl_ocean_scaled + age.maturity_ocean_scaled", "length.max_ocean_scaled + age.maturity_ocean_scaled", "age.maturity_ocean_scaled + length.max_ocean_scaled", "tl_ocean_scaled + length.max_ocean_scaled", "tl_ocean_scaled + age.max_ocean_scaled")

#delete rows with + and same combination of 2nd and 3rd traits
full_var_set.r2 <- full_var_set.r[!which(Var2 == "+"& Var3 %in% repeats)]


#build datatable
arrival_model_comparison_traits_annual_only <- as.data.table(matrix(nrow = nrow(full_var_set.r2))) 
arrival_model_comparison_traits_annual_only[, temp_variable:=as.factor(V1)][, sign:=as.factor(V1)][, trait_variable:=as.factor(V1)][, AICc:=as.numeric(V1)][, converge:= as.logical(V1)]
arrival_model_comparison_traits_annual_only[, V1 := NULL]

for (i in 1:nrow(full_var_set.r2)){
 
  temp <- full_var_set.r2$Var1[i]
  sign <- full_var_set.r2$Var2[i]
  trait <- full_var_set.r2$Var3[i]
  
  raw_form <- ifelse(temp == 0 & trait != 0,
      paste("col ~", trait, "+ (1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp)"),
          ifelse(temp != 0 & trait == 0,
           paste("col ~", temp, "+ (1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp)"),
              ifelse(temp == 0 & trait == 0,
              paste("col ~", "+ (1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp)"),
                paste("col ~",temp,sign,trait, "+ (1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp)"))))

  formula <- as.formula(raw_form)
  
  mod <- glmer(formula, family = binomial, data = arrival.reduced_annual_obs.r, nAGQ = 0)
  
  arrival_model_comparison_traits_annual_only[i,temp_variable := full_var_set.r2$Var1[i]]
  arrival_model_comparison_traits_annual_only[i,sign := full_var_set.r2$Var2[i]]
  arrival_model_comparison_traits_annual_only[i,trait_variable := full_var_set.r2$Var3[i]]
  arrival_model_comparison_traits_annual_only[i,AICc := AICc(mod)]
  
  warning <- mod@optinfo$conv$lme4$messages[2]
  converges <- ifelse(is.null(warning) == TRUE, T, F)
  
  arrival_model_comparison_traits_annual_only[i, converge := converges]
  
  print(paste(i, nrow(arrival_model_comparison_traits_annual_only), sep = "/"))
    
}


saveRDS(arrival_model_comparison_traits_annual_only, here::here("Model_results","Traits","arrival_model_comparison_traits_annual_obs.rds"))

fwrite(arrival_model_comparison_traits_annual_only, here::here("Model_results","Traits","arrival_model_comparison_traits_annual_obs.csv"))

arrival_model_comparison_traits_annual_only <- readRDS(here::here("Model_results","Traits","arrival_model_comparison_traits_annual_obs.rds"))


```

Making all models for departure
```{r all models departure}

#for now, going with two traits and one temp variable
#going to make loop to make all models I need to look at with single variables
#don't want mean

#to assist with convergence: year as factor
departure.reduced_annual_obs[,year := as.factor(year)]

#delete any observations without full trait data
departure.reduced_annual_obs.r <- departure.reduced_annual_obs[complete.cases(departure.reduced_annual_obs[ , .(age.max_ocean_scaled, age.maturity_ocean_scaled, length.max_ocean_scaled, tl_ocean_scaled)]),]

#save for specific figure code
saveRDS(departure.reduced_annual_obs.r, file = here::here("figures","Supplemental","annual_sensitivity","departure.reduced_annual_obs.r.rds"))


departure_model_comparison_traits_annual_obs <- as.data.table(matrix(nrow = nrow(full_var_set.r2))) 
departure_model_comparison_traits_annual_obs[, temp_variable:=as.factor(V1)][, sign:=as.factor(V1)][, trait_variable:=as.factor(V1)][, AICc:=as.numeric(V1)][, converge:= as.logical(V1)]
departure_model_comparison_traits_annual_obs[, V1 := NULL]

for (i in 1:nrow(full_var_set.r2)){
 
  temp <- full_var_set.r2$Var1[i]
  sign <- full_var_set.r2$Var2[i]
  trait <- full_var_set.r2$Var3[i]
  
  raw_form <- ifelse(temp == 0 & trait != 0,
      paste("now_ext ~", trait, "+ (1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp)"),
          ifelse(temp != 0 & trait == 0,
           paste("now_ext ~", temp, "+ (1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp)"),
              ifelse(temp == 0 & trait == 0,
              paste("now_ext ~", "+ (1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp)"),
                paste("now_ext ~",temp,sign,trait, "+ (1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp)"))))

  formula <- as.formula(raw_form)
  
  mod <- glmer(formula, family = binomial, data = departure.reduced_annual_obs.r, nAGQ = 0)
  
  departure_model_comparison_traits_annual_obs[i,temp_variable := full_var_set.r2$Var1[i]]
  departure_model_comparison_traits_annual_obs[i,sign := full_var_set.r2$Var2[i]]
  departure_model_comparison_traits_annual_obs[i,trait_variable := full_var_set.r2$Var3[i]]
  departure_model_comparison_traits_annual_obs[i,AICc := AICc(mod)]
  
  warning <- mod@optinfo$conv$lme4$messages[2]
  converges <- ifelse(is.null(warning) == TRUE, T, F)
  
  departure_model_comparison_traits_annual_obs[i, converge := converges]
  
  print(paste(i, nrow(departure_model_comparison_traits_annual_obs), sep = "/"))
    
}


saveRDS(departure_model_comparison_traits_annual_obs, here::here("Model_results","Traits","departure_model_comparison_traits_annual_obs.rds"))

fwrite(departure_model_comparison_traits_annual_obs, here::here("Model_results","Traits","departure_model_comparison_traits_annual_obs.csv"))


departure_model_comparison_traits_annual_only <- readRDS(here::here("Model_results","Traits","departure_model_comparison_traits_annual_obs.rds"))

```

Next step is to look at RVI (relative variable importance)

RVI for Temperature Trait Arrival Models

```{r RVI arrival traits}
#only raw temp has lag of 10 years, which means variable importance comparisons are unbalanced so I will get rid of these rows
arrival_model_comparisons_traits.lag9max_annual_obs <- arrival_model_comparison_traits_annual_only[!grepl("lag10", temp_variable), ]

#add ∆AIC to tables
min_arrival_AICc_trait <- min(arrival_model_comparisons_traits.lag9max_annual_obs[, AICc])
arrival_model_comparisons_traits.lag9max_annual_obs[,"deltaAICc" := (AICc - min_arrival_AICc_trait)]

#add relative likelihood exp( -0.5 * ∆AIC score for that model)
arrival_model_comparisons_traits.lag9max_annual_obs[,"rel_likelihood" := exp((-0.5 * deltaAICc))]
#sum relative likelihoods across all models
arrival_model_comparisons_traits.lag9max_annual_obs.likelihoodsum <- sum(arrival_model_comparisons_traits.lag9max_annual_obs[, rel_likelihood])
#Akaike weight for a model is this rel_likelihood devided by the sum of these values across all models
arrival_model_comparisons_traits.lag9max_annual_obs[,"akaike_weight" := rel_likelihood/arrival_model_comparisons_traits.lag9max_annual_obs.likelihoodsum]

#I want to look at relative importance FOR 
#bottom/surface (bottom = includes sbt, grepl("sbt", variable))
arrival_bottom_importance <- sum(arrival_model_comparisons_traits.lag9max_annual_obs[grep("sbt", temp_variable), ]$akaike_weight)
arrival_surface_importance <- sum(arrival_model_comparisons_traits.lag9max_annual_obs[grep("sst", temp_variable), ]$akaike_weight)
  arrival_bottom_importance.n <- count(arrival_model_comparisons_traits.lag9max_annual_obs[grepl("sbt", temp_variable), ]) #3060
  arrival_surface_importance.n <- count(arrival_model_comparisons_traits.lag9max_annual_obs[grepl("sst", temp_variable), ]) #3060

#lag\not lagged (grepl("lag", variable))
arrival_lag_importance <- sum(arrival_model_comparisons_traits.lag9max_annual_obs[grep("lag", temp_variable), ]$akaike_weight)
arrival_nolag_importance <- sum(arrival_model_comparisons_traits.lag9max_annual_obs[!grep("lag", temp_variable), ]$akaike_weight)
  arrival_lag_importance.n <- count(arrival_model_comparisons_traits.lag9max_annual_obs[grepl("lag", temp_variable), ]) #5508 models include a lag
  arrival_nolag_importance.n <- count(arrival_model_comparisons_traits.lag9max_annual_obs[!grepl("lag", temp_variable), ]) #646 don't include a lag (no lag OR trait only)


  #34 models have NO temp variable
  
  
#absolute (grepl("abs", variable))
arrival_abs_importance <- sum(arrival_model_comparisons_traits.lag9max_annual_obs[grep("abs", temp_variable), ]$akaike_weight)
  arrival_abs_importance.n <- count(arrival_model_comparisons_traits.lag9max_annual_obs[grepl("abs", temp_variable), ])#2040
  
#raw (!grepl("change"))
arrival_raw_importance <- sum(arrival_model_comparisons_traits.lag9max_annual_obs[!grep("change", temp_variable), ][temp_variable != 0,]$akaike_weight)
  arrival_raw_importance.n <- count(arrival_model_comparisons_traits.lag9max_annual_obs[!grepl("change", temp_variable), ][temp_variable != 0]) #2040

#change (grepl("change", temp_variable), (!grepl("abs")))
arrival_change_importance <- sum(arrival_model_comparisons_traits.lag9max_annual_obs[grep("change", temp_variable), ][!grep("abs", temp_variable),]$akaike_weight)
  arrival_change_importance.n <- count(arrival_model_comparisons_traits.lag9max_annual_obs[grep("change", temp_variable), ][!grep("abs", temp_variable),])#2040


#type of temp temp_variable (max, min, seas)
arrival_max_temp_importance <- sum(arrival_model_comparisons_traits.lag9max_annual_obs[grep("max", temp_variable), ]$akaike_weight)
arrival_min_temp_importance <- sum(arrival_model_comparisons_traits.lag9max_annual_obs[grep("min", temp_variable), ]$akaike_weight)
arrival_seas_temp_importance <- sum(arrival_model_comparisons_traits.lag9max_annual_obs[grep("seas", temp_variable), ]$akaike_weight)
  arrival_max_temp_importance.n <- count(arrival_model_comparisons_traits.lag9max_annual_obs[grepl("max", temp_variable), ]) #2040
  arrival_min_temp_importance.n <- count(arrival_model_comparisons_traits.lag9max_annual_obs[grepl("min", temp_variable), ]) #2040
  arrival_seas_temp_importance.n <- count(arrival_model_comparisons_traits.lag9max_annual_obs[grepl("seas", temp_variable), ]) #2040
  

#traits included
arrival_age.max_importance <- sum(arrival_model_comparisons_traits.lag9max_annual_obs[grep("age.max", trait_variable), ]$akaike_weight)
arrival_age.maturity_importance <- sum(arrival_model_comparisons_traits.lag9max_annual_obs[grep("age.maturity", trait_variable), ]$akaike_weight)
arrival_tl_importance <- sum(arrival_model_comparisons_traits.lag9max_annual_obs[grep("tl", trait_variable), ]$akaike_weight)
arrival_length.max_importance <- sum(arrival_model_comparisons_traits.lag9max_annual_obs[grep("length", trait_variable),]$akaike_weight)
  arrival_age.max_importance.n <- count(arrival_model_comparisons_traits.lag9max_annual_obs[grepl("age.max", trait_variable), ]) #2534
  arrival_age.maturity_importance.n <- count(arrival_model_comparisons_traits.lag9max_annual_obs[grepl("age.maturity", trait_variable), ]) #2534
  arrival_tl_importance.n <- count(arrival_model_comparisons_traits.lag9max_annual_obs[grepl("tl", trait_variable), ]) #2534
  arrival_length.max_importance.n <- count(arrival_model_comparisons_traits.lag9max_annual_obs[grepl("length", trait_variable),]) #2534


#interaction between trait and temperature
arrival_interaction_temp_trait_importance <- sum(arrival_model_comparisons_traits.lag9max_annual_obs[grep("\\*", sign), ]$akaike_weight)
  arrival_interaction_temp_trait_importance.n <- count(arrival_model_comparisons_traits.lag9max_annual_obs[grepl("\\*", sign), ]) #3077


#save this table
saveRDS(arrival_model_comparisons_traits.lag9max_annual_obs,file = here::here( "Model_results/Traits/arrival_model_comparison_traits_annual_obs.rds"))

```

```{r put RVIs for arrival into data table}
arrival_departure <- c("arrival","arrival","arrival","arrival","arrival", "arrival","arrival", "arrival", "arrival","arrival", "arrival","arrival", "arrival", "arrival","arrival")
type <- c("depth", "depth", "lag", "lag", "Change?", "Change?", "Change?", "Temp", "Temp", "Temp", "Trait", "Trait", "Trait","Trait", "Interaction")
variable <- c("bottom", "surface", "no_lag", "lagged", "absolute_value_change", "change", "raw", "Min", "Max", "Seas", "age.max", "age.maturity", "tl", "length.max", "tempxtrait")
value <- c(arrival_bottom_importance, arrival_surface_importance, arrival_nolag_importance, arrival_lag_importance, arrival_abs_importance, arrival_change_importance, arrival_raw_importance, arrival_min_temp_importance, arrival_max_temp_importance, arrival_seas_temp_importance, arrival_age.max_importance, arrival_age.maturity_importance, arrival_tl_importance, arrival_length.max_importance, arrival_interaction_temp_trait_importance)

RVI_arrival_traits <- data.table(arrival_departure, type, variable, value)
```


Departure

```{r RVI departure traits}
#only raw temp has lag of 10 years, which means variable importance comparisons are unbalanced so I will get rid of these rows
departure_model_comparisons_traits.lag9max <- departure_model_comparison_traits_annual_only[!grepl("lag10", temp_variable), ]


#add ∆AIC to tables
min_departure_AICc_trait <- min(departure_model_comparisons_traits.lag9max[, AICc])
departure_model_comparisons_traits.lag9max[,"deltaAICc" := (AICc - min_departure_AICc_trait)]

#add relative likelihood exp( -0.5 * ∆AIC score for that model)
departure_model_comparisons_traits.lag9max[,"rel_likelihood" := exp((-0.5 * deltaAICc))]
#sum relative likelihoods across all models
departure_model_comparisons_traits.lag9max.likelihoodsum <- sum(departure_model_comparisons_traits.lag9max[, rel_likelihood])
#Akaike weight for a model is this rel_likelihood devided by the sum of these values across all models
departure_model_comparisons_traits.lag9max[,"akaike_weight" := rel_likelihood/departure_model_comparisons_traits.lag9max.likelihoodsum]

#I want to look at relative importance FOR 
#bottom/surface (bottom = includes sbt, grepl("sbt", variable))
departure_bottom_importance <- sum(departure_model_comparisons_traits.lag9max[grep("sbt", temp_variable), ]$akaike_weight)
  departure_bottom_importance.n <- count(departure_model_comparisons_traits.lag9max[grepl("sbt", temp_variable), ]) #3060
departure_surface_importance <- sum(departure_model_comparisons_traits.lag9max[grep("sst", temp_variable), ]$akaike_weight)
  departure_surface_importance.n <- count(departure_model_comparisons_traits.lag9max[grepl("sst", temp_variable), ]) #3060
  
#lag\not lagged (grepl("lag", variable))
departure_lag_importance <- sum(departure_model_comparisons_traits.lag9max[grep("lag", temp_variable), ]$akaike_weight)
  departure_lag_importance.n <- count(departure_model_comparisons_traits.lag9max[grepl("lag", temp_variable),]) #5508
departure_nolag_importance <- sum(departure_model_comparisons_traits.lag9max[!grep("lag", temp_variable), ]$akaike_weight)
  departure_nolag_importance.n <- count(departure_model_comparisons_traits.lag9max[!grepl("lag", temp_variable), ]) #646

  #absolute (grepl("abs", variable))
departure_abs_importance <- sum(departure_model_comparisons_traits.lag9max[grep("abs", temp_variable), ]$akaike_weight)
  departure_abs_importance.n <- count(departure_model_comparisons_traits.lag9max[grepl("abs", temp_variable), ]) #2040

  #raw (!grepl("change"))
departure_raw_importance <- sum(departure_model_comparisons_traits.lag9max[!grep("change", temp_variable), ][temp_variable != 0,]$akaike_weight)
  departure_raw_importance.n <- count(departure_model_comparisons_traits.lag9max[!grepl("change", temp_variable), ][temp_variable != 0,]) #2040

#change (grepl("change", temp_variable), (!grepl("abs")))
departure_change_importance <- sum(departure_model_comparisons_traits.lag9max[grep("change", temp_variable), ][!grep("abs", temp_variable),]$akaike_weight)
  departure_change_importance.n <- count(departure_model_comparisons_traits.lag9max[grepl("change", temp_variable), ][!grepl("abs", temp_variable),])#2040

#type of temp temp_variable (max, min, seas)
departure_max_temp_importance <- sum(departure_model_comparisons_traits.lag9max[grep("max", temp_variable), ]$akaike_weight)
  departure_max_temp_importance.n <- count(departure_model_comparisons_traits.lag9max[grepl("max", temp_variable), ]) #2040
departure_min_temp_importance <- sum(departure_model_comparisons_traits.lag9max[grep("min", temp_variable), ]$akaike_weight)
  departure_min_temp_importance.n <- count(departure_model_comparisons_traits.lag9max[grepl("min", temp_variable), ]) #2040
departure_seas_temp_importance <- sum(departure_model_comparisons_traits.lag9max[grep("seas", temp_variable), ]$akaike_weight)
  departure_seas_temp_importance.n <- count(departure_model_comparisons_traits.lag9max[grepl("seas", temp_variable), ]) #2040

#traits included
departure_age.max_importance <- sum(departure_model_comparisons_traits.lag9max[grep("age.max", trait_variable), ]$akaike_weight)
departure_age.maturity_importance <- sum(departure_model_comparisons_traits.lag9max[grep("age.maturity", trait_variable), ]$akaike_weight)
departure_tl_importance <- sum(departure_model_comparisons_traits.lag9max[grep("tl", trait_variable), ]$akaike_weight)
departure_length.max_importance <- sum(departure_model_comparisons_traits.lag9max[grep("length", trait_variable),]$akaike_weight)

  departure_age.max_importance.n <- count(departure_model_comparisons_traits.lag9max[grepl("age.max", trait_variable), ]) #2534
  departure_age.maturity_importance.n <- count(departure_model_comparisons_traits.lag9max[grepl("age.maturity", trait_variable), ]) #2534
  departure_tl_importance.n <- count(departure_model_comparisons_traits.lag9max[grepl("tl", trait_variable), ]) #2534
  departure_length.max_importance.n <- count(departure_model_comparisons_traits.lag9max[grepl("length", trait_variable),]) #2534

#interaction between trait and temperature
departure_interaction_temp_trait_importance <- sum(departure_model_comparisons_traits.lag9max[grep("\\*", sign), ]$akaike_weight)
  departure_interaction_temp_trait_importance.n <- count(departure_model_comparisons_traits.lag9max[grepl("\\*", sign), ]) #3077


#save this table
saveRDS(departure_model_comparisons_traits.lag9max, here::here( "Model_results/Traits/departure_model_comparison_traits_annual_obs.rds"))
```

```{r put RVIs for extinction into data table}
arrival_departure <- c("departure","departure","departure","departure","departure", "departure","departure", "departure", "departure","departure", "departure","departure", "departure", "departure","departure")
type <- c("depth", "depth", "lag", "lag", "Change?", "Change?", "Change?", "Temp", "Temp", "Temp", "Trait", "Trait", "Trait","Trait", "Interaction")
variable <- c("bottom", "surface", "no_lag", "lagged", "absolute_value_change", "change", "raw", "Min", "Max", "Seas", "age.max", "age.maturity", "tl", "length.max", "tempxtrait")
value <- c(departure_bottom_importance, departure_surface_importance, departure_nolag_importance, departure_lag_importance, departure_abs_importance, departure_change_importance, departure_raw_importance, departure_min_temp_importance, departure_max_temp_importance, departure_seas_temp_importance, departure_age.max_importance, departure_age.maturity_importance, departure_tl_importance, departure_length.max_importance, departure_interaction_temp_trait_importance)

RVI_departure_traits <- data.table(arrival_departure, type, variable, value)
```

Merge RVI tables for colonization and extinction with traits, and then graph
```{r merge RVI trait tables and plot}
RVI_trait_table <- as.data.table(rbind(RVI_arrival_traits, RVI_departure_traits)) #bind RVI for colonizations and extinctions

RVI_trait_table.r <- RVI_trait_table[!grep("surface", variable)][!grep("lagged", variable)]

#change order of factor levels
RVI_trait_table.r[, variable := factor(variable, levels = c("bottom", "no_lag", "raw", "change", "absolute_value_change", "Min", "Max", "Seas", "age.max", "age.maturity", "tl", "length.max", "tempxtrait"))]

save(RVI_trait_table, file = "RVI_trait_table_annual_obs.Rdata")

ggplot(data = RVI_trait_table.r, aes(x=variable, y = value, fill = arrival_departure)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_x_discrete(breaks = c("bottom", "no_lag", "raw", "change", "absolute_value_change", "Min", "Max", "Seas", "age.max", "age.maturity", "tl", "length.max", "tempxtrait"), labels = c("Bottom\nTemp", "No\nLag", "Raw\nTemp", "Change in \nTemp", "| Change in\n Temp |", "Min\nTemp", "Max\nTemp", "Seas", "Age\nMax", "Age\nMaturity", "Trophic\nLevel", "Max\nLength" , "Temp*\nTrait")) +
  labs(x = "Temperature and Trait Variables", y = "Relative Variable Importance")  +
  theme_bw()

```

Another way to visualize
```{r visualizing RVI with traits}
#put levels into correct order for viewing
RVI_trait_table[
  , variable := factor(variable, levels = c("bottom", "surface", "absolute_value_change", "change", "raw", "no_lag", "lagged", "Min", "Max", "Seas", "age.max", "age.maturity", "tl","length.max", "tempxtrait"))][
    ,type := factor(type, levels = c("Change?", "depth", "lag", "Temp", "Trait", "Interaction"))]
#make types factors as well

#colonization
RVI_arrival_trait_plot <- ggplot(data = RVI_trait_table[arrival_departure == "arrival" & (type == "Trait" | type == "Interaction")], aes(x=variable, y = value)) +
  geom_bar(stat= "identity") +
  scale_x_discrete(breaks = c("age.max", "age.maturity", "tl", "length.max", "tempxtrait"), labels = c("Maximum\nAge", "Age of\nMaturity", "Trophic\nLevel","Max\nLength", "Temp Trait\nInteraction")) +
  labs(x = "Trait Variables", y = "Relative Variable Importance") +
  theme_classic() +
  theme(text = element_text(size = 20))
#departure
RVI_departure_trait_plot <- ggplot(data = RVI_trait_table[arrival_departure == "departure" & (type == "Trait" | type == "Interaction")], aes(x=variable, y = value)) +
  geom_bar(stat= "identity") +
  scale_x_discrete(breaks = c("age.max", "age.maturity", "tl","length.max",  "tempxtrait"), labels = c("Maximum\nAge", "Age of\nMaturity", "Trophic\nLevel","Max\nLength", "Temp Trait\nInteraction")) +
  labs(x = "Trait Variables", y = "Relative Variable Importance") +
  theme_classic() +
  theme(text = element_text(size = 20))

RVI_arrival_trait_plot
RVI_departure_trait_plot

save(RVI_trait_table, file = "RVI_trait_table_annual_obs.Rdata")
```

Let's see how the RVI importance varies by looking at specific lag values for these trait models
```{r make a plot here for variability across lag values for trait models}
#first, table for lags
lags_v_RVI_trait <- data.table(arrival_lag = c(0:9), arrival_RVI = 0, departure_RVI = 0)
#arrival
lags_v_RVI_trait[1,2] <- 1-sum(arrival_model_comparisons_traits.lag9max_annual_obs[grep("lag", temp_variable), ]$akaike_weight)
lags_v_RVI_trait[2,2] <- sum(arrival_model_comparisons_traits.lag9max_annual_obs[grep("lag1", temp_variable), ]$akaike_weight)
lags_v_RVI_trait[3,2] <- sum(arrival_model_comparisons_traits.lag9max_annual_obs[grep("lag2", temp_variable), ]$akaike_weight)
lags_v_RVI_trait[4,2] <- sum(arrival_model_comparisons_traits.lag9max_annual_obs[grep("lag3", temp_variable), ]$akaike_weight)
lags_v_RVI_trait[5,2] <- sum(arrival_model_comparisons_traits.lag9max_annual_obs[grep("lag4", temp_variable), ]$akaike_weight)
lags_v_RVI_trait[6,2] <- sum(arrival_model_comparisons_traits.lag9max_annual_obs[grep("lag5", temp_variable), ]$akaike_weight)
lags_v_RVI_trait[7,2] <- sum(arrival_model_comparisons_traits.lag9max_annual_obs[grep("lag6", temp_variable), ]$akaike_weight)
lags_v_RVI_trait[8,2] <- sum(arrival_model_comparisons_traits.lag9max_annual_obs[grep("lag7", temp_variable), ]$akaike_weight)
lags_v_RVI_trait[9,2] <- sum(arrival_model_comparisons_traits.lag9max_annual_obs[grep("lag8", temp_variable), ]$akaike_weight)
lags_v_RVI_trait[10,2] <- sum(arrival_model_comparisons_traits.lag9max_annual_obs[grep("lag9", temp_variable), ]$akaike_weight)
#departure
lags_v_RVI_trait[1,3] <- 1-sum(departure_model_comparisons_traits.lag9max[grep("lag", temp_variable), ]$akaike_weight)
lags_v_RVI_trait[2,3] <- sum(departure_model_comparisons_traits.lag9max[grep("lag1", temp_variable), ]$akaike_weight)
lags_v_RVI_trait[3,3] <- sum(departure_model_comparisons_traits.lag9max[grep("lag2", temp_variable), ]$akaike_weight)
lags_v_RVI_trait[4,3] <- sum(departure_model_comparisons_traits.lag9max[grep("lag3", temp_variable), ]$akaike_weight)
lags_v_RVI_trait[5,3] <- sum(departure_model_comparisons_traits.lag9max[grep("lag4", temp_variable), ]$akaike_weight)
lags_v_RVI_trait[6,3] <- sum(departure_model_comparisons_traits.lag9max[grep("lag5", temp_variable), ]$akaike_weight)
lags_v_RVI_trait[7,3] <- sum(departure_model_comparisons_traits.lag9max[grep("lag6", temp_variable), ]$akaike_weight)
lags_v_RVI_trait[8,3] <- sum(departure_model_comparisons_traits.lag9max[grep("lag7", temp_variable), ]$akaike_weight)
lags_v_RVI_trait[9,3] <- sum(departure_model_comparisons_traits.lag9max[grep("lag8", temp_variable), ]$akaike_weight)
lags_v_RVI_trait[10,3] <- sum(departure_model_comparisons_traits.lag9max[grep("lag9", temp_variable), ]$akaike_weight)

RVI_lags_traits <- ggplot(data = lags_v_RVI_trait, aes(x = arrival_lag)) +
  geom_line(aes(y = arrival_RVI)) +
  geom_line(aes(y = departure_RVI), linetype = "dashed") +
  labs(x = "Lag (years)", y = "Relative Variable Importance") +
  theme_classic() +
  theme(text = element_text(size = 22, color = "black")) +
  scale_x_continuous(breaks = 0:10) +
  scale_y_continuous(limits = 0:1)

save(RVI_arrival_trait_plot, RVI_departure_trait_plot, RVI_lags_traits, file = "RVI_plots_traits_annual_obs.Rdata")

setEPS()
postscript("RVI_arrival_trait_plot_annual_obs.eps")
RVI_arrival_trait_plot
dev.off()

setEPS()
postscript("RVI_departure_trait_plot_annual_obs.eps")
RVI_departure_trait_plot
dev.off()

setEPS()
postscript("RVI_lags_trait_plot_annual_obs.eps")
RVI_lags_traits
dev.off()
```

Comparisons of coefficients of top models

Top arrival models

```{r top arrival models}

arrival.reduced_annual_obs.r <- readRDS(file = here::here("figures","Supplemental","annual_sensitivity","arrival.reduced_annual_obs.r.rds"))


mod1_arrival <- glmer(col ~ max_sst_temp_change_abs_lag1_scaled * age.max_ocean_scaled + (1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp), family = "binomial", data = arrival.reduced_annual_obs.r, nAGQ = 0)

mod2_arrival <- glmer(col ~ max_sst_temp_change_abs_lag1_scaled * age.max_ocean_scaled + tl_ocean_scaled + (1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp), family = "binomial", data = arrival.reduced_annual_obs.r, nAGQ = 0)

mod3_arrival <- glmer(col ~ max_sst_temp_change_abs_lag1_scaled * age.max_ocean_scaled + age.maturity_ocean_scaled + (1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp), family = "binomial", data = arrival.reduced_annual_obs.r, nAGQ = 0)

mod4_arrival <- glmer(col ~ max_sst_temp_change_abs_lag1_scaled * age.max_ocean_scaled + length.max_ocean_scaled + (1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp), family = "binomial", data = arrival.reduced_annual_obs.r, nAGQ = 0)

mod_traitonly_arrival <- glmer(col ~ age.max_ocean_scaled + (1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp), family = "binomial", data = arrival.reduced_annual_obs.r, nAGQ = 0)

mod_temponly_arrival <- glmer(col ~ max_sst_temp_change_abs_lag1_scaled + (1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp), family = "binomial", data = arrival.reduced_annual_obs.r, nAGQ = 0)

mod_null_arrival <- glmer(col ~ (1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp), family = "binomial", data = arrival.reduced_annual_obs.r, nAGQ = 0)


summary(mod1_arrival)[[10]]
r.squaredGLMM(mod1_arrival)
summary(mod2_arrival)[[10]]
r.squaredGLMM(mod2_arrival)
summary(mod3_arrival)[[10]]
r.squaredGLMM(mod3_arrival)
summary(mod4_arrival)[[10]]
r.squaredGLMM(mod4_arrival)

summary(mod_traitonly_arrival)[[10]]
r.squaredGLMM(mod_traitonly_arrival)
summary(mod_temponly_arrival)[[10]]
r.squaredGLMM(mod_temponly_arrival)
summary(mod_null_arrival)[[10]]
r.squaredGLMM(mod_null_arrival)

AICc(mod1_arrival)-AICc(mod1_arrival)
AICc(mod2_arrival)-AICc(mod1_arrival)
AICc(mod3_arrival)-AICc(mod1_arrival)
AICc(mod4_arrival)-AICc(mod1_arrival)

AICc(mod_traitonly_arrival)-AICc(mod1_arrival) #18.46734
AICc(mod_temponly_arrival)-AICc(mod1_arrival) #8.211203
AICc(mod_null_arrival)-AICc(mod1_arrival) #24.025178


```
Top departure models
```{r top departure models}

departure.reduced_annual_obs.r <- readRDS(file = here::here("figures","Supplemental","annual_sensitivity","departure.reduced_annual_obs.r.rds"))

mod1_departure <- glmer(now_ext ~ 	
max_sst_temp_lag1_scaled * age.max_ocean_scaled+ (1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp), family = "binomial", data = departure.reduced_annual_obs.r, nAGQ = 0)

mod2_departure <- glmer(now_ext ~ max_sst_temp_scaled * age.max_ocean_scaled+ (1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp), family = "binomial", data = departure.reduced_annual_obs.r, nAGQ = 0)

mod3_departure <- glmer(now_ext ~ max_sst_temp_lag1_scaled * age.max_ocean_scaled + age.maturity_ocean_scaled+ (1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp), family = "binomial", data = departure.reduced_annual_obs.r, nAGQ = 0)

mod4_departure <- glmer(now_ext ~ max_sst_temp_lag1_scaled * age.max_ocean_scaled + tl_ocean_scaled+ (1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp), family = "binomial", data = departure.reduced_annual_obs.r, nAGQ = 0)

mod5_departure <- glmer(now_ext ~ max_sst_temp_lag1_scaled * age.max_ocean_scaled + length.max_ocean_scaled + (1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp), family = "binomial", data = departure.reduced_annual_obs.r, nAGQ = 0)

mod6_departure <- glmer(now_ext ~ max_sst_temp_scaled * age.max_ocean_scaled + age.maturity_ocean_scaled+ (1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp), family = "binomial", data = departure.reduced_annual_obs.r, nAGQ = 0)

mod_traitonly_departure <- glmer(now_ext ~ age.max_ocean_scaled + (1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp), family = "binomial", data = departure.reduced_annual_obs.r, nAGQ = 0)

mod_temponly_departure <- glmer(now_ext ~ max_sst_temp_scaled + (1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp), family = "binomial", data = departure.reduced_annual_obs.r, nAGQ = 0)

mod_null_departure <- glmer(now_ext ~ (1|reg) + (1|spp), family = "binomial", data = departure.reduced_annual_obs.r, nAGQ = 0)


summary(mod1_departure)[[10]]
r.squaredGLMM(mod1_departure)[4]
summary(mod2_departure)[[10]]
r.squaredGLMM(mod2_departure)[4]
summary(mod3_departure)[[10]]
r.squaredGLMM(mod3_departure)[4]
summary(mod4_departure)[[10]]
r.squaredGLMM(mod4_departure)[4]
summary(mod5_departure)[[10]]
r.squaredGLMM(mod5_departure)[4]
summary(mod6_departure)[[10]]
r.squaredGLMM(mod6_departure)[4]

summary(mod_traitonly_departure)[[10]]
r.squaredGLMM(mod_traitonly_departure)[4]
summary(mod_temponly_departure)[[10]]
r.squaredGLMM(mod_temponly_departure)[4]
summary(mod_null_departure)[[10]]
r.squaredGLMM(mod_null_departure)[4]

AICc(mod1_departure)-AICc(mod1_departure)
AICc(mod2_departure)-AICc(mod1_departure)
AICc(mod3_departure)-AICc(mod1_departure)
AICc(mod4_departure)-AICc(mod1_departure)
AICc(mod5_departure)-AICc(mod1_departure)
AICc(mod6_departure)-AICc(mod1_departure)

AICc(mod_traitonly_departure)-AICc(mod1_departure) 
AICc(mod_temponly_departure)-AICc(mod1_departure) 
AICc(mod_null_departure)-AICc(mod1_departure) 


```

What do interactions look like?

##arrival with Traits
Best model: max_sst_temp_change_abs_lag1_scaled * age.max_ocean_scaled


```{r predicted values arrival}
library(ggfortify)
library(wesanderson)
pal <- c("#F9BC77","#AD6D51","#7E7976","#62B3BE","#174A4A")

#best model with fish only 
mod_arrival_trait <- glmer(col ~ max_sst_temp_change_abs_lag1_scaled * age.max_ocean_scaled + (1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp), family = "binomial", data = arrival.reduced_annual_obs.r, nAGQ = 0)

#temp only arrival trait model seas_sst_temp_scaled
mod_arrival_trait_notraits <- glmer(col ~ max_sst_temp_change_abs_lag1_scaled + (1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp), family = "binomial", data = arrival.reduced_annual_obs.r, nAGQ = 0)
summary(mod_arrival_trait_notraits)

#trait only arrival trait model
mod_arrival_trait_notemp <- glmer(col ~ age.max_ocean_scaled + (1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp), family = "binomial", data = arrival.reduced_annual_obs.r, nAGQ = 0)
summary(mod_arrival_trait_notemp)

#reverse to get age max unscaled
mod_arrival_reverse_scaled_agemax <- lm(age.max_ocean ~ age.max_ocean_scaled, data = spp_master_ztemp_seus_buoy.traits_scaled.6regions)

mod_arrival_forward_scaled_agemax <- lm(age.max_ocean_scaled ~ age.max_ocean, data = spp_master_ztemp_seus_buoy.traits_scaled.6regions)


#age max age match
age_max_match <- data.table(ages_we_want = c(1, 30, 80, 100,150))
age_max_match[,age.max_ocean_scaled := ages_we_want * mod_arrival_forward_scaled_agemax$coefficients[2]+mod_arrival_forward_scaled_agemax$coefficients[1]]

#best predictor for fish only: max_sst_temp_change_abs_lag1_scaled as x axis
temp_arrival_newdata <- runif(500,min(spp_master_ztemp_seus_buoy.traits_scaled.6regions$max_sst_temp_change_abs_lag1_scaled), max(spp_master_ztemp_seus_buoy.traits_scaled.6regions$max_sst_temp_change_abs_lag1_scaled))

temp_agemax_newdata <- age_max_match[,age.max_ocean_scaled] #age.max


arrival_newdata_traits <- expand.grid("max_sst_temp_change_abs_lag1_scaled" = temp_arrival_newdata, "age.max_ocean_scaled" = temp_agemax_newdata)


preds <- predict(mod_arrival_trait, newdata = arrival_newdata_traits, re.form = NA, type = "response")
preds_predictors <- data.table(cbind(arrival_newdata_traits, preds))
preds_predictors <- preds_predictors[age_max_match, on = "age.max_ocean_scaled"]

#I want x axis to be meaningful
mod_arrival_reverse_scaledtemp <- lm(max_sst_temp_change_abs_lag1 ~ max_sst_temp_change_abs_lag1_scaled, data = spp_master_ztemp_seus_buoy.traits_scaled.6regions)


preds_predictors[,max_sst_temp_change_abs_lag1 := mod_arrival_reverse_scaledtemp$coefficients[2]*max_sst_temp_change_abs_lag1_scaled + mod_arrival_reverse_scaledtemp$coefficients[1] ]

#reverse order of ages to match
#preds_predictors$ages_we_want <- factor(preds_predictors$ages_we_want, levels=c("75", "50", "30", "10","1"))


arrival_preds <- ggplot(data = preds_predictors, aes(x = max_sst_temp_change_abs_lag1, y = preds, color = as.factor(ages_we_want))) +
  geom_line(size = 0.7) +
  labs(colour="Maximum\n Age", x = "Absolute change in maximum surface\ntemperature lagged 1 year (\u00B0C)", y = "Probability of Arrival") +
  theme_classic() +
  scale_color_manual(values = pal) +
  theme(text=element_text(size = 10))

ggsave(arrival_preds, path = here::here("figures","Supplemental","annual_sensitivity"), file = "predicted_probs_arrival_maxage_annual_obs.jpg")
ggsave(arrival_preds, path = here::here("figures","Supplemental","annual_sensitivity"), file = "predicted_probs_arrival_maxage_annual_obs.eps")


```

##departure with Traits
Best model: max_sst_temp_lag1_scaled * age.max_ocean_scaled


```{r predicted values departure}
#best model with fish only 
mod_departure_trait <- glmer(now_ext ~ max_sst_temp_lag1_scaled * age.max_ocean_scaled + (1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp), family = "binomial", data = departure.reduced_annual_obs.r, nAGQ = 0)

#reverse to agemax unscaled
mod_departure_reverse_scaled_agemax <- lm(age.max_ocean ~ age.max_ocean_scaled, data = spp_master_ztemp_seus_buoy.traits_scaled.6regions) 

mod_departure_forward_scaled_agemax <- lm(age.max_ocean_scaled ~ age.max_ocean, data = spp_master_ztemp_seus_buoy.traits_scaled.6regions)

#age max age match
age_max_match <- data.table(ages_we_want = c(1, 30, 80, 100,150))
age_max_match[,age.max_ocean_scaled := ages_we_want * mod_departure_forward_scaled_agemax$coefficients[2]+mod_departure_forward_scaled_agemax$coefficients[1]]

#max_sst_temp_lag1_scaled as x axis
temp_departure_newdata <- runif(500,min(spp_master_ztemp_seus_buoy.traits_scaled.6regions$max_sst_temp_lag1_scaled), max(spp_master_ztemp_seus_buoy.traits_scaled.6regions$max_sst_temp_lag1_scaled))

temp_agemax_newdata <- age_max_match[,age.max_ocean_scaled]


departure_newdata_traits <- expand.grid("max_sst_temp_lag1_scaled" = temp_departure_newdata, "age.max_ocean_scaled" = temp_agemax_newdata)


preds <- predict(mod_departure_trait, newdata = departure_newdata_traits, re.form = NA, type = "response")
preds_predictors <- data.table(cbind(departure_newdata_traits, preds))
preds_predictors <- preds_predictors[age_max_match, on = "age.max_ocean_scaled"]

#I want x axis to be meaningful
mod_departure_reverse_scaledtemp <- lm(max_sst_temp_lag1 ~ max_sst_temp_lag1_scaled, data = spp_master_ztemp_seus_buoy.traits_scaled.6regions)


preds_predictors[,max_sst_temp_lag1 := mod_departure_reverse_scaledtemp$coefficients[2]*max_sst_temp_lag1_scaled + mod_departure_reverse_scaledtemp$coefficients[1] ]

#reverse order of ages to match
#preds_predictors$ages_we_want <- factor(preds_predictors$ages_we_want, levels=c("25", "15", "3", "1","0.5"))



departure_preds <- ggplot(data = preds_predictors, aes(x = max_sst_temp_lag1_scaled, y = preds, color = as.factor(ages_we_want))) +
  geom_line(size = 0.7) +
  labs(colour="Maximum\n Age", x = "Maximum surface temperature\nlagged 1 year (\u00B0C)", y = "Probability of Departure") +
  theme_classic() +
  scale_color_manual(values = pal) +
  theme(text=element_text(size = 10))

ggsave(departure_preds, path = here::here("figures","Supplemental","annual_sensitivity"), file = "predicted_probs_departure_maxage_annual_obs.jpg")
ggsave(departure_preds, path = here::here("figures","Supplemental","annual_sensitivity"), file = "predicted_probs_departure_maxage_annual_obs.eps")


```

Merge marginal effects plots
```{r}
library(cowplot)
mar_effects <- plot_grid(arrival_preds,departure_preds, labels = c("a.","b."), label_size = 10)



ggsave(width = 6, height = 2.5, path = here::here("figures","Supplemental","annual_sensitivity"), file = "Figure5_margeeffect_annual_obs.jpg")
ggsave(width = 6, height = 2.5, path = here::here("figures","Supplemental","annual_sensitivity"), file = "Figure5_margeeffect_annual_obs.eps")

```

