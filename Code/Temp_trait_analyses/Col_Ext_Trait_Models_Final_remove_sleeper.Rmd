---
title: "Arrival and Departure Final Models with Traits Included: EXCLUDING SLEEPER SHARK"
output: html_notebook
---

This is a cleaned version of dredge_trait_models
Changes

* species and region as random effects (not year)
* scaling temperature values
* setting nACQ to 0, see why [here](https://stats.stackexchange.com/questions/77313/why-cant-i-match-glmmTMB-family-binomial-output-with-manual-implementation-of-g). 

```{r setup}
library(MuMIn)
library(lme4)
library(data.table)
library(ggplot2)
library(plyr)
library(glmmTMB)
library(here)
library(DHARMa)

spp_master_ztemp_seus_buoy.traits_scaled <- readRDS(here::here("Data","Spp_master","spp_master_ztemp_seus_buoy.traits_scaled.rds"))


```

I will be looking at:

*trophic level
*maximum age
*age at maturity
*maximum body size

Link up with spp key to add phylum, order, family, etc.
```{r pull in spp, order, family, etc.}
spp_key <- fread(here::here("Data","Spp_master","spp_key.csv"))

spp_master_ztemp_seus_buoy.traits_scaled <- spp_key[spp_master_ztemp_seus_buoy.traits_scaled, on = "spp", nomatch = NULL]

nrow(spp_master_ztemp_seus_buoy.traits_scaled)

#delete first year each region is sampled (because gains and losses are based on transitions between years, so we need 2 years of observations)

spp_master_ztemp_seus_buoy.traits_scaled[,min_year := min(year),reg]

#check if this looks right
unique(spp_master_ztemp_seus_buoy.traits_scaled[,.(reg, min_year)])

#delete any row where the value in the year column is equal to the value in the min_year column
#for example, for goa, min_year is 1984 so this will delete any rows where year is 1984
spp_master_ztemp_seus_buoy.traits_scaled_2 <- spp_master_ztemp_seus_buoy.traits_scaled[year != min_year,]
spp_master_ztemp_seus_buoy.traits_scaled_3 <- spp_master_ztemp_seus_buoy.traits_scaled[year == min_year,]

#takes us from 13051 to 12459 (loses 592 rows)
#regional breakdown of rows we lose (based on species)
#   ai   ebs  gmex   goa  neus  newf    sa shelf wctri 
#   36    36   104    60   112    48    77    48    71 

#nrow(spp_master_ztemp_seus_buoy.traits_scaled)

#if we feel okay, we can keep spp_master_ztemp_seus_buoy.traits_scaled_2
spp_master_ztemp_seus_buoy.traits_scaled <- spp_master_ztemp_seus_buoy.traits_scaled_2
    
```
12459

Ensure that each region only has a single trait value. 
```{r length unique spp reg combos}
nrow(unique(spp_master_ztemp_seus_buoy.traits_scaled[,.(spp, reg)]))
nrow(unique(spp_master_ztemp_seus_buoy.traits_scaled[,.(spp, reg, age.maturity_ocean, age.max_ocean, tl_ocean, length.max_ocean)]))
```

Looking at correlations among variables
```{r missing values}
summary(spp_master_ztemp_seus_buoy.traits_scaled$age.max_ocean) #702 missing
summary(spp_master_ztemp_seus_buoy.traits_scaled$age.maturity_ocean) #551 missing
summary(spp_master_ztemp_seus_buoy.traits_scaled$tl_ocean) #none missing
summary(spp_master_ztemp_seus_buoy.traits_scaled$length.max_ocean) #none missing
summary(spp_master_ztemp_seus_buoy.traits_scaled$length.infinity) #443 missing, this is highly correlated (0.82) with length max, so we'll just use length.max

cor(spp_master_ztemp_seus_buoy.traits_scaled[,.(age.max_ocean, age.maturity_ocean, tl_ocean, length.max_ocean)], use = "complete.obs")

pairs(spp_master_ztemp_seus_buoy.traits_scaled[,.(age.max_ocean, age.maturity_ocean, tl_ocean, length.max_ocean)])

```

What's the distribution of trait values?
```{r trait value distribution age maturity}
spp_master_ztemp_seus_buoy.traits_scaled.unique <- unique(spp_master_ztemp_seus_buoy.traits_scaled[,.(spp, reg, age.maturity_ocean, age.max_ocean, tl_ocean, length.max_ocean)])

ggplot(spp_master_ztemp_seus_buoy.traits_scaled.unique, aes(x = age.maturity_ocean))  +
  geom_histogram() +
  theme_classic()

#sleeper shark values?
#(mean sleeper - overall mean)/SD of overall distribution

(spp_master_ztemp_seus_buoy.traits_scaled.unique[spp == "Somniosus pacificus",]$age.maturity_ocean-mean(spp_master_ztemp_seus_buoy.traits_scaled.unique$age.maturity_ocean, na.rm = T))/sd(spp_master_ztemp_seus_buoy.traits_scaled.unique$age.maturity_ocean, na.rm = T) #17.38 SD from mean

(spp_master_ztemp_seus_buoy.traits_scaled.unique[spp == "Somniosus pacificus",]$age.max_ocean-mean(spp_master_ztemp_seus_buoy.traits_scaled.unique$age.max_ocean, na.rm = T))/sd(spp_master_ztemp_seus_buoy.traits_scaled.unique$age.max_ocean, na.rm = T) #8.88 SD from mean

(spp_master_ztemp_seus_buoy.traits_scaled.unique[spp == "Somniosus pacificus",]$length.max_ocean-mean(spp_master_ztemp_seus_buoy.traits_scaled.unique$length.max_ocean, na.rm = T))/sd(spp_master_ztemp_seus_buoy.traits_scaled.unique$length.max_ocean, na.rm = T) #11.14 SD from mean


#what about when we leave out sleeper shark

ggplot(spp_master_ztemp_seus_buoy.traits_scaled.unique[(spp != "Somniosus pacificus")], aes(x = age.maturity_ocean))  +
  geom_histogram() +
  theme_classic()

summary(spp_master_ztemp_seus_buoy.traits_scaled.unique[(spp != "Somniosus pacificus")]$age.maturity_ocean)

#marking outliers
is_outlier <- function(x, na.rm=F) {
  return(x < quantile(x, 0.25, na.rm = na.rm) - 1.5 * IQR(x, na.rm = na.rm) | x > quantile(x, 0.75,na.rm = na.rm) + 1.5 * IQR(x, na.rm = na.rm))
}

spp_master_ztemp_seus_buoy.traits_scaled.unique[,age_mat_outlier := is_outlier(age.maturity_ocean, na.rm = T)]

spp_master_ztemp_seus_buoy.traits_scaled.unique[,outlier_age_mat := ifelse(age_mat_outlier == T, spp, NA)]
library(ggrepel)
#box plot would be helpful to see outliers
ggplot(spp_master_ztemp_seus_buoy.traits_scaled.unique, aes(x = reg, y = age.maturity_ocean))  +
  geom_boxplot() +
  geom_text_repel(aes(label=outlier_age_mat), size = 1.5) +
  theme_classic()

ggsave(path = here::here("figures","Outliers"), filename = "age_maturity_outliers.jpg")
```

Age max values
```{r trait value distribution age max}

ggplot(spp_master_ztemp_seus_buoy.traits_scaled.unique, aes(x = age.max_ocean))  +
  geom_histogram() +
  theme_classic()

summary(spp_master_ztemp_seus_buoy.traits_scaled.unique$age.max_ocean)

#what about when we leave out sleeper shark

ggplot(spp_master_ztemp_seus_buoy.traits_scaled.unique[(spp != "Somniosus pacificus")], aes(x = age.max_ocean))  +
  geom_histogram() +
  theme_classic()

summary(spp_master_ztemp_seus_buoy.traits_scaled.unique[(spp != "Somniosus pacificus")]$age.max_ocean)

#marking outliers

spp_master_ztemp_seus_buoy.traits_scaled.unique[,age_max_outlier := is_outlier(age.max_ocean, na.rm = T)]

spp_master_ztemp_seus_buoy.traits_scaled.unique[,outlier_age_max := ifelse(age_max_outlier == T, spp, NA)]
library(ggrepel)
#box plot would be helpful to see outliers
ggplot(spp_master_ztemp_seus_buoy.traits_scaled.unique, aes(x = reg, y = age.max_ocean))  +
  geom_boxplot() +
  geom_text_repel(aes(label=outlier_age_max), size = 1.5) +
  theme_classic()

ggsave(path = here::here("figures","Outliers"), filename = "max_age_outliers.jpg")
```

Trophic Level values
```{r trait value distribution trophic level}

ggplot(spp_master_ztemp_seus_buoy.traits_scaled.unique, aes(x = tl_ocean))  +
  geom_histogram() +
  theme_classic()

summary(spp_master_ztemp_seus_buoy.traits_scaled.unique$tl_ocean)

#what about when we leave out sleeper shark

ggplot(spp_master_ztemp_seus_buoy.traits_scaled.unique[(spp != "Somniosus pacificus")], aes(x = tl_ocean))  +
  geom_histogram() +
  theme_classic()

summary(spp_master_ztemp_seus_buoy.traits_scaled.unique[(spp != "Somniosus pacificus")]$tl_ocean)

#marking outliers

spp_master_ztemp_seus_buoy.traits_scaled.unique[,tl_outlier := is_outlier(tl_ocean, na.rm = T)]

spp_master_ztemp_seus_buoy.traits_scaled.unique[,outlier_tl := ifelse(tl_outlier == T, spp, NA)]
library(ggrepel)
#box plot would be helpful to see outliers
ggplot(spp_master_ztemp_seus_buoy.traits_scaled.unique, aes(x = reg, y = tl_ocean))  +
  geom_boxplot() +
  geom_text_repel(aes(label=outlier_tl), size = 1.5) +
  theme_classic()

ggsave(path = here::here("figures","Outliers"), filename = "tl_outliers.jpg")
```

Maximum length values
```{r trait value distribution max length}

ggplot(spp_master_ztemp_seus_buoy.traits_scaled.unique, aes(x = length.max_ocean))  +
  geom_histogram() +
  theme_classic()

summary(spp_master_ztemp_seus_buoy.traits_scaled.unique$length.max_ocean)

#what about when we leave out sleeper shark

ggplot(spp_master_ztemp_seus_buoy.traits_scaled.unique[(spp != "Somniosus pacificus")], aes(x = length.max_ocean))  +
  geom_histogram() +
  theme_classic()

summary(spp_master_ztemp_seus_buoy.traits_scaled.unique[(spp != "Somniosus pacificus")]$length.max_ocean)

#marking outliers

spp_master_ztemp_seus_buoy.traits_scaled.unique[,length.max_outlier := is_outlier(length.max_ocean, na.rm = T)]

spp_master_ztemp_seus_buoy.traits_scaled.unique[,outlier_length.max := ifelse(length.max_outlier == T, spp, NA)]
library(ggrepel)
#box plot would be helpful to see outliers
ggplot(spp_master_ztemp_seus_buoy.traits_scaled.unique, aes(x = reg, y = length.max_ocean))  +
  geom_boxplot() +
  geom_text_repel(aes(label=outlier_length.max), size = 1.5) +
  theme_classic()

ggsave(path = here::here("figures","Outliers"), filename = "length_max_outliers.jpg")
```

Prep for model runs
```{r prep for model runs}

#temp scaled vars only
#names of scaled columns
tempvars <- grep(".*temp.*scaled", names(spp_master_ztemp_seus_buoy.traits_scaled), value = T)

#other reference and trait columns we need
othervars_arrivals <- c("reg", "year", "col", "phylum","class","order","family","genus","spp", "age.max_ocean_scaled", "age.maturity_ocean_scaled", "tl_ocean_scaled", "length.max_ocean_scaled")

colstosaveforarrivals <- c(othervars_arrivals, tempvars)

#Arrival table
arrival.reduced_nosleeper <- spp_master_ztemp_seus_buoy.traits_scaled[,colstosaveforarrivals, with = F][(spp != "Somniosus pacificus")] #reduces to columns we need, excludes sleeper shark (outlier)

#Departure table

othervars_departure <- c("reg", "year", "now_ext",  "phylum","class","order","family","genus","spp", "age.max_ocean_scaled", "age.maturity_ocean_scaled", "tl_ocean_scaled", "length.max_ocean_scaled")
colstosavefordeparture <- c(othervars_departure, tempvars)

departure.reduced_nosleeper <- spp_master_ztemp_seus_buoy.traits_scaled[,colstosavefordeparture, with = F][(spp != "Somniosus pacificus")] #reduces to columns we need, excludes sleeper shark (outlier)

spp_master_ztemp_seus_buoy.traits_scaled.nosleeper <- spp_master_ztemp_seus_buoy.traits_scaled[(spp != "Somniosus pacificus")]

#save for plotting later
saveRDS(spp_master_ztemp_seus_buoy.traits_scaled.nosleeper, here::here("figures","Figure5","spp_master_ztemp_seus_buoy.traits_scaled.nosleeper.rds"))




```


Making all models for arrival

NB: deleted + (1|phylum) because there's only one phylum (chordata) because here we look at fish only
```{r all models arrival}

#delete any observations without full trait data
arrival.reduced_nosleeper.r <- arrival.reduced_nosleeper[complete.cases(arrival.reduced_nosleeper[ , .(age.max_ocean_scaled, age.maturity_ocean_scaled, length.max_ocean_scaled, tl_ocean_scaled)]),]

#11649 total rows (12203 without removing first year of observations)

#save for plotting in separate script
saveRDS(arrival.reduced_nosleeper.r, file = here::here("figures","Figure5","arrival.reduced_nosleeper.r.rds"))

#for now, going with two traits and one temp variable
#going to make loop to make all models I need to look at with single variables
all.temp.variables <- colnames(arrival.reduced_nosleeper.r[,14:261]) #CHECKKK
all.temp.variables.0 <- c(0, all.temp.variables) #add 0 as option so models can just include traits
all.temp.variables.0 <- all.temp.variables.0[!grepl("*mean*", all.temp.variables.0)]#get rid of MEAN temp variables
all.trait.variables <- c(0, "tl_ocean_scaled", "age.max_ocean_scaled","age.maturity_ocean_scaled", "length.max_ocean_scaled",
                         "tl_ocean_scaled + age.max_ocean_scaled", "age.max_ocean_scaled + tl_ocean_scaled",
                         "tl_ocean_scaled + age.maturity_ocean_scaled", "age.maturity_ocean_scaled + tl_ocean_scaled",
                         "tl_ocean_scaled + length.max_ocean_scaled", "length.max_ocean_scaled + tl_ocean_scaled",
                         "age.max_ocean_scaled + age.maturity_ocean_scaled", "age.maturity_ocean_scaled + age.max_ocean_scaled",
                         "age.max_ocean_scaled + length.max_ocean_scaled", "length.max_ocean_scaled + age.max_ocean_scaled",
                         "age.maturity_ocean_scaled + length.max_ocean_scaled", "length.max_ocean_scaled + age.maturity_ocean_scaled")

sign <- c("+", "*")

full_var_set <- as.data.table(expand.grid(all.temp.variables.0, sign, all.trait.variables))

#delete repeats (just temperature and both + and *)

full_var_set.r <- full_var_set[!which((Var1 == "0" & Var2 =="*")|(Var3 == "0" & Var2 == "*")),] #this excludes repeats with *

#repeated rows with traits
repeats <- c("age.maturity_ocean_scaled + age.max_ocean_scaled","tl_ocean_scaled + age.maturity_ocean_scaled", "length.max_ocean_scaled + age.maturity_ocean_scaled", "age.maturity_ocean_scaled + length.max_ocean_scaled", "tl_ocean_scaled + length.max_ocean_scaled", "tl_ocean_scaled + age.max_ocean_scaled")

#delete rows with + and same combination of 2nd and 3rd traits
full_var_set.r2 <- full_var_set.r[!which(Var2 == "+"& Var3 %in% repeats)]


#build datatable
arrival_model_comparison_traits_nosleeper <- as.data.table(matrix(nrow = nrow(full_var_set.r2))) 
arrival_model_comparison_traits_nosleeper[, temp_variable:=as.factor(V1)][, sign:=as.factor(V1)][, trait_variable:=as.factor(V1)][, AICc:=as.numeric(V1)][, converge:= as.logical(V1)]
arrival_model_comparison_traits_nosleeper[, V1 := NULL]

for (i in 1:nrow(full_var_set.r2)){
 
  temp <- full_var_set.r2$Var1[i]
  sign <- full_var_set.r2$Var2[i]
  trait <- full_var_set.r2$Var3[i]
  
  raw_form <- ifelse(temp == 0 & trait != 0,
      paste("col ~", trait, "+ (1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp)"),
          ifelse(temp != 0 & trait == 0,
           paste("col ~", temp, "+ (1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp)"),
              ifelse(temp == 0 & trait == 0,
              paste("col ~", "(1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp)"),
                paste("col ~",temp,sign,trait, "+ (1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp)"))))

  formula <- as.formula(raw_form)
  
  mod <- glmer(formula, family = binomial, data = arrival.reduced_nosleeper.r, nAGQ = 0)
  
  #observations without deleting 554 first rows
  #Number of obs: 12203, groups:  spp, 347; genus, 208; family, 85; order, 35; reg, 9; class, 5
  #observations with deleting 554 first rows
  #Number of obs: 11649, groups:  spp, 347; genus, 208; family, 85; order, 35; reg, 9; class, 5

  
  arrival_model_comparison_traits_nosleeper[i,temp_variable := full_var_set.r2$Var1[i]]
  arrival_model_comparison_traits_nosleeper[i,sign := full_var_set.r2$Var2[i]]
  arrival_model_comparison_traits_nosleeper[i,trait_variable := full_var_set.r2$Var3[i]]
  arrival_model_comparison_traits_nosleeper[i,AICc := AICc(mod)]
  
  warning <- mod@optinfo$conv$lme4$messages[2]
  converges <- ifelse(is.null(warning) == TRUE, T, F)
  
  arrival_model_comparison_traits_nosleeper[i, converge := converges]
  
  print(paste(i, nrow(arrival_model_comparison_traits_nosleeper), sep = "/"))
    
}

saveRDS(arrival_model_comparison_traits_nosleeper, "arrival_model_comparison_traits_nosleeper.rds")

fwrite("arrival_model_comparison_traits_nosleeper.csv")

saveRDS(arrival_model_comparison_traits_nosleeper, here::here("Model_results","Traits","arrival_model_comparison_traits_nosleeper.rds"))

arrival_model_comparison_traits_nosleeper <- readRDS(here::here("Model_results","Traits","arrival_model_comparison_traits_nosleeper.rds"))

```

Making all models for departure
```{r all models departure}

#for now, going with two traits and one temp variable
#going to make loop to make all models I need to look at with single variables
#don't want mean

#to assist with convergence: year as factor
departure.reduced_nosleeper[,year := as.factor(year)]

#delete any observations without full trait data
departure.reduced_nosleeper.r <- departure.reduced_nosleeper[complete.cases(departure.reduced_nosleeper[ , .(age.max_ocean_scaled, age.maturity_ocean_scaled, length.max_ocean_scaled, tl_ocean_scaled)]),]

#save for plotting in separate script
saveRDS(departure.reduced_nosleeper.r, file = here::here("figures","Figure5","departure.reduced_nosleeper.r.rds"))


departure_model_comparison_traits_nosleeper <- as.data.table(matrix(nrow = nrow(full_var_set.r2))) 
departure_model_comparison_traits_nosleeper[, temp_variable:=as.factor(V1)][, sign:=as.factor(V1)][, trait_variable:=as.factor(V1)][, AICc:=as.numeric(V1)][, converge:= as.logical(V1)]
departure_model_comparison_traits_nosleeper[, V1 := NULL]

for (i in 1:nrow(full_var_set.r2)){
 
  temp <- full_var_set.r2$Var1[i]
  sign <- full_var_set.r2$Var2[i]
  trait <- full_var_set.r2$Var3[i]
  
  raw_form <- ifelse(temp == 0 & trait != 0,
      paste("now_ext ~", trait, "+ (1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp)"),
          ifelse(temp != 0 & trait == 0,
           paste("now_ext ~", temp, "+ (1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp)"),
              ifelse(temp == 0 & trait == 0,
              paste("now_ext ~", "(1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp)"),
                paste("now_ext ~",temp,sign,trait, "+ (1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp)"))))

  formula <- as.formula(raw_form)
  
  mod <- glmer(formula, family = binomial, data = departure.reduced_nosleeper.r, nAGQ = 0)
  
  departure_model_comparison_traits_nosleeper[i,temp_variable := full_var_set.r2$Var1[i]]
  departure_model_comparison_traits_nosleeper[i,sign := full_var_set.r2$Var2[i]]
  departure_model_comparison_traits_nosleeper[i,trait_variable := full_var_set.r2$Var3[i]]
  departure_model_comparison_traits_nosleeper[i,AICc := AICc(mod)]
  
  warning <- mod@optinfo$conv$lme4$messages[2]
  converges <- ifelse(is.null(warning) == TRUE, T, F)
  
  departure_model_comparison_traits_nosleeper[i, converge := converges]
  
  print(paste(i, nrow(departure_model_comparison_traits_nosleeper), sep = "/"))
    
}


saveRDS(departure_model_comparison_traits_nosleeper, here::here("Model_results","Traits","departure_model_comparison_traits_nosleeper.rds"))

departure_model_comparison_traits_nosleeper <- readRDS(here::here("Model_results","Traits","departure_model_comparison_traits_nosleeper.rds"))

```

Next step is to look at RVI (relative variable importance)

RVI for Temperature Trait Arrival Models

```{r RVI arrival traits}
#only raw temp has lag of 10 years, which means variable importance comparisons are unbalanced so I will get rid of these rows
arrival_model_comparisons_traits.nosleeper <- arrival_model_comparison_traits_nosleeper[!grepl("lag10", temp_variable), ]

#add ∆AIC to tables
min_arrival_AICc_trait <- min(arrival_model_comparisons_traits.nosleeper[, AICc])
arrival_model_comparisons_traits.nosleeper[,"deltaAICc" := (AICc - min_arrival_AICc_trait)]

#add relative likelihood exp( -0.5 * ∆AIC score for that model)
arrival_model_comparisons_traits.nosleeper[,"rel_likelihood" := exp((-0.5 * deltaAICc))]
#sum relative likelihoods across all models
arrival_model_comparisons_traits.nosleeper.likelihoodsum <- sum(arrival_model_comparisons_traits.nosleeper[, rel_likelihood])
#Akaike weight for a model is this rel_likelihood devided by the sum of these values across all models
arrival_model_comparisons_traits.nosleeper[,"akaike_weight" := rel_likelihood/arrival_model_comparisons_traits.nosleeper.likelihoodsum]

#I want to look at relative importance FOR 
#bottom/surface (bottom = includes sbt, grepl("sbt", variable))
arrival_bottom_importance <- sum(arrival_model_comparisons_traits.nosleeper[grep("sbt", temp_variable), ]$akaike_weight)
arrival_surface_importance <- sum(arrival_model_comparisons_traits.nosleeper[grep("sst", temp_variable), ]$akaike_weight)
  arrival_bottom_importance.n <- count(arrival_model_comparisons_traits.nosleeper[grepl("sbt", temp_variable), ]) #2970
  arrival_surface_importance.n <- count(arrival_model_comparisons_traits.nosleeper[grepl("sst", temp_variable), ]) #2970

#lag\not lagged (grepl("lag", variable))
arrival_lag_importance <- sum(arrival_model_comparisons_traits.nosleeper[grep("lag", temp_variable), ]$akaike_weight)
arrival_nolag_importance <- sum(arrival_model_comparisons_traits.nosleeper[!grep("lag", temp_variable), ]$akaike_weight)
  arrival_lag_importance.n <- count(arrival_model_comparisons_traits.nosleeper[grepl("lag", temp_variable), ]) #5346 models include a lag
  arrival_nolag_importance.n <- count(arrival_model_comparisons_traits.nosleeper[!grepl("lag", temp_variable), ]) #611 don't include a lag (no lag OR trait only)


  #17 models have NO temp variable
  
  
#absolute (grepl("abs", variable))
arrival_abs_importance <- sum(arrival_model_comparisons_traits.nosleeper[grep("abs", temp_variable), ]$akaike_weight)
  arrival_abs_importance.n <- count(arrival_model_comparisons_traits.nosleeper[grepl("abs", temp_variable), ])#1980
  
#raw (!grepl("change"))
arrival_raw_importance <- sum(arrival_model_comparisons_traits.nosleeper[!grep("change", temp_variable), ][temp_variable != 0,]$akaike_weight)
  arrival_raw_importance.n <- count(arrival_model_comparisons_traits.nosleeper[!grepl("change", temp_variable), ][temp_variable != 0]) #1980

#change (grepl("change", temp_variable), (!grepl("abs")))
arrival_change_importance <- sum(arrival_model_comparisons_traits.nosleeper[grep("change", temp_variable), ][!grep("abs", temp_variable),]$akaike_weight)
  arrival_change_importance.n <- count(arrival_model_comparisons_traits.nosleeper[grep("change", temp_variable), ][!grep("abs", temp_variable),])#1980


#type of temp temp_variable (max, min, seas)
arrival_max_temp_importance <- sum(arrival_model_comparisons_traits.nosleeper[grep("max", temp_variable), ]$akaike_weight)
arrival_min_temp_importance <- sum(arrival_model_comparisons_traits.nosleeper[grep("min", temp_variable), ]$akaike_weight)
arrival_seas_temp_importance <- sum(arrival_model_comparisons_traits.nosleeper[grep("seas", temp_variable), ]$akaike_weight)
  arrival_max_temp_importance.n <- count(arrival_model_comparisons_traits.nosleeper[grepl("max", temp_variable), ]) #1980
  arrival_min_temp_importance.n <- count(arrival_model_comparisons_traits.nosleeper[grepl("min", temp_variable), ]) #1980
  arrival_seas_temp_importance.n <- count(arrival_model_comparisons_traits.nosleeper[grepl("seas", temp_variable), ]) #1980
  

#traits included
arrival_age.max_importance <- sum(arrival_model_comparisons_traits.nosleeper[grep("age.max", trait_variable), ]$akaike_weight)
arrival_age.maturity_importance <- sum(arrival_model_comparisons_traits.nosleeper[grep("age.maturity", trait_variable), ]$akaike_weight)
arrival_tl_importance <- sum(arrival_model_comparisons_traits.nosleeper[grep("tl", trait_variable), ]$akaike_weight)
arrival_length.max_importance <- sum(arrival_model_comparisons_traits.nosleeper[grep("length", trait_variable),]$akaike_weight)
  arrival_age.max_importance.n <- count(arrival_model_comparisons_traits.nosleeper[grepl("age.max", trait_variable), ]) #2527
  arrival_age.maturity_importance.n <- count(arrival_model_comparisons_traits.nosleeper[grepl("age.maturity", trait_variable), ]) #2527
  arrival_tl_importance.n <- count(arrival_model_comparisons_traits.nosleeper[grepl("tl", trait_variable), ]) #2527
  arrival_length.max_importance.n <- count(arrival_model_comparisons_traits.nosleeper[grepl("length", trait_variable),]) #2527


#interaction between trait and temperature
arrival_interaction_temp_trait_importance <- sum(arrival_model_comparisons_traits.nosleeper[grep("\\*", sign), ]$akaike_weight)
  arrival_interaction_temp_trait_importance.n <- count(arrival_model_comparisons_traits.nosleeper[grepl("\\*", sign), ]) #2880


#save this table
saveRDS(arrival_model_comparisons_traits.nosleeper, here::here("Model_results","Traits","arrival_models_traits_with_likelihoods_nosleeper.rds"))
saveRDS(arrival_model_comparisons_traits.nosleeper, here::here("tables","arrival_models_traits_with_likelihoods_nosleeper.rds"))
```

```{r put RVIs for arrival into data table}
arrival_departure <- c("arrival","arrival","arrival","arrival","arrival", "arrival","arrival", "arrival", "arrival","arrival", "arrival","arrival", "arrival", "arrival","arrival")
type <- c("depth", "depth", "lag", "lag", "Change?", "Change?", "Change?", "Temp", "Temp", "Temp", "Trait", "Trait", "Trait","Trait", "Interaction")
variable <- c("bottom", "surface", "no_lag", "lagged", "absolute_value_change", "change", "raw", "Min", "Max", "Seas", "age.max", "age.maturity", "tl", "length.max", "tempxtrait")
value <- c(arrival_bottom_importance, arrival_surface_importance, arrival_nolag_importance, arrival_lag_importance, arrival_abs_importance, arrival_change_importance, arrival_raw_importance, arrival_min_temp_importance, arrival_max_temp_importance, arrival_seas_temp_importance, arrival_age.max_importance, arrival_age.maturity_importance, arrival_tl_importance, arrival_length.max_importance, arrival_interaction_temp_trait_importance)

RVI_arrival_traits <- data.table(arrival_departure, type, variable, value)
```

Parameters for best arrival models (AIC<2)

"The estimate for max temp of -0.27 means that a 1 degree increase in seasonality is associated with a 0.27 decrease in the log-odds of a Gain occuring, compared to no Gain occuring. If we exponentiate this number then we obtain the odds ratio of 0.7633795, which means that for a 1 degree increase in the absolute change in max temp we expect to see (approximately) a 24% decrease in the odds of a Gain Occurring." From this [Stack Exchange post](https://stats.stackexchange.com/questions/444797/interpreting-a-generalised-linear-mixed-model-with-binomial-data).
-we report as odds and not probability, because change in probability varies depending on where you are on the x-axis but change in odds does not
-This is also helpful: https://stats.oarc.ucla.edu/other/mult-pkg/faq/general/faq-how-do-i-interpret-odds-ratios-in-logistic-regression/

"The estimate for max age of -0.71 means that a 1 year increase in max age is associated with a 0.71 decrease in the log-odds of a Gain occuring, compared to no Gain occuring. If we exponentiate this number then we obtain the odds ratio of 0.49, which means that for a 1 year increase in the max age we expect to see (approximately) a 51% decrease in the odds of a Gain Occurring." From this [Stack Exchange post](https://stats.stackexchange.com/questions/444797/interpreting-a-generalised-linear-mixed-model-with-binomial-data).

```{r arrival model best parameter comparison}

colmod1 <- glmer(col ~ max_sst_temp_lag3_scaled * age.max_ocean_scaled + (1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp), family = "binomial", data = arrival.reduced_nosleeper.r, nAGQ = 0)

colmod2 <- glmer(col ~ max_sst_temp_lag3_scaled * age.max_ocean_scaled + tl_ocean_scaled + (1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp), family = "binomial", data = arrival.reduced_nosleeper.r, nAGQ = 0)

colmod3 <- glmer(col ~ max_sst_temp_lag4_scaled * age.max_ocean_scaled+ (1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp), family = "binomial", data = arrival.reduced_nosleeper.r, nAGQ = 0)

colmod4 <- glmer(col ~ max_sst_temp_lag3_scaled * age.max_ocean_scaled + age.maturity_ocean_scaled + (1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp), family = "binomial", data = arrival.reduced_nosleeper.r, nAGQ = 0)

colmod5 <- glmer(col ~ max_sst_temp_lag3_scaled * length.max_ocean_scaled + age.max_ocean_scaled + (1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp), family = "binomial", data = arrival.reduced_nosleeper.r, nAGQ = 0)

colmod6 <- glmer(col ~ max_sst_temp_lag3_scaled * age.max_ocean_scaled + length.max_ocean_scaled + (1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp), family = "binomial", data = arrival.reduced_nosleeper.r, nAGQ = 0)

#no temp
colmod_notemp <- glmer(col ~ age.max_ocean_scaled + (1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp), family = "binomial", data = arrival.reduced_nosleeper.r, nAGQ = 0)

#no trait
colmod_notrait <- glmer(col ~ min_sst_temp_change_lag8_scaled + (1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp), family = "binomial", data = arrival.reduced_nosleeper.r, nAGQ = 0)

#null

colmod_null <- glmer(col ~ (1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp), family = "binomial", data = arrival.reduced_nosleeper.r, nAGQ = 0)

summary(colmod1)[10]
r.squaredGLMM(colmod1)[4]
summary(colmod2)[10]
r.squaredGLMM(colmod2)[4]
summary(colmod3)[10]
r.squaredGLMM(colmod3)[4]
summary(colmod4)[10]
r.squaredGLMM(colmod4)[4]
summary(colmod5)[10]
r.squaredGLMM(colmod5)[4]
summary(colmod6)[10]
r.squaredGLMM(colmod6)[4]


summary(colmod_notemp)[10]
r.squaredGLMM(colmod_notemp)[4]
summary(colmod_notrait)[10]
r.squaredGLMM(colmod_notrait)[4]
summary(colmod_null)[10]
r.squaredGLMM(colmod_null)[4]

AICc(colmod1)
AICc(colmod2)-AICc(colmod1)
AICc(colmod3)-AICc(colmod1)
AICc(colmod4)-AICc(colmod1)
AICc(colmod5)-AICc(colmod1)
AICc(colmod6)-AICc(colmod1)

AICc(colmod_notrait)-AICc(colmod1) #temponly
AICc(colmod_notemp)-AICc(colmod1) #traitonly
AICc(colmod_null)-AICc(colmod1) #null 

```
Assumptions and Autocorrelation for Best Gain Model
```{r assumptions best gain model}
#Model assumptions using DHARMa package
#Test for overdispersion
#grouping basically transforms 0/1 response (bernoulli) in a k/n response (true binomial)
#https://cran.r-project.org/web/packages/DHARMa/vignettes/DHARMa.html#binomial-data
#group by region
simulationOutput_gain <- simulateResiduals(fittedModel = colmod1)
simulationOutput.groupedbyreg_gain <- recalculateResiduals(simulationOutput_gain, group = arrival.reduced_nosleeper.r$reg)
testDispersion(simulationOutput_gain)
testDispersion(simulationOutput.groupedbyreg_gain)
plot(simulationOutput.groupedbyreg_gain)

#group by spp
simulationOutput.groupedbyspp_gain <- recalculateResiduals(simulationOutput_gain, group = arrival.reduced_nosleeper.r$spp)
testDispersion(simulationOutput_gain)
testDispersion(simulationOutput.groupedbyspp_gain)
plot(simulationOutput.groupedbyspp_gain)

#group by time
simulationOutput.groupedbyyear_gain <- recalculateResiduals(simulationOutput_gain, group = arrival.reduced_nosleeper.r$year)
testDispersion(simulationOutput_gain)
testDispersion(simulationOutput.groupedbyyear_gain)
plot(simulationOutput.groupedbyyear_gain)

#temporal autocorrelation
testTemporalAutocorrelation(simulationOutput.groupedbyyear_gain, unique(arrival.reduced_nosleeper.r$year))
```


Departure

```{r RVI departure traits}
#only raw temp has lag of 10 years, which means variable importance comparisons are unbalanced so I will get rid of these rows
departure_model_comparisons_traits.nosleeper <- departure_model_comparison_traits_nosleeper[!grepl("lag10", temp_variable), ]


#add ∆AIC to tables
min_departure_AICc_trait <- min(departure_model_comparisons_traits.nosleeper[, AICc])
departure_model_comparisons_traits.nosleeper[,"deltaAICc" := (AICc - min_departure_AICc_trait)]

#get rid of duplicates when sign is +, and 

#add relative likelihood exp( -0.5 * ∆AIC score for that model)
departure_model_comparisons_traits.nosleeper[,"rel_likelihood" := exp((-0.5 * deltaAICc))]
#sum relative likelihoods across all models
departure_model_comparisons_traits.nosleeper.likelihoodsum <- sum(departure_model_comparisons_traits.nosleeper[, rel_likelihood])
#Akaike weight for a model is this rel_likelihood devided by the sum of these values across all models
departure_model_comparisons_traits.nosleeper[,"akaike_weight" := rel_likelihood/departure_model_comparisons_traits.nosleeper.likelihoodsum]

#I want to look at relative importance FOR 
#bottom/surface (bottom = includes sbt, grepl("sbt", variable))
departure_bottom_importance <- sum(departure_model_comparisons_traits.nosleeper[grep("sbt", temp_variable), ]$akaike_weight)
  departure_bottom_importance.n <- count(departure_model_comparisons_traits.nosleeper[grepl("sbt", temp_variable), ]) #2970
departure_surface_importance <- sum(departure_model_comparisons_traits.nosleeper[grep("sst", temp_variable), ]$akaike_weight)
  departure_surface_importance.n <- count(departure_model_comparisons_traits.nosleeper[grepl("sst", temp_variable), ]) #2970
  
#lag\not lagged (grepl("lag", variable))
departure_lag_importance <- sum(departure_model_comparisons_traits.nosleeper[grep("lag", temp_variable), ]$akaike_weight)
  departure_lag_importance.n <- count(departure_model_comparisons_traits.nosleeper[grepl("lag", temp_variable),]) #5346
departure_nolag_importance <- sum(departure_model_comparisons_traits.nosleeper[!grep("lag", temp_variable), ]$akaike_weight)
  departure_nolag_importance.n <- count(departure_model_comparisons_traits.nosleeper[!grepl("lag", temp_variable), ]) #611

  #absolute (grepl("abs", variable))
departure_abs_importance <- sum(departure_model_comparisons_traits.nosleeper[grep("abs", temp_variable), ]$akaike_weight)
  departure_abs_importance.n <- count(departure_model_comparisons_traits.nosleeper[grepl("abs", temp_variable), ]) #1980

  #raw (!grepl("change"))
departure_raw_importance <- sum(departure_model_comparisons_traits.nosleeper[!grep("change", temp_variable), ][temp_variable != 0,]$akaike_weight)
  departure_raw_importance.n <- count(departure_model_comparisons_traits.nosleeper[!grepl("change", temp_variable), ][temp_variable != 0,]) #1980

#change (grepl("change", temp_variable), (!grepl("abs")))
departure_change_importance <- sum(departure_model_comparisons_traits.nosleeper[grep("change", temp_variable), ][!grep("abs", temp_variable),]$akaike_weight)
  departure_change_importance.n <- count(departure_model_comparisons_traits.nosleeper[grepl("change", temp_variable), ][!grepl("abs", temp_variable),])#1980

#type of temp temp_variable (max, min, seas)
departure_max_temp_importance <- sum(departure_model_comparisons_traits.nosleeper[grep("max", temp_variable), ]$akaike_weight)
  departure_max_temp_importance.n <- count(departure_model_comparisons_traits.nosleeper[grepl("max", temp_variable), ]) #1980
departure_min_temp_importance <- sum(departure_model_comparisons_traits.nosleeper[grep("min", temp_variable), ]$akaike_weight)
  departure_min_temp_importance.n <- count(departure_model_comparisons_traits.nosleeper[grepl("min", temp_variable), ]) #1980
departure_seas_temp_importance <- sum(departure_model_comparisons_traits.nosleeper[grep("seas", temp_variable), ]$akaike_weight)
  departure_seas_temp_importance.n <- count(departure_model_comparisons_traits.nosleeper[grepl("seas", temp_variable), ]) #1980

#traits included
departure_age.max_importance <- sum(departure_model_comparisons_traits.nosleeper[grep("age.max", trait_variable), ]$akaike_weight)
departure_age.maturity_importance <- sum(departure_model_comparisons_traits.nosleeper[grep("age.maturity", trait_variable), ]$akaike_weight)
departure_tl_importance <- sum(departure_model_comparisons_traits.nosleeper[grep("tl", trait_variable), ]$akaike_weight)
departure_length.max_importance <- sum(departure_model_comparisons_traits.nosleeper[grep("length", trait_variable),]$akaike_weight)

  departure_age.max_importance.n <- count(departure_model_comparisons_traits.nosleeper[grepl("age.max", trait_variable), ]) #2527
  departure_age.maturity_importance.n <- count(departure_model_comparisons_traits.nosleeper[grepl("age.maturity", trait_variable), ]) #2527
  departure_tl_importance.n <- count(departure_model_comparisons_traits.nosleeper[grepl("tl", trait_variable), ]) #2527
  departure_length.max_importance.n <- count(departure_model_comparisons_traits.nosleeper[grepl("length", trait_variable),]) #2527

#interaction between trait and temperature
departure_interaction_temp_trait_importance <- sum(departure_model_comparisons_traits.nosleeper[grep("\\*", sign), ]$akaike_weight)
  departure_interaction_temp_trait_importance.n <- count(departure_model_comparisons_traits.nosleeper[grepl("\\*", sign), ]) #2880


#save this table
saveRDS(departure_model_comparisons_traits.nosleeper, here::here("Model_results","Traits","departure_models_traits_with_likelihoods_nosleeper.rds"))
saveRDS(departure_model_comparisons_traits.nosleeper, here::here("tables","departure_models_traits_with_likelihoods_nosleeper.rds"))
```

```{r put RVIs for extinction into data table}
arrival_departure <- c("departure","departure","departure","departure","departure", "departure","departure", "departure", "departure","departure", "departure","departure", "departure", "departure","departure")
type <- c("depth", "depth", "lag", "lag", "Change?", "Change?", "Change?", "Temp", "Temp", "Temp", "Trait", "Trait", "Trait","Trait", "Interaction")
variable <- c("bottom", "surface", "no_lag", "lagged", "absolute_value_change", "change", "raw", "Min", "Max", "Seas", "age.max", "age.maturity", "tl", "length.max", "tempxtrait")
value <- c(departure_bottom_importance, departure_surface_importance, departure_nolag_importance, departure_lag_importance, departure_abs_importance, departure_change_importance, departure_raw_importance, departure_min_temp_importance, departure_max_temp_importance, departure_seas_temp_importance, departure_age.max_importance, departure_age.maturity_importance, departure_tl_importance, departure_length.max_importance, departure_interaction_temp_trait_importance)

RVI_departure_traits <- data.table(arrival_departure, type, variable, value)
```

Parameters for best departure models (AIC<2)

```{r departure model best parameter comparison}

now_extmod1 <- glmer(now_ext ~max_sst_temp_scaled
*
length.max_ocean_scaled + age.maturity_ocean_scaled+ (1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp), family = "binomial", data = departure.reduced_nosleeper.r, nAGQ = 0)

now_extmod2 <- glmer(now_ext ~max_sst_temp_scaled
*
length.max_ocean_scaled + age.max_ocean_scaled+ (1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp), family = "binomial", data = departure.reduced_nosleeper.r, nAGQ = 0)

now_extmod3 <- glmer(now_ext ~ max_sst_temp_lag2_scaled
*
length.max_ocean_scaled + age.maturity_ocean_scaled+ (1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp), family = "binomial", data = departure.reduced_nosleeper.r, nAGQ = 0)

now_extmod4 <- glmer(now_ext ~max_sst_temp_lag2_scaled
*
length.max_ocean_scaled + age.max_ocean_scaled+ (1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp), family = "binomial", data = departure.reduced_nosleeper.r, nAGQ = 0)


#no temp
now_extmod_notemp <- glmer(now_ext ~ age.max_ocean_scaled + (1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp), family = "binomial", data = departure.reduced_nosleeper.r, nAGQ = 0)
#no trait
now_extmod_notrait <- glmer(now_ext ~ max_sst_temp_scaled + (1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp), family = "binomial", data = departure.reduced_nosleeper.r, nAGQ = 0)

#null

now_extmod_null <- glmer(now_ext ~ (1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp), family = "binomial", data = departure.reduced_nosleeper.r, nAGQ = 0)

summary(now_extmod1)[10]
r.squaredGLMM(now_extmod1)[4]
summary(now_extmod2)[10]
r.squaredGLMM(now_extmod2)[4]
summary(now_extmod3)[10]
r.squaredGLMM(now_extmod3)[4]
summary(now_extmod4)[10]
r.squaredGLMM(now_extmod4)[4]

summary(now_extmod_notemp)[10]
r.squaredGLMM(now_extmod_notemp)[4]
summary(now_extmod_notrait)[10]
r.squaredGLMM(now_extmod_notrait)[4]
summary(now_extmod_null)[10]
r.squaredGLMM(now_extmod_null)[4]

AICc(now_extmod1)
AICc(now_extmod2)-AICc(now_extmod1)
AICc(now_extmod3)-AICc(now_extmod1)
AICc(now_extmod4)-AICc(now_extmod1)



AICc(now_extmod_notemp)-AICc(now_extmod1) #trait only
AICc(now_extmod_notrait)-AICc(now_extmod1) #temp only
AICc(now_extmod_null)-AICc(now_extmod1) #full null 
```

Assumptions and Autocorrelation for Best Loss Model
```{r assumptions best loss model}
#Model assumptions using DHARMa package
#Test for overdispersion
#grouping basically transforms 0/1 response (bernoulli) in a k/n response (true binomial)
#https://cran.r-project.org/web/packages/DHARMa/vignettes/DHARMa.html#binomial-data
#group by region
simulationOutput_loss <- simulateResiduals(fittedModel = colmod1)
simulationOutput.groupedbyreg_loss <- recalculateResiduals(simulationOutput_loss, group = departure.reduced_nosleeper.r$reg)
testDispersion(simulationOutput_loss)
testDispersion(simulationOutput.groupedbyreg_loss)
plot(simulationOutput.groupedbyreg_loss)

#group by spp
simulationOutput.groupedbyspp_loss <- recalculateResiduals(simulationOutput_loss, group = departure.reduced_nosleeper.r$spp)
testDispersion(simulationOutput_loss)
testDispersion(simulationOutput.groupedbyspp_loss)
plot(simulationOutput.groupedbyspp_loss)

#group by time
simulationOutput.groupedbyyear_loss <- recalculateResiduals(simulationOutput_loss, group = departure.reduced_nosleeper.r$year)
testDispersion(simulationOutput_loss)
testDispersion(simulationOutput.groupedbyyear_loss)
plot(simulationOutput.groupedbyyear_loss)

#temporal autocorrelation
testTemporalAutocorrelation(simulationOutput.groupedbyyear_loss, unique(departure.reduced_nosleeper.r$year))
```

Merge RVI tables for colonization and extinction with traits, and then graph
```{r merge RVI trait tables and plot}
RVI_trait_table <- as.data.table(rbind(RVI_arrival_traits, RVI_departure_traits)) #bind RVI for colonizations and extinctions

RVI_trait_table.r <- RVI_trait_table[!grep("surface", variable)][!grep("lagged", variable)]

#change order of factor levels
RVI_trait_table.r[, variable := factor(variable, levels = c("bottom", "no_lag", "raw", "change", "absolute_value_change", "Min", "Max", "Seas", "age.max", "age.maturity", "tl", "length.max", "tempxtrait"))]

save(RVI_trait_table, file = "RVI_trait_table_nosleeper.Rdata")

ggplot(data = RVI_trait_table.r, aes(x=variable, y = value, fill = arrival_departure)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_x_discrete(breaks = c("bottom", "no_lag", "raw", "change", "absolute_value_change", "Min", "Max", "Seas", "age.max", "age.maturity", "tl", "length.max", "tempxtrait"), labels = c("Bottom\nTemp", "No\nLag", "Raw\nTemp", "Change in \nTemp", "| Change in\n Temp |", "Min\nTemp", "Max\nTemp", "Seas", "Age\nMax", "Age\nMaturity", "Trophic\nLevel", "Max\nLength" , "Temp*\nTrait")) +
  labs(x = "Temperature and Trait Variables", y = "Relative Variable Importance")  +
  theme_bw()

```

Another way to visualize
```{r visualizing RVI with traits}
#put levels into correct order for viewing
RVI_trait_table[
  , variable := factor(variable, levels = c("bottom", "surface", "absolute_value_change", "change", "raw", "no_lag", "lagged", "Min", "Max", "Seas", "age.max", "age.maturity", "tl","length.max", "tempxtrait"))][
    ,type := factor(type, levels = c("Change?", "depth", "lag", "Temp", "Trait", "Interaction"))]
#make types factors as well

#colonization
RVI_arrival_trait_plot <- ggplot(data = RVI_trait_table[arrival_departure == "arrival" & (type == "Trait" | type == "Interaction")], aes(x=variable, y = value)) +
  geom_bar(stat= "identity") +
  scale_x_discrete(breaks = c("age.max", "age.maturity", "tl", "length.max", "tempxtrait"), labels = c("Maximum\nAge", "Age of\nMaturity", "Trophic\nLevel","Max\nLength", "Temp Trait\nInteraction")) +
  labs(x = "Trait Variables", y = "Relative Variable Importance") +
  theme_classic() +
  theme(text = element_text(size = 20))
#departure
RVI_departure_trait_plot <- ggplot(data = RVI_trait_table[arrival_departure == "departure" & (type == "Trait" | type == "Interaction")], aes(x=variable, y = value)) +
  geom_bar(stat= "identity") +
  scale_x_discrete(breaks = c("age.max", "age.maturity", "tl","length.max",  "tempxtrait"), labels = c("Maximum\nAge", "Age of\nMaturity", "Trophic\nLevel","Max\nLength", "Temp Trait\nInteraction")) +
  labs(x = "Trait Variables", y = "Relative Variable Importance") +
  theme_classic() +
  theme(text = element_text(size = 20))

RVI_arrival_trait_plot
RVI_departure_trait_plot

save(RVI_trait_table, file = "RVI_trait_table_nosleeper.Rdata")
```
Let's see how the RVI importance varies by looking at specific lag values for these trait models
```{r make a plot here for variability across lag values for trait models}
#first, table for lags
lags_v_RVI_trait <- data.table(arrival_lag = c(0:9), arrival_RVI = 0, departure_RVI = 0)
#arrival
lags_v_RVI_trait[1,2] <- 1-sum(arrival_model_comparisons_traits.nosleeper[grep("lag", temp_variable), ]$akaike_weight)
lags_v_RVI_trait[2,2] <- sum(arrival_model_comparisons_traits.nosleeper[grep("lag1", temp_variable), ]$akaike_weight)
lags_v_RVI_trait[3,2] <- sum(arrival_model_comparisons_traits.nosleeper[grep("lag2", temp_variable), ]$akaike_weight)
lags_v_RVI_trait[4,2] <- sum(arrival_model_comparisons_traits.nosleeper[grep("lag3", temp_variable), ]$akaike_weight)
lags_v_RVI_trait[5,2] <- sum(arrival_model_comparisons_traits.nosleeper[grep("lag4", temp_variable), ]$akaike_weight)
lags_v_RVI_trait[6,2] <- sum(arrival_model_comparisons_traits.nosleeper[grep("lag5", temp_variable), ]$akaike_weight)
lags_v_RVI_trait[7,2] <- sum(arrival_model_comparisons_traits.nosleeper[grep("lag6", temp_variable), ]$akaike_weight)
lags_v_RVI_trait[8,2] <- sum(arrival_model_comparisons_traits.nosleeper[grep("lag7", temp_variable), ]$akaike_weight)
lags_v_RVI_trait[9,2] <- sum(arrival_model_comparisons_traits.nosleeper[grep("lag8", temp_variable), ]$akaike_weight)
lags_v_RVI_trait[10,2] <- sum(arrival_model_comparisons_traits.nosleeper[grep("lag9", temp_variable), ]$akaike_weight)
#departure
lags_v_RVI_trait[1,3] <- 1-sum(departure_model_comparisons_traits.nosleeper[grep("lag", temp_variable), ]$akaike_weight)
lags_v_RVI_trait[2,3] <- sum(departure_model_comparisons_traits.nosleeper[grep("lag1", temp_variable), ]$akaike_weight)
lags_v_RVI_trait[3,3] <- sum(departure_model_comparisons_traits.nosleeper[grep("lag2", temp_variable), ]$akaike_weight)
lags_v_RVI_trait[4,3] <- sum(departure_model_comparisons_traits.nosleeper[grep("lag3", temp_variable), ]$akaike_weight)
lags_v_RVI_trait[5,3] <- sum(departure_model_comparisons_traits.nosleeper[grep("lag4", temp_variable), ]$akaike_weight)
lags_v_RVI_trait[6,3] <- sum(departure_model_comparisons_traits.nosleeper[grep("lag5", temp_variable), ]$akaike_weight)
lags_v_RVI_trait[7,3] <- sum(departure_model_comparisons_traits.nosleeper[grep("lag6", temp_variable), ]$akaike_weight)
lags_v_RVI_trait[8,3] <- sum(departure_model_comparisons_traits.nosleeper[grep("lag7", temp_variable), ]$akaike_weight)
lags_v_RVI_trait[9,3] <- sum(departure_model_comparisons_traits.nosleeper[grep("lag8", temp_variable), ]$akaike_weight)
lags_v_RVI_trait[10,3] <- sum(departure_model_comparisons_traits.nosleeper[grep("lag9", temp_variable), ]$akaike_weight)

(RVI_lags_traits <- ggplot(data = lags_v_RVI_trait, aes(x = arrival_lag)) +
  geom_line(aes(y = arrival_RVI)) +
  geom_line(aes(y = departure_RVI), linetype = "dashed") +
  labs(x = "Lag (years)", y = "Relative Variable Importance") +
  theme_classic() +
  theme(text = element_text(size = 22, color = "black")) +
  scale_x_continuous(breaks = 0:10) +
  scale_y_continuous(limits = 0:1))

save(RVI_arrival_trait_plot, RVI_departure_trait_plot, RVI_lags_traits, file = "RVI_plots_traits_nosleeper.Rdata")

setEPS()
postscript("RVI_arrival_trait_plot.eps")
RVI_arrival_trait_plot
dev.off()

setEPS()
postscript("RVI_departure_trait_plot.eps")
RVI_departure_trait_plot
dev.off()

setEPS()
postscript("RVI_lags_trait_plot.eps")
RVI_lags_traits
dev.off()
```

What do interactions look like?

##arrival with Traits
Best model: max_sst_temp_lag3_scaled * age.max_ocean_scaled

All fish no traits: 	
min_sst_temp_change_lag8_scaled (different)


```{r predicted values arrival}
library(ggfortify)
library(wesanderson)
pal <- c("#F9BC77","#AD6D51","#7E7976","#62B3BE","#174A4A")

#best model traits and temp
mod_arrival_trait <- glmer(col ~ max_sst_temp_lag3_scaled * age.max_ocean_scaled + (1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp), family = "binomial", data = arrival.reduced_nosleeper.r, nAGQ = 0)

#reverse to age max unscaled
mod_arrival_reverse_scaled_agemax <- lm(age.max_ocean ~ age.max_ocean_scaled, data = spp_master_ztemp_seus_buoy.traits_scaled.nosleeper) 
  
mod_arrival_forward_scaled_agematurity <- lm(age.max_ocean_scaled ~ age.max_ocean, data = spp_master_ztemp_seus_buoy.traits_scaled.nosleeper)

#histogram of max age
hist(unique(spp_master_ztemp_seus_buoy.traits_scaled.nosleeper[,.(spp,age.max_ocean)]$age.max_ocean))

  #age max age match (save for departures)
age_max_match <- data.table(ages_we_want = c(1, 30, 80,100,150))
age_max_match[,age.max_ocean_scaled := mod_arrival_forward_scaled_agematurity$coefficients[1] + mod_arrival_forward_scaled_agematurity$coefficients[2]*ages_we_want]
        

#best predictor for fish only: max_sst_temp_change_abs_lag1_scaled as x axis
temp_arrival_newdata <- runif(500,min(spp_master_ztemp_seus_buoy.traits_scaled.nosleeper$max_sst_temp_lag3_scaled), max(spp_master_ztemp_seus_buoy.traits_scaled.nosleeper$max_sst_temp_lag3_scaled))

temp_age_newdata <- age_max_match[,age.max_ocean_scaled] #length

#make all possible temp trait combos
arrival_newdata_traits <- expand.grid("max_sst_temp_lag3_scaled" = temp_arrival_newdata, "age.max_ocean_scaled" = temp_age_newdata)


preds <- predict(mod_arrival_trait, newdata = arrival_newdata_traits, re.form = NA, type = "response")
preds_predictors_col <- data.table(cbind(arrival_newdata_traits, preds))
preds_predictors_col <- preds_predictors_col[age_max_match, on = "age.max_ocean_scaled"]

#I want x axis to be meaningful
mod_arrival_reverse_scaledtemp <- lm(max_sst_temp_lag3 ~ max_sst_temp_lag3_scaled, data = spp_master_ztemp_seus_buoy.traits_scaled.nosleeper)


preds_predictors_col[,max_sst_temp_lag3_scaled := mod_arrival_reverse_scaledtemp$coefficients[2]*max_sst_temp_lag3_scaled + mod_arrival_reverse_scaledtemp$coefficients[1] ]


(arrival_preds <- ggplot(data = preds_predictors_col, aes(x = max_sst_temp_lag3_scaled, y = preds, color = as.factor(ages_we_want))) +
  geom_line(size = 0.7) +
  labs(colour="Maximum\nAge", x = "Maximum surface\ntemperature lagged 3 years (\u00B0C)", y = "Probability of Arrival") +
  theme_classic() +
  scale_color_manual(values = pal) +
  theme(text=element_text(size = 10)))

ggsave(arrival_preds, path = here::here("figures/Figure5"), file = "predicted_probs_arrival_maxage_nosleeper.jpg")
ggsave(arrival_preds, path = here::here("figures/Figure5"), file = "predicted_probs_arrival_maxage_nosleeper.eps")


```

##departure with Traits
Best model: 		max_sst_temp_scaled * length.max_ocean_scaled + age.maturity_ocean_scaled

Best model from analyses with temperature only: max_sst_temp_scaled

```{r predicted values departure}
#best model with fish only 
mod_departure_trait <- glmer(now_ext ~ max_sst_temp_scaled * length.max_ocean_scaled + age.maturity_ocean_scaled + (1|reg)  + (1|class) + (1|order) + (1|family) + (1|genus) + (1|spp), family = "binomial", data = departure.reduced_nosleeper.r, nAGQ = 0)

#reverse to length max unscaled
     mod_departure_reverse_scaled_lengthmax <- lm(length.max_ocean ~ length.max_ocean_scaled, data = spp_master_ztemp_seus_buoy.traits_scaled.nosleeper) 
      
     mod_departure_forward_scaled_lengthmax <- lm(length.max_ocean_scaled ~ length.max_ocean, data = spp_master_ztemp_seus_buoy.traits_scaled.nosleeper)

#histogram of lengths
hist(unique(spp_master_ztemp_seus_buoy.traits_scaled.nosleeper[,.(spp,length.max_ocean)]$length.max_ocean))

length_match <- data.table(lengths_we_want = c(5,50,100,300,500))
length_match[,length.max_ocean_scaled := lengths_we_want * coef(mod_departure_forward_scaled_lengthmax)[2] + coef(mod_departure_forward_scaled_lengthmax)[1]]


temp_departure_newdata <- runif(500,min(spp_master_ztemp_seus_buoy.traits_scaled.nosleeper$max_sst_temp_scaled), max(spp_master_ztemp_seus_buoy.traits_scaled.nosleeper$max_sst_temp_scaled))

temp_lengthmax_newdata <- length_match[,length.max_ocean_scaled]


temp_agematurity_newdata <- mean(departure.reduced_nosleeper.r$age.maturity_ocean_scaled, na.rm = T)

departure_newdata_traits <- expand.grid("max_sst_temp_scaled" = temp_departure_newdata, "length.max_ocean_scaled" = temp_lengthmax_newdata, "age.maturity_ocean_scaled" = temp_agematurity_newdata)


preds <- predict(mod_departure_trait, newdata = departure_newdata_traits, re.form = NA, type = "response")
preds_predictors_ext <- data.table(cbind(departure_newdata_traits, preds))
preds_predictors_ext <- preds_predictors_ext[length_match, on = "length.max_ocean_scaled"]

#I want x axis to be meaningful
mod_departure_reverse_scaledtemp <- lm(max_sst_temp ~ max_sst_temp_scaled, data = spp_master_ztemp_seus_buoy.traits_scaled.nosleeper)


preds_predictors_ext[,max_sst_temp := mod_departure_reverse_scaledtemp$coefficients[2]*max_sst_temp_scaled + mod_departure_reverse_scaledtemp$coefficients[1] ]



(departure_preds <- ggplot(data = preds_predictors_ext, aes(x = max_sst_temp, y = preds, color = as.factor(lengths_we_want))) +
  geom_line(size = 0.7) +
  labs(colour="Maximum\nLength", x = "Maximum surface temperature (\u00B0C)", y = "Probability of Departure") +
#  scale_y_continuous(breaks=c(0, 0.5, 1)) +
  theme_classic() +
  scale_color_manual(values = pal) +
  theme(text=element_text(size = 10)))

ggsave(path = here::here("figures/Figure5"), file = "predicted_probs_departure_maxlength_nosleeper.jpg")
ggsave(path = here::here("figures/Figure5"), file = "predicted_probs_departure_maxlength_nosleeper.eps")


```

Merge marginal effects plots
```{r}
library(cowplot)
mar_effects <- plot_grid(arrival_preds,departure_preds, labels = c("a.","b."), label_size = 10)



ggsave(width = 6, height = 2.5, path = here::here("figures/Figure5"), file = "Figure5_margeffect_nosleeper.jpg")
ggsave(width = 6, height = 2.5, path = here::here("figures/Figure5"), file = "Figure5_margeffect_nosleeper.eps")

```
