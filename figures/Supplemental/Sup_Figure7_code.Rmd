---
title: "Figure 4 (old Figure 5)"
output: html_notebook
---

```{r setup}
library(data.table)
library(ggplot2)
library(MuMIn)
library(lme4)

arrival.reduced_nosleeper.r <- readRDS(file = here::here("figures","Figure5","arrival.reduced_nosleeper.r.rds"))
departure.reduced_nosleeper.r <- readRDS(file = here::here("figures","Figure5","departure.reduced_nosleeper.r.rds"))

spp_master_ztemp_seus_buoy.traits_scaled.nosleeper <- readRDS(here::here("figures","Figure5","spp_master_ztemp_seus_buoy.traits_scaled.nosleeper.rds"))
```

What do interactions look like?

##arrival with Traits
Best model: max_sst_temp_change_abs_lag1_scaled * age.max_ocean_scaled

All fish no traits: max_sst_temp_change_abs_lag1_scaled (same)


```{r predicted values arrival}
pal <- c("#F9BC77","#AD6D51","#7E7976","#62B3BE","#174A4A")

#best model with fish only 
mod_arrival_trait <- glmer(col ~ max_sst_temp_change_abs_lag1_scaled * age.max_ocean_scaled + (1|reg) + (1|spp), family = "binomial", data = arrival.reduced_nosleeper.r, nAGQ = 0)

#reverse to age max unscaled
mod_arrival_reverse_scaled_agemax <- lm(age.max_ocean ~ age.max_ocean_scaled, data = spp_master_ztemp_seus_buoy.traits_scaled.nosleeper) 
  
mod_arrival_forward_scaled_agematurity <- lm(age.max_ocean_scaled ~ age.max_ocean, data = spp_master_ztemp_seus_buoy.traits_scaled.nosleeper)

#histogram of max age
hist(unique(spp_master_ztemp_seus_buoy.traits_scaled.nosleeper[,.(spp,age.max_ocean)]$age.max_ocean))

  #age max age match (save for departures)
age_max_match <- data.table(ages_we_want = c(1, 30, 80,100,150))
age_max_match[,age.max_ocean_scaled := mod_arrival_forward_scaled_agematurity$coefficients[1] + mod_arrival_forward_scaled_agematurity$coefficients[2]*ages_we_want]
        

#best predictor for fish only: max_sst_temp_change_abs_lag1_scaled as x axis
temp_arrival_newdata <- runif(500,min(spp_master_ztemp_seus_buoy.traits_scaled.nosleeper$max_sst_temp_change_abs_lag1_scaled), max(spp_master_ztemp_seus_buoy.traits_scaled.nosleeper$max_sst_temp_change_abs_lag1_scaled))

temp_age_newdata <- age_max_match[,age.max_ocean_scaled] #length

#make all possible temp trait combos
arrival_newdata_traits <- expand.grid("max_sst_temp_change_abs_lag1_scaled" = temp_arrival_newdata, "age.max_ocean_scaled" = temp_age_newdata)


preds <- predict(mod_arrival_trait, newdata = arrival_newdata_traits, re.form = NA, type = "response")
preds_predictors_col <- data.table(cbind(arrival_newdata_traits, preds))
preds_predictors_col <- preds_predictors_col[age_max_match, on = "age.max_ocean_scaled"]

#I want x axis to be meaningful
mod_arrival_reverse_scaledtemp <- lm(max_sst_temp_change_abs_lag1 ~ max_sst_temp_change_abs_lag1_scaled, data = spp_master_ztemp_seus_buoy.traits_scaled.nosleeper)


preds_predictors_col[,max_sst_temp_change_abs_lag1 := mod_arrival_reverse_scaledtemp$coefficients[2]*max_sst_temp_change_abs_lag1_scaled + mod_arrival_reverse_scaledtemp$coefficients[1] ]


(arrival_preds <- ggplot(data = preds_predictors_col, aes(x = max_sst_temp_change_abs_lag1, y = preds, color = as.factor(ages_we_want))) +
  geom_line(size = 0.7) +
  labs(colour="Maximum\nAge", x = "Absolute change in maximum surface\ntemperature lagged 1 year (\u00B0C)", y = "Probability of Gain") +
  theme_classic() +
  scale_color_manual(values = pal) +
  theme(text=element_text(size = 10)))

ggsave(arrival_preds, path = here::here("figures/Figure5"), file = "predicted_probs_arrival_maxage_nosleeper.jpg")
ggsave(arrival_preds, path = here::here("figures/Figure5"), file = "predicted_probs_arrival_maxage_nosleeper.eps")


```

##departure with Traits
Best model: 		max_sst_temp_lag6_scaled * length.max_ocean_scaled + age.max_ocean_scaled

Best model from analyses with temperature only: max_sst_temp_scaled

```{r predicted values departure}
#best model with fish only 
mod_departure_trait <- glmer(now_ext ~ max_sst_temp_lag6_scaled * length.max_ocean_scaled + age.max_ocean_scaled + (1|reg) + (1|spp), family = "binomial", data = departure.reduced_nosleeper.r, nAGQ = 0)

#reverse to length max unscaled
     mod_departure_reverse_scaled_lengthmax <- lm(length.max_ocean ~ length.max_ocean_scaled, data = spp_master_ztemp_seus_buoy.traits_scaled.nosleeper) 
      
     mod_departure_forward_scaled_lengthmax <- lm(length.max_ocean_scaled ~ length.max_ocean, data = spp_master_ztemp_seus_buoy.traits_scaled.nosleeper)

#histogram of lengths
hist(unique(spp_master_ztemp_seus_buoy.traits_scaled.nosleeper[,.(spp,length.max_ocean)]$length.max_ocean))

length_match <- data.table(lengths_we_want = c(5,50,100,300,500))
length_match[,length.max_ocean_scaled := lengths_we_want * coef(mod_departure_forward_scaled_lengthmax)[2] + coef(mod_departure_forward_scaled_lengthmax)[1]]


temp_departure_newdata <- runif(500,min(spp_master_ztemp_seus_buoy.traits_scaled.nosleeper$max_sst_temp_lag6_scaled), max(spp_master_ztemp_seus_buoy.traits_scaled.nosleeper$max_sst_temp_lag6_scaled))

temp_lengthmax_newdata <- length_match[,length.max_ocean_scaled]


temp_agemax_newdata <- mean(departure.reduced_nosleeper.r$age.max_ocean_scaled, na.rm = T)

departure_newdata_traits <- expand.grid("max_sst_temp_lag6_scaled" = temp_departure_newdata, "length.max_ocean_scaled" = temp_lengthmax_newdata, "age.max_ocean_scaled" = temp_agemax_newdata)


preds <- predict(mod_departure_trait, newdata = departure_newdata_traits, re.form = NA, type = "response")
preds_predictors_ext <- data.table(cbind(departure_newdata_traits, preds))
preds_predictors_ext <- preds_predictors_ext[length_match, on = "length.max_ocean_scaled"]

#I want x axis to be meaningful
mod_departure_reverse_scaledtemp <- lm(max_sst_temp_lag6 ~ max_sst_temp_lag6_scaled, data = spp_master_ztemp_seus_buoy.traits_scaled.nosleeper)


preds_predictors_ext[,max_sst_temp_lag6 := mod_departure_reverse_scaledtemp$coefficients[2]*max_sst_temp_lag6_scaled + mod_departure_reverse_scaledtemp$coefficients[1] ]



(departure_preds <- ggplot(data = preds_predictors_ext, aes(x = max_sst_temp_lag6, y = preds, color = as.factor(lengths_we_want))) +
  geom_line(size = 0.7) +
  labs(colour="Maximum\nLength (cm)", x = "Maximum surface temperature\n lagged 6 years (\u00B0C)", y = "Probability of Loss") +
#  scale_y_continuous(breaks=c(0, 0.5, 1)) +
  theme_classic() +
  scale_color_manual(values = pal) +
  theme(text=element_text(size = 10)))

ggsave(path = here::here("figures/Figure5"), file = "predicted_probs_departure_maxlength_nosleeper.jpg")
ggsave(path = here::here("figures/Figure5"), file = "predicted_probs_departure_maxlength_nosleeper.eps")


```


Merge marginal effects plots
```{r}
library(cowplot)
mar_effects <- plot_grid(arrival_preds,departure_preds, labels = c("a.","b."), label_size = 10)



ggsave(width = 6, height = 2.5, path = here::here("figures/Figure5"), file = "Figure5_margeffect_nosleeper.jpg")
ggsave(width = 6, height = 2.5, path = here::here("figures/Figure5"), file = "Figure5_margeffect_nosleeper.eps")

```