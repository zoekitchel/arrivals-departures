---
title: "Extracting SODA Temperature from both 2.2.4 and 3.3.1"
output: html_notebook
---
What lat/lon values do we actually need?
```{r make list of all GPS points we want to extract temp data from}
library(data.table)
load("/Users/zoekitchel/Documents/grad school/Rutgers/Coursework/Fall 2018/SDM/hauls_catch_Dec2017 1.RData")
#load("col_ext/hauls_catch_Dec2017 1.RData")
hauls <- data.table(hauls)
cols <- c("lat", "lon", "region")
latlongyear <- hauls[, cols, with = F]

# set the key to all columns
setkey(latlongyear)

# Get unique lat lon combos
latlongyear.u <- unique(latlongyear[list(lat, lon), nomatch = 0])

#minimum lat?, maximum lat? minimum long? maximum long?
summary(latlongyear.u)

#also added 360 to put in same units as NetCDF files

minlat <- min(latlongyear.u$lat)
maxlat <- max(latlongyear.u$lat)
minlon <- min(latlongyear.u$lon)
maxlon <- max(latlongyear.u$lon)

minlat
maxlat
minlon
maxlon
summary(latlongyear.u$lon)
```

We need to follow Jim's lead, and use SODA 2.2 for pre 1980, and then SODA 3.3 for post 1980. Unfortunately, they're accessible in different ways. We will start with 1980+

```{terminal import SODA post 1980}
#install nco
conda install -c conda-forge nco
#make text file from https://www.atmos.umd.edu/~ocean/index_files/soda3.3.1_mn_ocean_reg.txt
#add "/ocean"after regrided (error on their part)

wget -i soda3.3.1_mn_ocean_reg_import.txt

```

This takes a while, as it's 100 gb of data and no way to narrow down beforehand as far as I can tell. 
**Downloaded: 36 files, 118G in 46m 13s (43.6 MB/s)**

```{terminal extract just top/bottom layers from 1980 to 2015 for each yearly file}
#bottom
for i in `cat soda3.3.1_mn_ocean_reg_import.txt`;do ncks -d depth,-1 "${i}" "${i%.*}_bottom.nc";done

#surface
for i in `cat soda3.3.1_mn_ocean_reg_import.txt`;do ncks -d depth,1 "${i}" "${i%.*}_surface.nc";done
```

Seeing now that these files in their current state actually contain multiple variables, and I only want one (temp)
```{terminal extracting only temp from 1980 to 2015}
#bottom
for i in `cat soda3.3.1_mn_ocean_reg_import.txt`; do ncks -v temp "${i%.*}_bottom.nc" "${i%.*}_sbt.nc";done
#surface
for i in `cat soda3.3.1_mn_ocean_reg_import.txt`; do ncks -v temp "${i%.*}_surface.nc" "${i%.*}_sst.nc";done
```
Let's now crop down to actual points we need:
24.49008 lat
62.01917 lat
-189.397 lon
-43.835 lon

Interpretted by iridl.ldeo.columbia.edu
24.25N - 62.25N
170.75E(170.75) - 43.75W(-43.75)
```{terminal crop points into box for North America}
#surface
for i in `cat soda3.3.1_mn_ocean_reg_import.txt`; do ncks -O -d latitude,24.25,62.25 -d longitude,170.75,-43.75 "${i%.*}_sst.nc" "${i%.*}_sst.nc";done

#bottom
for i in `cat soda3.3.1_mn_ocean_reg_import.txt`; do ncks -O -d latitude,24.25,62.25 -d longitude,170.75,-43.75 "${i%.*}_sbt.nc" "${i%.*}_sbt.nc";done
```

I will now merge these files along time. DO THIS
```{terminal merge 1980-2015 files for sbt and sst}
ncrcat soda3.3.1*sst.nc -O soda3.3.1_1980_2015_sst.nc
ncrcat soda3.3.1*sst.nc -O soda3.3.1_1980_2015_sbt.nc
```

Change names of dimensions to match earlier time files
```{terminal change names of dimensions and variables for 1980+}
#surface
ncrename -d latitude,lat -v latitude,lat soda3.3.1_1980_2015_sst.nc
ncrename -d longitude,lon -v longitude,lon soda3.3.1_1980_2015_sst.nc
#bottom
ncrename -d latitude,lat -v latitude,lat soda3.3.1_1980_2015_sbt.nc
ncrename -d longitude,lon -v longitude,lon soda3.3.1_1980_2015_sbt.nc
```
*Done with 1980-2015*
**********

Now, we will import netcdf data for pre 1980 from SODA 2.4.

Unfortunately, It looks like I'm going to have to import files one by one for chunks of depth.

I made text file in amphiprion to bulk download `wget -i -O soda2.2.4_mn_ocean_reg.txt --no-check-certificate` DO THIS
file names going in as data.nc.x etc.
5.01-70.02: data.nc
82.92-197.79: data.nc.1
229.48-729.35: data.nc.2
918.37-2375.0: data.nc.3
2625.0-4375.0: data.nc.4
4625.0-5375.0: data.nc.5

```{terminal merge SODA files pre 1980}
#merge all depth chunks
cdo merge data.n* data.pre1980.nc

#only bottom layer
ncks -d depth,-1 data.pre1980.nc soda2.2.4_1953_1979_sbt.nc #NCO ncks with a negative hyperslab

#only surface layer
ncks -d depth,1 data.pre1980.nc soda2.2.4_1953_1979_sst.nc
```

We now have four files we need, but with slightly different coordinates. 
NC file for 1953-1979 bottom temp `soda2.2.4_1953_1979_sbt.nc`
NC file for 1953-1979 surface temp `soda2.2.4_1953_1979_sst.nc`
NC file for 1980-2015 bottom temp `soda3.3.1_1980_2015_sbt.nc`
NC file for 1980-2015 surface temp `soda3.3.1_1980_2015_sst.nc`

************


```{trying to import}
get.soda <- function(file){

	soda.info <- nc_open(file)
	name.soda.sizes <- sapply(soda.info$var$temp$dim, function(x)x$name)
	soda.sizes <- soda.info$var$temp$size
	dim.units <- sapply(soda.info$var$temp$dim, function(x)x$units)
	print(dim.units)
	stopifnot(grepl("months since ", dim.units[4])) # make sure time is in correct units and in right place
	names(soda.sizes) <- name.soda.sizes
	ntime <- soda.sizes["time"]
	ndepth <- soda.sizes["depth"]

	soda.time0 <- soda.info$var$temp$dim[[4]]$vals
	ref.date <- as.Date(gsub("months since ", "", dim.units[4]))
	start.before.ref <- grepl("-", soda.time0[1]) # is the first date before ref.date?
	n.month.before <- ceiling(abs(soda.time0[1])) + as.integer(start.before.ref)
	start.increment <- ifelse(start.before.ref, "-1 month", "1 month")
	time.start <- rev(seq.Date(ref.date, by=start.increment, length.out=n.month.before))[1]
	soda.time <- seq.Date(time.start, by="1 month", length.out=ntime)
	
	soda <- brick(file)
	names(soda) <- soda.time

		
	return(soda)
}

soda_pre1980 <- get.soda(data.nc)

	
```

I didn't use this link, but it appears to be helpful. [ERDAPP](https://coastwatch.pfeg.noaa.gov/erddap/griddap/erdSoda331oceanmday.html).
