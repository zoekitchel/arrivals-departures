---
title: "Colonization and Extinction Final Models"
output: html_notebook
---

This is a cleaned version of 04_24_19 Temp link trait fish.Rmd/11_20_19_Temp_link_traits_fish.Rmd.
Changes
* improved formatting
* easier to follow
* species and region as random effects
* scaling temperature values
* setting nACQ to 0, see why [here](https://stats.stackexchange.com/questions/77313/why-cant-i-match-glmer-family-binomial-output-with-manual-implementation-of-g). 

```{r setup}
library(MuMIn)
library(lme4)
library(data.table)
library(ggplot2)

load("spp_master_ztemp_seus_buoys.RData")
```

Running, and ranking colonization models without traits

##Here, I scaled all temperature values across all regions, and included species as a random effect. In order to do this, I had to change the algorithm slightly--nAGQ = 0.

```{r colonization models without traits}

#extract just temperature variables to scale
spp_master_ztemp_seus_buoy_varsonly <- spp_master_ztemp_seus_buoy[,c(1,45:292)]

#names of temp variables, so I can add "_scaled" suffix
tempvars <- colnames(spp_master_ztemp_seus_buoy[,45:292])

#scale all variables, make new columns, do this by region
spp_master_ztemp_seus_buoy_varsonly[, paste0(tempvars, "_scaled") := lapply(.SD, function(x) as.vector(scale(x))), .SDcols = tempvars]


#names of scaled columns
scaled_cols <- grep("*_scaled", names(spp_master_ztemp_seus_buoy_varsonly), value = T)

#merge new columns back with spp_master_ztemp_seus_buoy
spp_master_ztemp_seus_buoy_scaled <- cbind(spp_master_ztemp_seus_buoy, spp_master_ztemp_seus_buoy_varsonly[,scaled_cols, with = FALSE])

save(spp_master_ztemp_seus_buoy_scaled, file = "spp_master_ztemp_seus_buoy_scaled.RData")

#going to make loop to make all models I need to look at with single variables
variables_scaled <- colnames(spp_master_ztemp_seus_buoy_scaled[,scaled_cols, with = FALSE])

colonization_model_comparison_spprandom_scaled_seus_update <- as.data.table(matrix(nrow = length(variables_scaled)))
colonization_model_comparison_spprandom_scaled_seus_update[, variable:=as.factor(V1)][, coef:=as.numeric(V1)][, p_value:=as.numeric(V1)][, AICc:=as.numeric(V1)]
colonization_model_comparison_spprandom_scaled_seus_update[, V1 := NULL]

for (i in 1:length(variables_scaled)){
  mod <- glmer(col ~ get(variables_scaled[i]) + (1|reg) + (1|spp), family = binomial, data = spp_master_ztemp_seus_buoy_scaled, nAGQ = 0)
  colonization_model_comparison_spprandom_scaled_seus_update[i,variable := variables_scaled[i]]
  colonization_model_comparison_spprandom_scaled_seus_update[i,coef := coef(summary(mod))[,"Estimate"][2]]
  colonization_model_comparison_spprandom_scaled_seus_update[i,p_value := coef(summary(mod))[,"Pr(>|z|)"][2]]
  colonization_model_comparison_spprandom_scaled_seus_update[i,AICc := AICc(mod)]
  
  print(paste(i, length(variables_scaled), sep = "/"))
    
}

#by setting nACQ to 0, all models converged

```

Extinction Models without Traits
```{r extinction models without traits}
#see setup above

extinction_model_comparison_spprandom_scaled_seus_update <- as.data.table(matrix(nrow = length(variables_scaled)))
extinction_model_comparison_spprandom_scaled_seus_update[, variable:=as.factor(V1)][, coef:=as.numeric(V1)][, p_value:=as.numeric(V1)][, AICc:=as.numeric(V1)]
extinction_model_comparison_spprandom_scaled_seus_update[, V1 := NULL]

for (i in 1:length(variables_scaled)){
  mod <- glmer(now_ext ~ get(variables_scaled[i]) + (1|reg) + (1|spp), family = binomial, data = spp_master_ztemp_seus_buoy_scaled, nAGQ = 0)
  extinction_model_comparison_spprandom_scaled_seus_update[i,variable := variables_scaled[i]]
  extinction_model_comparison_spprandom_scaled_seus_update[i,coef := coef(summary(mod))[,"Estimate"][2]]
  extinction_model_comparison_spprandom_scaled_seus_update[i,p_value := coef(summary(mod))[,"Pr(>|z|)"][2]]
  extinction_model_comparison_spprandom_scaled_seus_update[i,AICc := AICc(mod)]
  
  print(paste(i, length(variables_scaled), sep = "/"))
    
}

#by setting nACQ to 0, all models converged



```

Relative Variable Importance
```{r get rid of any models using mean}
colonization_model_comparison_spprandom_scaled_seus_update_nomean <- colonization_model_comparison_spprandom_scaled_seus_update[!grepl("mean",variable),]

colnames(colonization_model_comparison_spprandom_scaled_seus_update_nomean)

extinction_model_comparison_spprandom_scaled_seus_update_nomean <- extinction_model_comparison_spprandom_scaled_seus_update[!grepl("mean",variable),]


```
What about null models?
```{r null models}
#add null to tables
interceptcolmod_scaled <- glmer(col ~ (1|spp) + (1|reg), family = binomial, nAGQ = 0, data = spp_master_ztemp_seus_buoy_scaled)

interceptextmod_scaled <- glmer(now_ext ~ (1|reg) + (1|spp), family = binomial, data = spp_master_ztemp_seus_buoy_scaled, nAGQ = 0)


AICc(interceptcolmod_scaled)-min(colonization_model_comparison_spprandom_scaled_seus_update_nomean$AICc)
AICc(interceptextmod_scaled)-min(extinction_model_comparison_spprandom_scaled_seus_update_nomean$AICc)


```


Relative Variable Importance for Colonization Models
```{r RVI colonization}
#add ∆AIC to tables
min_col_AICc <- min(colonization_model_comparison_spprandom_scaled_seus_update_nomean[, AICc])
colonization_model_comparison_spprandom_scaled_seus_update_nomean[,"deltaAICc" := (AICc - min_col_AICc)]

#add relative likelihood exp( -0.5 * ∆AIC score for that model)
colonization_model_comparison_spprandom_scaled_seus_update_nomean[,"rel_likelihood" := exp((-0.5 * deltaAICc))]
#sum relative likelihoods across all models
colonization_model_comparison_spprandom_scaled_seus_update_nomean.likelihoodsum <- sum(colonization_model_comparison_spprandom_scaled_seus_update_nomean[, rel_likelihood])
#Akaike weight for a model is this rel_likelihood devided by the sum of these values across all models
colonization_model_comparison_spprandom_scaled_seus_update_nomean[,"akaike_weight" := rel_likelihood/colonization_model_comparison_spprandom_scaled_seus_update_nomean.likelihoodsum]

#I want to look at relative importance FOR 
#bottom/surface (bottom = includes sbt, grepl("sbt", variable))
col_bottom_importance <- sum(colonization_model_comparison_spprandom_scaled_seus_update_nomean[grep("sbt", variable), ]$akaike_weight)
col_surface_importance <- sum(colonization_model_comparison_spprandom_scaled_seus_update_nomean[grep("sst", variable), ]$akaike_weight)

#lag/not lagged (grepl("lag", variable))
col_lag_importance <- sum(colonization_model_comparison_spprandom_scaled_seus_update_nomean[grep("lag", variable), ]$akaike_weight)
col_nolag_importance <- sum(colonization_model_comparison_spprandom_scaled_seus_update_nomean[!grep("lag", variable), ]$akaike_weight)

#absolute (grepl("abs", variable))
col_abs_importance <- sum(colonization_model_comparison_spprandom_scaled_seus_update_nomean[grep("abs", variable), ]$akaike_weight)

#raw (!grepl("change"))
col_raw_importance <- sum(colonization_model_comparison_spprandom_scaled_seus_update_nomean[!grep("change", variable), ]$akaike_weight)

#change (grepl("change", variable), (!grepl("abs")))
col_change_importance <- sum(colonization_model_comparison_spprandom_scaled_seus_update_nomean[grep("change", variable), ][!grep("abs", variable),]$akaike_weight)

#type of temp variable (max, min, seas)
col_max_temp_importance <- sum(colonization_model_comparison_spprandom_scaled_seus_update_nomean[grep("max", variable), ]$akaike_weight)
col_min_temp_importance <- sum(colonization_model_comparison_spprandom_scaled_seus_update_nomean[grep("min", variable), ]$akaike_weight)
col_seas_temp_importance <- sum(colonization_model_comparison_spprandom_scaled_seus_update_nomean[grep("seas", variable), ]$akaike_weight)

save(colonization_model_comparison_spprandom_scaled_seus_update_nomean, file = "colonization_model_comparison_spprandom_scaled_seus_update_nomean.RData")

```

Relative Variable Importance for Extinction Models
```{r RVI extinction}
load("colonization_model_comparison_spprandom_scaled_seus_update_nomean.RData")
#add ∆AIC to tables
min_ext_AICc <- min(extinction_model_comparison_spprandom_scaled_seus_update_nomean[, AICc])
extinction_model_comparison_spprandom_scaled_seus_update_nomean[,"deltaAICc" := (AICc - min_ext_AICc)]

#add relative likelihood exp( -0.5 * ∆AIC score for that model)
extinction_model_comparison_spprandom_scaled_seus_update_nomean[,"rel_likelihood" := exp((-0.5 * deltaAICc))]
#sum relative likelihoods across all models
extinction_model_comparison_spprandom_scaled_seus_update_nomean.likelihoodsum <- sum(extinction_model_comparison_spprandom_scaled_seus_update_nomean[, rel_likelihood])
#Akaike weight for a model is this rel_likelihood devided by the sum of these values across all models
extinction_model_comparison_spprandom_scaled_seus_update_nomean[,"akaike_weight" := rel_likelihood/extinction_model_comparison_spprandom_scaled_seus_update_nomean.likelihoodsum]

#I want to look at relative importance FOR 
#bottom/surface (bottom = includes sbt, grepl("sbt", variable))
ext_bottom_importance <- sum(extinction_model_comparison_spprandom_scaled_seus_update_nomean[grep("sbt", variable), ]$akaike_weight)
ext_surface_importance <- sum(extinction_model_comparison_spprandom_scaled_seus_update_nomean[grep("sst", variable), ]$akaike_weight)

#lag/not lagged (grepl("lag", variable))
ext_lag_importance <- sum(extinction_model_comparison_spprandom_scaled_seus_update_nomean[grep("lag", variable), ]$akaike_weight)
ext_nolag_importance <- sum(extinction_model_comparison_spprandom_scaled_seus_update_nomean[!grep("lag", variable), ]$akaike_weight)

#absolute (grepl("abs", variable))
ext_abs_importance <- sum(extinction_model_comparison_spprandom_scaled_seus_update_nomean[grep("abs", variable), ]$akaike_weight)

#raw (!grepl("change"))
ext_raw_importance <- sum(extinction_model_comparison_spprandom_scaled_seus_update_nomean[!grep("change", variable), ]$akaike_weight)

#change (grepl("change", variable), (!grepl("abs")))
ext_change_importance <- sum(extinction_model_comparison_spprandom_scaled_seus_update_nomean[grep("change", variable), ][!grep("abs", variable),]$akaike_weight)

#type of temp variable (max, min, seas)
ext_max_temp_importance <- sum(extinction_model_comparison_spprandom_scaled_seus_update_nomean[grep("max", variable), ]$akaike_weight)
ext_min_temp_importance <- sum(extinction_model_comparison_spprandom_scaled_seus_update_nomean[grep("min", variable), ]$akaike_weight)
ext_seas_temp_importance <- sum(extinction_model_comparison_spprandom_scaled_seus_update_nomean[grep("seas", variable), ]$akaike_weight)

save(extinction_model_comparison_spprandom_scaled_seus_update_nomean, file = "extinction_model_comparison_spprandom_scaled_seus_update_nomean.RData")
```

Let's see how the RVI importance varies by looking at specific lag values
```{r make a plot here for variability across lag values}
load("extinction_model_comparison_spprandom_scaled_seus_update_nomean.RData")
#first, table for lags
lags_v_RVI_spprandom_scaled <- data.table(col_lag = c(0:9), col_RVI = 0, ext_RVI = 0)
#colonization
lags_v_RVI_spprandom_scaled[1,2] <- 1-sum(colonization_model_comparison_spprandom_scaled_seus_update_nomean[grep("lag", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled[2,2] <- sum(colonization_model_comparison_spprandom_scaled_seus_update_nomean[grep("lag1", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled[3,2] <- sum(colonization_model_comparison_spprandom_scaled_seus_update_nomean[grep("lag2", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled[4,2] <- sum(colonization_model_comparison_spprandom_scaled_seus_update_nomean[grep("lag3", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled[5,2] <- sum(colonization_model_comparison_spprandom_scaled_seus_update_nomean[grep("lag4", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled[6,2] <- sum(colonization_model_comparison_spprandom_scaled_seus_update_nomean[grep("lag5", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled[7,2] <- sum(colonization_model_comparison_spprandom_scaled_seus_update_nomean[grep("lag6", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled[8,2] <- sum(colonization_model_comparison_spprandom_scaled_seus_update_nomean[grep("lag7", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled[9,2] <- sum(colonization_model_comparison_spprandom_scaled_seus_update_nomean[grep("lag8", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled[10,2] <- sum(colonization_model_comparison_spprandom_scaled_seus_update_nomean[grep("lag9", variable), ]$akaike_weight)
#extinction
lags_v_RVI_spprandom_scaled[1,3] <- 1-sum(extinction_model_comparison_spprandom_scaled_seus_update_nomean[grep("lag", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled[2,3] <- sum(extinction_model_comparison_spprandom_scaled_seus_update_nomean[grep("lag1", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled[3,3] <- sum(extinction_model_comparison_spprandom_scaled_seus_update_nomean[grep("lag2", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled[4,3] <- sum(extinction_model_comparison_spprandom_scaled_seus_update_nomean[grep("lag3", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled[5,3] <- sum(extinction_model_comparison_spprandom_scaled_seus_update_nomean[grep("lag4", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled[6,3] <- sum(extinction_model_comparison_spprandom_scaled_seus_update_nomean[grep("lag5", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled[7,3] <- sum(extinction_model_comparison_spprandom_scaled_seus_update_nomean[grep("lag6", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled[8,3] <- sum(extinction_model_comparison_spprandom_scaled_seus_update_nomean[grep("lag7", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled[9,3] <- sum(extinction_model_comparison_spprandom_scaled_seus_update_nomean[grep("lag8", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled[10,3] <- sum(extinction_model_comparison_spprandom_scaled_seus_update_nomean[grep("lag9", variable), ]$akaike_weight)

ggplot(data = lags_v_RVI_spprandom_scaled, aes(x = col_lag)) +
  geom_line(aes(y = col_RVI), ) +
  geom_line(aes(y = ext_RVI), linetype = "dashed") +
  labs(x = "Lag", y = "Relative Variable Importance") +
  scale_color_discrete() + #how to make a legend
  theme_classic() +
  theme(text = element_text(size = 20)) +
  scale_x_continuous(breaks = c(0:9))

ggsave(file = "RVI_lags_scaled.jpeg")
ggsave(file = "RVI_lags_scaled.eps")
```

Table for RVI data for Colonization
```{r put RVIs for colonization into data table}
col_ext <- c("col","col","col","col","col", "col","col", "col", "col","col")
type <- c("Depth", "Depth", "lag", "lag", "Transformation", "Transformation", "Transformation", "Metric", "Metric", "Metric")
variable <- c("Bottom", "Surface", "no_lag", "lagged", "|Change|", "Change", "Raw", "Min", "Max", "Seas")
value <- c(col_bottom_importance, col_surface_importance, col_nolag_importance, col_lag_importance, col_abs_importance, col_change_importance, col_raw_importance, col_min_temp_importance, col_max_temp_importance, col_seas_temp_importance)

RVI_col <- data.table(col_ext, type, variable, value)
```

Table for RVI data for Extinction
```{r put RVIs for extinction into data table}
col_ext <- c("ext","ext","ext","ext","ext", "ext", "ext", "ext", "ext", "ext")
type <- c("Depth", "Depth", "lag", "lag", "Transformation", "Transformation", "Transformation", "Metric", "Metric", "Metric")
variable <- c("Bottom", "Surface", "no_lag", "lagged", "|Change|", "Change", "Raw", "Min", "Max", "Seas")
value <- c(ext_bottom_importance, ext_surface_importance, ext_nolag_importance, ext_lag_importance, ext_abs_importance, ext_change_importance, ext_raw_importance, ext_min_temp_importance, ext_max_temp_importance, ext_seas_temp_importance)

RVI_ext <- data.table(col_ext, type, variable, value)
```

Merge RVI tables for colonization and extinction, and then graph
```{r merge RVI tables and plot}
RVI_table <- as.data.table(rbind(RVI_col, RVI_ext)) #bind RVI for colonizations and extinctions

RVI_table.r <- RVI_table[!grep("Surface", variable)][!grep("lagged", variable)]

#change order of factor levels
RVI_table.r[, variable := factor(variable, levels = c("Bottom", "no_lag", "Raw", "Change", "|Change|", "Min", "Max", "Seas"))]

save(RVI_table, file = "RVI_table.Rdata")

ggplot(data = RVI_table.r, aes(x=variable, y = value, fill = col_ext)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_x_discrete(breaks = c("Bottom", "no_lag", "Raw", "Change", "|Change|", "Min", "Max", "Seas"), 
                   labels = c("Bottom Temp", "No Lag", "Raw Temp", "Change in \nTemp", "| Change in\n Temp |", "Min Temp", "Max Temp", "Seas")) +
  labs(x = "Temperature Variables", y = "Relative Variable Importance")  +
  theme_bw()

```

Another way to visualize is stacked bar plot.

```{r RVI stacked plot}
#put levels into correct order for viewing, and add dummy level for legend
RVI_col[, variable := factor(variable, levels = c("Bottom", "Surface","  ", "Raw", "Change", "|Change|", "no_lag", "lagged", "Min", "Max", "Seas"))]
RVI_col[, type := factor(type, levels = c("Depth", "Transformation", "Metric", "lag"))]

RVI_col_nolag <- RVI_col[type != "lag",]
RVI_col_nolag[, type := factor(type, levels = c("Depth", "Transformation", "Metric"))][, variable := factor(variable, levels = c("Bottom", "Surface","  ", "Raw", "Change", "|Change|", "Min", "Max", "Seas"))]

#and again for extinction
RVI_ext[, variable := factor(variable, levels = c("Bottom", "Surface","  ", "Raw", "Change", "|Change|", "no_lag", "lagged", "Min", "Max", "Seas"))]
RVI_ext[, type := factor(type, levels = c("Depth", "Transformation", "Metric", "lag"))]

RVI_ext_nolag <- RVI_ext[type != "lag",]
RVI_ext_nolag[, type := factor(type, levels = c("Depth", "Transformation", "Metric"))][, variable := factor(variable, levels = c("Bottom", "Surface","  ", "Raw", "Change", "|Change|", "Min", "Max", "Seas"))]



library(wesanderson)
pal <- wes_palette("GrandBudapest1", 8, type = "continuous")
colors <- c(pal[1], pal[2], "#FFFFFF", pal[3], pal[4], pal[5], pal[6], pal[7], pal[8])

#colonization
RVI_col_plot <- ggplot(data = RVI_col_nolag, aes(x=type, y = value, fill = variable)) +
  geom_bar(stat="identity", color = "black", size = 0, width = 0.8) +
  scale_x_discrete(breaks = c("Transformation", "Depth", "Metric"), labels = c("Transformation", "Depth", "Metric")) +
  labs(x = "Temperature Variables", y = "Relative Variable Importance") +
  theme_classic() +
  theme(text = element_text(size = 11.5), 
        legend.position = "top", 
        legend.title = element_blank(), 
        legend.spacing.x = unit(0.2, 'cm'),
        legend.justification = "center",
        aspect.ratio = (1),
        #, legend.position = "none"
        ) +
  guides(fill=guide_legend(ncol=3)) +
  scale_fill_manual(values = colors,
                    breaks = levels(RVI_col$variable),
                    labels = levels(RVI_col$variable),
                    drop = F)

#extinction
RVI_ext_plot <- ggplot(data = RVI_ext_nolag, aes(x=type, y = value, fill = variable)) +
  geom_bar(stat="identity", color = "black", size = 0, width = 0.8) +
  scale_x_discrete(breaks = c("Transformation", "Depth", "Metric"), labels = c("Transformation", "Depth", "Metric")) +
  labs(x = "Temperature Variables", y = "Relative Variable Importance") +
  theme_classic() +
  theme(text = element_text(size = 11.5), 
        legend.position = "top", 
        legend.title = element_blank(), 
        legend.spacing.x = unit(0.2, 'cm'),
        legend.justification = "center",
        aspect.ratio = (1),
        #, legend.position = "none"
        ) +
  guides(fill=guide_legend(ncol=3)) +
  scale_fill_manual(values = colors,
                    breaks = levels(RVI_col$variable),
                    labels = levels(RVI_col$variable),
                    drop = F)

RVI_table
RVI_col_plot
RVI_ext_plot
```

***********
How well do these models actually predict the # of colonizations and the # of extinctions?

```{r predicted vs. observed colonizations scaled}

library(tidyr)
library(plyr)
#best colonization models (all delta less than 2)
  #seas_sst_temp_scaled
  #max_sst_temp_change_abs_lag1_scaled



bestcolmod_scaled <- glmer(col ~ seas_sst_temp_scaled + (1|reg) + (1|spp), family = binomial, data = spp_master_ztemp_seus_buoy_scaled, nAGQ = 0)

interceptcolmod_scaled <- glmer(col ~ (1|reg) + (1|spp), family = binomial, data = spp_master_ztemp_seus_buoy_scaled, nAGQ = 0)


#I wanted predicted # of colonizations in each region per region/year
#year region observed colonizations predicted colonizations

#plotting predicted versus modeled
#unique combinations of spp, region, and max_sbt_temp_change_abs_scaled found in dataset
model_imputs <- spp_master_ztemp_seus_buoy_scaled[,c("spp", "reg", "year", "col", "now_ext", "seas_sst_temp_scaled")]

t2_col <- predict(bestcolmod_scaled, newdata = model_imputs, type = "response", re.form = NULL) #setting re.form to NULL includes all random effects

t2_col_null <- predict(interceptcolmod_scaled, newdata = model_imputs, type = "response", re.form = NULL) #setting re.form to NULL includes all random effects

model_imputs$pred <- t2_col
model_imputs$pred_null <- t2_col_null

#group by region and year, sum over "col" = observations, and "pred" = predict colonizations by summing probabilities
col_model_comparisons <- model_imputs[, .(col_predicted = sum(pred), col_predicted_null = sum(pred_null), col_observed = sum(col)), by=.(year,reg)]


ggplot(aes(x=year), data = col_model_comparisons) +
  geom_point(aes(y = col_observed), data = col_model_comparisons, col = "red") +
  geom_point(data = col_model_comparisons, aes(y = col_predicted), col = "black") +
#  geom_point(data = col_model_comparisons, aes(y = col_predicted_null), col = "blue") +
  facet_wrap(~reg) +
  theme_classic()



```

Instead, I want to look at these with accumulation of colonizations
```{r plot colonization with cumulative sum of extinctions}

col_model_comparisons[,col_obs_sum := cumsum(col_observed), by = reg]
col_model_comparisons[,col_pred_sum := cumsum(col_predicted), by = reg]
col_model_comparisons[,col_pred_sum_null := cumsum(col_predicted_null), by = reg]

ggplot(aes(x=year), data = col_model_comparisons) +
  geom_point(aes(y = col_obs_sum), data = col_model_comparisons, col = "red") +
  geom_point(data = col_model_comparisons, aes(y = col_pred_sum), col = "black", size = 1) +
  geom_point(data = col_model_comparisons, aes(y = col_pred_sum_null), col = "blue", size = 1) +
  labs(x="Year", y = "Cumulative sum of colonizations") +
  facet_wrap(~reg) +
  theme_classic()


```



```{r extinction predictions versus observed scaled}

#best extinction model (all delta less than 2)
  #seas_sst_temp_lag3_scaled
  #min_sst_temp_change_lag2_scaled


bestextmod_scaled <- glmer(now_ext ~ seas_sst_temp_lag3_scaled + (1|reg) + (1|spp), family = binomial, data = spp_master_ztemp_seus_buoy_scaled, nAGQ = 0)

interceptextmod_scaled <- glmer(now_ext ~ (1|reg) + (1|spp), family = binomial, data = spp_master_ztemp_seus_buoy_scaled, nAGQ = 0)

#I wanted predicted # of colonizations in each region per region/year
#year region observed colonizations predicted colonizations

#plotting predicted versus modeled
#unique combinations of spp, region, and max_sbt_temp_change_abs_scaled found in dataset
model_imputs <- spp_master_ztemp_seus_buoy_scaled[,c("spp", "reg", "year", "col", "now_ext", "seas_sst_temp_lag3_scaled")]

t2_ext <- predict(bestextmod_scaled, newdata = model_imputs, type = "response", re.form = NULL) #setting re.form to NULL includes all random effects
t2_ext_null <- predict(interceptextmod_scaled, newdata = model_imputs, type = "response", re.form = NULL) #setting re.form to NULL includes all random effects

model_imputs$pred <- t2_ext
model_imputs$pred_null <- t2_ext_null

#group by region and year, sum over "ext" = observations, and "pred" = predict colonizations by summing probabilities
ext_model_comparisons <- model_imputs[, .(ext_predicted = sum(pred), ext_predicted_null = sum(pred_null), ext_observed = sum(now_ext)), by=.(year,reg)]


ggplot(aes(x=year), data = ext_model_comparisons) +
  geom_point(aes(y = ext_observed), data = ext_model_comparisons, col = "red") +
  geom_point(data = ext_model_comparisons, aes(y = ext_predicted), col = "black") +
  geom_point(data = ext_model_comparisons, aes(y=ext_predicted_null), col = "blue") +
  facet_wrap(~reg) +
  theme_classic()
```

Instead, I want to look at these with accumulation of extinctions
```{r plot extinction with cumulative sum of extinctions}

ext_model_comparisons[,ext_obs_sum := cumsum(ext_observed), by = reg]
ext_model_comparisons[,ext_pred_sum := cumsum(ext_predicted), by = reg]
ext_model_comparisons[,ext_pred_sum_null := cumsum(ext_predicted_null), by = reg]

ggplot(aes(x=year), data = ext_model_comparisons) +
  geom_point(aes(y = ext_obs_sum), data = ext_model_comparisons, col = "red") +
  geom_point(data = ext_model_comparisons, aes(y = ext_pred_sum), col = "black", size = 1) +
  geom_point(data = ext_model_comparisons, aes(y = ext_pred_sum_null), col = "blue", size = 0.5) +
  labs(x="Year", y = "Cumulative sum of extinctions") +
  facet_wrap(~reg) +
  theme_classic()


```

Cumulative species richness change
```{r cumulative species richness change}
#from colonizations
cumulative_richness <- col_model_comparisons[,.(reg, year, col_obs_sum, col_pred_sum, col_pred_sum_null)]
ext_obs_sum <- ext_model_comparisons[,.(ext_obs_sum)]
ext_pred_sum <- ext_model_comparisons[,.(ext_pred_sum)]
ext_pred_sum_null <- ext_model_comparisons[,.(ext_pred_sum_null)]
cumulative_richness[,ext_obs_sum := ext_obs_sum]
cumulative_richness[,ext_pred_sum := ext_pred_sum]
cumulative_richness[,ext_pred_sum_null := ext_pred_sum_null]

cumulative_richness[, Observed := col_obs_sum-ext_obs_sum][, Predicted := col_pred_sum-ext_pred_sum][, Predicted_null := col_pred_sum_null - ext_pred_sum_null]

cumulative_richness.r <- cumulative_richness[,.(reg, year, Observed, Predicted, Predicted_null)]

#wide to long
cumulative_richness.r <- melt(cumulative_richness.r, id.vars = c("reg", "year"), measure.vars = c("Observed", "Predicted", "Predicted_null"), variable.name = "Richness", value.name = "value")



#rename region levels for plotting
levels(cumulative_richness.r$reg) <- c("Aleutian Islands", "E. Bering Sea", "Gulf of Mexico", "Gulf of Alaska", "Northeast US", "Newfoundland", "Southeast US", "Scotian Shelf", "West Coast US")

#plot richness over time predicted versus observed
cum_richness_plot <- ggplot(aes(x=year, y = value, color = Richness, shape = Richness), data = cumulative_richness.r) +
  geom_point(size = 2) +
  geom_hline(yintercept = 0) +
  labs(x="Year", y = "Cumulative Richness") +
  facet_wrap(~reg, scales = "free_y") +
  theme_classic() +
  scale_color_manual(values = c("Observed" = 'coral3' , "Predicted" = 'deepskyblue4', "Predicted_null" = 'black')) +
  scale_shape_manual(values = c("Observed" = 19 , "Predicted" = 19, "Predicted_null" = 20)) +
  theme(plot.title = element_text(size = 17),
        legend.title = element_text(size = 17),
        legend.text=element_text(size = 15),
        strip.text = element_text(size = 12),
        axis.title = element_text(size = 14))

cum_richness_plot

ggsave(cum_richness_plot, file = "cum_richness_plot.jpg")
ggsave(cum_richness_plot, file = "cum_richness_plot.eps")

?ggsave
```

Another plot looking only at observed cumulative richness, and NOT predicted richness. 
```{r cum richness observed alone}
library(dplyr)

#pull col/ext from spp master
spp_master_ztemp_seus_buoy.r <- spp_master_ztemp_seus_buoy[,.(col_count = sum(col, na.rm = T), ext_count = sum(now_ext, na.rm = T), observations = .N), by = .(reg, year)][, richness_yearly := col_count-ext_count][ ,cumulative_richness := cumsum(richness_yearly), by = .(reg)]

levels(spp_master_ztemp_seus_buoy.r[,reg])

#rename levels for plotting and linking to hauls
setattr(spp_master_ztemp_seus_buoy.r[["reg"]],"levels",c("Aleutian Islands", "E. Bering Sea", "Gulf of Mexico", "Gulf of Alaska", "Northeast US", "Newfoundland", "Southeast US", "Scotian Shelf", "West Coast US"))



#plot 
cum_richness_plot <- ggplot(aes(x=year), data = spp_master_ztemp_seus_buoy.r) +
  geom_point(aes(y = cumulative_richness), pch = 20) +
  geom_hline(yintercept = 0) +
  labs(x="Year", y = "Cumulative Richness") +
  facet_wrap(~reg, scales = c("free"))+
  theme_classic()
  
cum_richness_plot


```

```{r observations per region}
region_observations <- spp_master_ztemp_seus_buoy.r[,.(obs_yearly = mean(observations)), by = .(reg)]
reg_obs_plot <- ggplot(data = region_observations, aes(x = reg, y = obs_yearly)) +
  geom_bar(stat = "identity", width = 0.9, color = "black", fill = "black") +
  ylab("Species in Region") +
  xlab("Region") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90))

library(gridExtra)
grid.arrange(cum_richness_plot, reg_obs_plot, ncol = 1, nrow = 2, heights =  c(3/5,2/5))

ggsave(width = 10, height = 8, file = "cumrichnessplot.jpg")

```




In response to plots above, Malin: "Perhaps worth one more set of plots to understand what’s going on: each point would be a year, x-axis would be observed change in richness, y-axis would be predicted change in richness. One set of plots for each of the three models (null, temp, temp+trait), each sub-plot would be a region, as you have here."

```{r observed versus predicted change in richness}
setkey(cumulative_richness.r, Richness, reg, year)
cumulative_richness.r[, delta_value := value-shift(value), by = .(reg, Richness)]

#have to cast to wide to make x = observed change and y = predicted change
cumulative_richness.r.w <- dcast(cumulative_richness.r, reg + year ~ Richness, value.var = "delta_value")

```

```{r plotting observed versus predicted change in richness}

#plot richness over time predicted null versus observed
delta_richness_plot_null <- ggplot(data = cumulative_richness.r.w, aes(x = Observed, y = Predicted_null)) +
  geom_point() +
  labs(x="Observed Change\nin Richness", y = "Predicted Change in\nRichness (Null Model)") +
  facet_wrap(~reg) +
  theme_classic() +
  geom_abline(intercept = 0, slope = 1, color = "grey", linetype = "dashed") +
  theme(plot.title = element_text(size = 17),
        legend.title = element_text(size = 17),
        legend.text=element_text(size = 15),
        strip.text = element_text(size = 12),
        axis.title = element_text(size = 14))

delta_richness_plot_null

#plot richness over time predicted versus observed
delta_richness_plot <- ggplot(data = cumulative_richness.r.w, aes(x = Observed, y = Predicted)) +
  geom_point() +
  labs(x="Observed Change\nin Richness", y = "Predicted Change in\nRichness (Temperature Model)") +
  facet_wrap(~reg) +
  theme_classic() +
  geom_abline(intercept = 0, slope = 1, color = "grey", linetype = "dashed") +
  theme(plot.title = element_text(size = 17),
        legend.title = element_text(size = 17),
        legend.text=element_text(size = 15),
        strip.text = element_text(size = 12),
        axis.title = element_text(size = 14))

delta_richness_plot

ggsave(delta_richness_plot_null, file = "delta_richness_plot_null.jpg")
ggsave(delta_richness_plot, file = "delta_richness_plot.jpg")


```


***********
#Here, I do the same thing, but only include spp as random effect and reset model algorithm. I do NOT scale temperature values. 

Running, and ranking colonization models without traits

```{r colonization models with 1|spp but not scaled without traits}

#going to make loop to make all models I need to look at with single variables
variables <- grep("_s.t_", names(spp_master_ztemp_seus_buoy), value = T)

colonization_model_comparison_spprandom <- as.data.table(matrix(nrow = length(variables)))
colonization_model_comparison_spprandom[, variable:=as.factor(V1)][, coef:=as.numeric(V1)][, p_value:=as.numeric(V1)][, AICc:=as.numeric(V1)]
colonization_model_comparison_spprandom[, V1 := NULL]

for (i in 1:length(variables)){
  mod <- glmer(col ~ get(variables[i]) + (1|reg) + (1|spp), family = binomial, data = spp_master_ztemp_seus_buoy, nAGQ = 0)
  colonization_model_comparison_spprandom[i,variable := variables[i]]
  colonization_model_comparison_spprandom[i,coef := coef(summary(mod))[,"Estimate"][2]]
  colonization_model_comparison_spprandom[i,p_value := coef(summary(mod))[,"Pr(>|z|)"][2]]
  colonization_model_comparison_spprandom[i,AICc := AICc(mod)]
  
  print(paste(i, length(variables), sep = "/"))
    
}

#by setting nACQ to 0, all models converged


col_mod_null <- glmer(col ~ (1|reg) + (1|spp), family = binomial, data = spp_master_ztemp_seus_buoy, nAGQ = 0)
AICc(col_mod_null)-min(colonization_model_comparison_spprandom$AICc)
```
Extinction Models without Traits, NOT scaled
```{r extinction models without traits not scaled}
#see setup above

extinction_model_comparison_spprandom <- as.data.table(matrix(nrow = length(variables)))
extinction_model_comparison_spprandom[, variable:=as.factor(V1)][, coef:=as.numeric(V1)][, p_value:=as.numeric(V1)][, AICc:=as.numeric(V1)]
extinction_model_comparison_spprandom[, V1 := NULL]

for (i in 1:length(variables)){
  mod <- glmer(now_ext ~ get(variables[i]) + (1|reg) + (1|spp), family = binomial, data = spp_master_ztemp_seus_buoy, nAGQ = 0)
  extinction_model_comparison_spprandom[i,variable := variables[i]]
  extinction_model_comparison_spprandom[i,coef := coef(summary(mod))[,"Estimate"][2]]
  extinction_model_comparison_spprandom[i,p_value := coef(summary(mod))[,"Pr(>|z|)"][2]]
  extinction_model_comparison_spprandom[i,AICc := AICc(mod)]
  
  print(paste(i, length(variables), sep = "/"))
    
}

#by setting nACQ to 0, all models converged


```
Relative Variable Importance
```{r get rid of any models using mean not scaled}
colonization_model_comparison_spprandom_nomean <- colonization_model_comparison_spprandom[!grepl("mean",variable),]

extinction_model_comparison_spprandom_nomean <- extinction_model_comparison_spprandom[!grepl("mean",variable),]

#comparison to null
col_mod_null <- glmer(col ~ (1|reg) + (1|spp), family = binomial, data = spp_master_ztemp_seus_buoy, nAGQ = 0)
AICc(col_mod_null)-min(colonization_model_comparison_spprandom$AICc)

ext_mod_null <- glmer(ext ~ (1|reg) + (1|spp), family = binomial, data = spp_master_ztemp_seus_buoy, nAGQ = 0)
AICc(ext_mod_null)-min(extinction_model_comparison_spprandom$AICc)
```

Relative Variable Importance for Colonization Models
```{r RVI colonization not scaled, but with 1|spp}
#add ∆AIC to tables
min_col_AICc <- min(colonization_model_comparison_spprandom_nomean[, AICc])
colonization_model_comparison_spprandom_nomean[,"deltaAICc" := (AICc - min_col_AICc)]

#add relative likelihood exp( -0.5 * ∆AIC score for that model)
colonization_model_comparison_spprandom_nomean[,"rel_likelihood" := exp((-0.5 * deltaAICc))]
#sum relative likelihoods across all models
colonization_model_comparison_spprandom_nomean.likelihoodsum <- sum(colonization_model_comparison_spprandom_nomean[, rel_likelihood])
#Akaike weight for a model is this rel_likelihood devided by the sum of these values across all models
colonization_model_comparison_spprandom_nomean[,"akaike_weight" := rel_likelihood/colonization_model_comparison_spprandom_nomean.likelihoodsum]

#I want to look at relative importance FOR 
#bottom/surface (bottom = includes sbt, grepl("sbt", variable))
col_bottom_importance <- sum(colonization_model_comparison_spprandom_nomean[grep("sbt", variable), ]$akaike_weight)
col_surface_importance <- sum(colonization_model_comparison_spprandom_nomean[grep("sst", variable), ]$akaike_weight)

#lag/not lagged (grepl("lag", variable))
col_lag_importance <- sum(colonization_model_comparison_spprandom_nomean[grep("lag", variable), ]$akaike_weight)
col_nolag_importance <- sum(colonization_model_comparison_spprandom_nomean[!grep("lag", variable), ]$akaike_weight)

#absolute (grepl("abs", variable))
col_abs_importance <- sum(colonization_model_comparison_spprandom_nomean[grep("abs", variable), ]$akaike_weight)

#raw (!grepl("change"))
col_raw_importance <- sum(colonization_model_comparison_spprandom_nomean[!grep("change", variable), ]$akaike_weight)

#change (grepl("change", variable), (!grepl("abs")))
col_change_importance <- sum(colonization_model_comparison_spprandom_nomean[grep("change", variable), ][!grep("abs", variable),]$akaike_weight)

#type of temp variable (max, min, seas)
col_max_temp_importance <- sum(colonization_model_comparison_spprandom_nomean[grep("max", variable), ]$akaike_weight)
col_min_temp_importance <- sum(colonization_model_comparison_spprandom_nomean[grep("min", variable), ]$akaike_weight)
col_seas_temp_importance <- sum(colonization_model_comparison_spprandom_nomean[grep("seas", variable), ]$akaike_weight)
```
Relative Variable Importance for Extinction Models
```{r RVI extinction not scaled}
#add ∆AIC to tables
min_ext_AICc <- min(extinction_model_comparison_spprandom_nomean[, AICc])
extinction_model_comparison_spprandom_nomean[,"deltaAICc" := (AICc - min_ext_AICc)]

#add relative likelihood exp( -0.5 * ∆AIC score for that model)
extinction_model_comparison_spprandom_nomean[,"rel_likelihood" := exp((-0.5 * deltaAICc))]
#sum relative likelihoods across all models
extinction_model_comparison_spprandom_nomean.likelihoodsum <- sum(extinction_model_comparison_spprandom_nomean[, rel_likelihood])
#Akaike weight for a model is this rel_likelihood devided by the sum of these values across all models
extinction_model_comparison_spprandom_nomean[,"akaike_weight" := rel_likelihood/extinction_model_comparison_spprandom_nomean.likelihoodsum]

#I want to look at relative importance FOR 
#bottom/surface (bottom = includes sbt, grepl("sbt", variable))
ext_bottom_importance <- sum(extinction_model_comparison_spprandom_nomean[grep("sbt", variable), ]$akaike_weight)
ext_surface_importance <- sum(extinction_model_comparison_spprandom_nomean[grep("sst", variable), ]$akaike_weight)

#lag/not lagged (grepl("lag", variable))
ext_lag_importance <- sum(extinction_model_comparison_spprandom_nomean[grep("lag", variable), ]$akaike_weight)
ext_nolag_importance <- sum(extinction_model_comparison_spprandom_nomean[!grep("lag", variable), ]$akaike_weight)

#absolute (grepl("abs", variable))
ext_abs_importance <- sum(extinction_model_comparison_spprandom_nomean[grep("abs", variable), ]$akaike_weight)

#raw (!grepl("change"))
ext_raw_importance <- sum(extinction_model_comparison_spprandom_nomean[!grep("change", variable), ]$akaike_weight)

#change (grepl("change", variable), (!grepl("abs")))
ext_change_importance <- sum(extinction_model_comparison_spprandom_nomean[grep("change", variable), ][!grep("abs", variable),]$akaike_weight)

#type of temp variable (max, min, seas)
ext_max_temp_importance <- sum(extinction_model_comparison_spprandom_nomean[grep("max", variable), ]$akaike_weight)
ext_min_temp_importance <- sum(extinction_model_comparison_spprandom_nomean[grep("min", variable), ]$akaike_weight)
ext_seas_temp_importance <- sum(extinction_model_comparison_spprandom_nomean[grep("seas", variable), ]$akaike_weight)
```

Let's see how the RVI importance varies by looking at specific lag values
```{r make a plot here for variability across lag values not scaled}
#first, table for lags
lags_v_RVI_spprandom <- data.table(col_lag = c(0:9), col_RVI = 0, ext_RVI = 0)
#colonization
lags_v_RVI_spprandom[1,2] <- 1-sum(colonization_model_comparison_spprandom_nomean[grep("lag", variable), ]$akaike_weight)
lags_v_RVI_spprandom[2,2] <- sum(colonization_model_comparison_spprandom_nomean[grep("lag1", variable), ]$akaike_weight)
lags_v_RVI_spprandom[3,2] <- sum(colonization_model_comparison_spprandom_nomean[grep("lag2", variable), ]$akaike_weight)
lags_v_RVI_spprandom[4,2] <- sum(colonization_model_comparison_spprandom_nomean[grep("lag3", variable), ]$akaike_weight)
lags_v_RVI_spprandom[5,2] <- sum(colonization_model_comparison_spprandom_nomean[grep("lag4", variable), ]$akaike_weight)
lags_v_RVI_spprandom[6,2] <- sum(colonization_model_comparison_spprandom_nomean[grep("lag5", variable), ]$akaike_weight)
lags_v_RVI_spprandom[7,2] <- sum(colonization_model_comparison_spprandom_nomean[grep("lag6", variable), ]$akaike_weight)
lags_v_RVI_spprandom[8,2] <- sum(colonization_model_comparison_spprandom_nomean[grep("lag7", variable), ]$akaike_weight)
lags_v_RVI_spprandom[9,2] <- sum(colonization_model_comparison_spprandom_nomean[grep("lag8", variable), ]$akaike_weight)
lags_v_RVI_spprandom[10,2] <- sum(colonization_model_comparison_spprandom_nomean[grep("lag9", variable), ]$akaike_weight)
#extinction
lags_v_RVI_spprandom[1,3] <- 1-sum(extinction_model_comparison_spprandom_nomean[grep("lag", variable), ]$akaike_weight)
lags_v_RVI_spprandom[2,3] <- sum(extinction_model_comparison_spprandom_nomean[grep("lag1", variable), ]$akaike_weight)
lags_v_RVI_spprandom[3,3] <- sum(extinction_model_comparison_spprandom_nomean[grep("lag2", variable), ]$akaike_weight)
lags_v_RVI_spprandom[4,3] <- sum(extinction_model_comparison_spprandom_nomean[grep("lag3", variable), ]$akaike_weight)
lags_v_RVI_spprandom[5,3] <- sum(extinction_model_comparison_spprandom_nomean[grep("lag4", variable), ]$akaike_weight)
lags_v_RVI_spprandom[6,3] <- sum(extinction_model_comparison_spprandom_nomean[grep("lag5", variable), ]$akaike_weight)
lags_v_RVI_spprandom[7,3] <- sum(extinction_model_comparison_spprandom_nomean[grep("lag6", variable), ]$akaike_weight)
lags_v_RVI_spprandom[8,3] <- sum(extinction_model_comparison_spprandom_nomean[grep("lag7", variable), ]$akaike_weight)
lags_v_RVI_spprandom[9,3] <- sum(extinction_model_comparison_spprandom_nomean[grep("lag8", variable), ]$akaike_weight)
lags_v_RVI_spprandom[10,3] <- sum(extinction_model_comparison_spprandom_nomean[grep("lag9", variable), ]$akaike_weight)

ggplot(data = lags_v_RVI_spprandom, aes(x = col_lag)) +
  geom_line(aes(y = col_RVI), col = "blue") +
  geom_line(aes(y = ext_RVI), col = "red") +
  labs(x = "Lag", y = "Relative Variable Importance") +
  scale_color_discrete() + #how to make a legend
  theme_bw()
```

Table for RVI data for Colonization
```{r put RVIs for colonization into data table not scaled}
col_ext <- c("col","col","col","col","col", "col","col", "col", "col","col")
type <- c("depth", "depth", "lag", "lag", "Change?", "Change?", "Change?", "Temp", "Temp", "Temp")
variable <- c("bottom", "surface", "no_lag", "lagged", "absolute_value_change", "change", "raw", "Min", "Max", "Seas")
value <- c(col_bottom_importance, col_surface_importance, col_nolag_importance, col_lag_importance, col_abs_importance, col_change_importance, col_raw_importance, col_min_temp_importance, col_max_temp_importance, col_seas_temp_importance)

RVI_col <- data.table(col_ext, type, variable, value)
```
Table for RVI data for Extinction
```{r put RVIs for extinction into data table not scaled}
col_ext <- c("ext","ext","ext","ext","ext", "ext", "ext", "ext", "ext", "ext")
type <- c("depth", "depth", "lag", "lag", "Change?", "Change?", "Change?", "Temp", "Temp", "Temp")
variable <- c("bottom", "surface", "no_lag", "lagged", "absolute_value_change", "change", "raw", "Min", "Max", "Seas")
value <- c(ext_bottom_importance, ext_surface_importance, ext_nolag_importance, ext_lag_importance, ext_abs_importance, ext_change_importance, ext_raw_importance, ext_min_temp_importance, ext_max_temp_importance, ext_seas_temp_importance)

RVI_ext <- data.table(col_ext, type, variable, value)
```

Merge RVI tables for colonization and extinction, and then graph
```{r merge RVI tables and plot not scaled}
RVI_table <- as.data.table(rbind(RVI_col, RVI_ext)) #bind RVI for colonizations and extinctions

RVI_table.r <- RVI_table[!grep("surface", variable)][!grep("lagged", variable)]

#change order of factor levels
RVI_table.r[, variable := factor(variable, levels = c("bottom", "no_lag", "raw", "change", "absolute_value_change", "Min", "Max", "Seas"))]

save(RVI_table, file = "RVI_table.Rdata")

ggplot(data = RVI_table.r, aes(x=variable, y = value, fill = col_ext)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_x_discrete(breaks = c("bottom", "no_lag", "raw", "change", "absolute_value_change", "Min", "Max", "Seas"), labels = c("Bottom Temp", "No Lag", "Raw Temp", "Change in \nTemp", "| Change in\n Temp |", "Min Temp", "Max Temp", "Seas")) +
  labs(x = "Temperature Variables", y = "Relative Variable Importance")  +
  theme_bw()

```

Another way to visualize is stacked bar plot.

```{r RVI stacked plot not scaled}
#put levels into correct order for viewing
RVI_table[, variable := factor(variable, levels = c("bottom", "surface", "absolute_value_change", "change", "raw", "no_lag", "lagged", "Min", "Max", "Seas"))]
#make types factors as well
RVI_table[,type := as.factor(type)]

#colonization
RVI_col_plot <- ggplot(data = RVI_table[col_ext == "col",], aes(x=type, y = value, fill = variable)) +
  geom_bar(stat="identity", color = "black") +
  scale_x_discrete(breaks = c("Change?", "depth", "lag", "Temp"), labels = c("Change in\ntemp?", "Metric\nDepth", "Lagged?", "Temp")) +
  labs(x = "Temperature Variables", y = "Relative Variable Importance") +
  theme_classic() +
  theme(text = element_text(size = 22)
        #, legend.position = "none"
        )

#extinction
RVI_ext_plot <- ggplot(data = RVI_table[col_ext == "ext",], aes(x=type, y = value, fill = variable)) +
  geom_bar(stat="identity", color = "black") +
  scale_x_discrete(breaks = c("Change?", "depth", "lag", "Temp"), labels = c("Change in\ntemp?", "Metric\nDepth", "Lagged?", "Temp")) +
  labs(x = "Temperature Variables", y = "Relative Variable Importance") +
  theme_classic()  +
  theme(text = element_text(size = 22)
        #, legend.position = "none"
        )

RVI_table
RVI_col_plot
RVI_ext_plot


```

How well do these models actually predict the # of colonizations and the # of extinctions?

```{r predicted vs. observed colonizations not scaled}
#best colonization model (all delta less than 2)
  #max_sbt_temp_change_abs
  #max_sst_temp_change_abs_lag1
  #min_sbt_temp_change_abs_lag5

bestcolmod_notscaled <- glmer(col ~ max_sbt_temp_change_abs + (1|reg) + (1|spp), family = binomial, data = spp_master_ztemp_seus_buoy, nAGQ = 0)

#I wanted predicted # of colonizations in each region per region/year
#year region observed colonizations predicted colonizations

#plotting predicted versus modeled
#unique combinations of spp, region, and max_sbt_temp_change_abs_scaled found in dataset
model_imputs <- spp_master_ztemp_seus_buoy[,c("spp", "reg", "year", "now_ext", "col", "max_sbt_temp_change_abs")]

t2_col <- predict(bestcolmod_notscaled, newdata = model_imputs, type = "response", re.form = NULL) #setting re.form to NULL includes all random effects

model_imputs$pred <- t2_col

#group by region and year, sum over "col" = observations, and "pred" = predict colonizations by summing probabilities
col_model_comparisons <- model_imputs[, .(col_predicted = sum(pred), col_observed = sum(col)), by=.(year,reg)]


ggplot(aes(x=year), data = col_model_comparisons) +
  geom_point(aes(y = col_observed), data = col_model_comparisons, col = "red") +
  geom_point(data = col_model_comparisons, aes(y = col_predicted), col = "black") +
  facet_wrap(~reg) +
  theme_classic()

```

Extinction predictions versus observations, with 1|spp as random effect but not scaled
```{r extinction predictions versus observed not scaled}
#best EXTINCTION modelS (all delta less than 2)
  #min_sst_temp_change_lag2
  #seas_sst_temp_change_lag2
  #min_sbt_temp_change_lag7


bestextmod_notscaled <- glmer(now_ext ~ min_sst_temp_change_lag2 + (1|reg) + (1|spp), family = binomial, data = spp_master_ztemp_seus_buoy, nAGQ = 0)

#I wanted predicted # of extinctions in each region per region/year
#year region observed extinctions predicted extinctions

#plotting predicted versus modeled
#unique combinations of spp, region, and max_sbt_temp_change_abs_scaled found in dataset
model_imputs <- spp_master_ztemp_seus_buoy[,c("spp", "reg", "year", "now_ext", "col", "min_sst_temp_change_lag2")]

t2_col <- predict(bestextmod_notscaled, newdata = model_imputs, type = "response", re.form = NULL) #setting re.form to NULL includes all random effects

model_imputs$pred <- t2_col

#group by region and year, sum over "now_ext" = observations, and "pred" = predict extinctions by summing probabilities
ext_model_comparisons <- model_imputs[, .(ext_predicted = sum(pred), ext_observed = sum(now_ext)), by=.(year,reg)]


ggplot(aes(x=year), data = ext_model_comparisons) +
  geom_point(aes(y = ext_observed), data = ext_model_comparisons, col = "red") +
  geom_point(data = ext_model_comparisons, aes(y = ext_predicted), col = "black") +
  facet_wrap(~reg) +
  theme_classic()

```

#####################

##Are there some species that colonize or go extinct way more than others?

```{r colonizations by species}
colonizations_bysppreg <- spp_master_ztemp_seus_buoy_scaled[, sum(col), by = .(spp, reg)] #total colonizations by spp and reg
colonizations_byspp <- spp_master_ztemp_seus_buoy_scaled[, sum(col), by = .(spp)] #total colonizations by spp
```

# Species most likely to colonize by region:

Parasudis truculenta neus 10 Atlantic Greeneye

Anchoa hepsetus neus 9 broad-striped anchovy

Macrorhamphosus scolopax neus 9 longspine snipefish

Neocrangon communis ebs 8 Gray shrimp

Carcharhinus plumbeus neus 8 Sandbar shark

Chionoecetes opilio neus 8 Snow crab

Dasyatis say neus 8 Bluntnose stingray

Decapterus punctatus neus 8 Round Scad

Etrumeus teres(sadina) neus 8 Red eye round herring

Lagodon rhomboides neus 8

Lolliguncula brevis neus 8

Nemichthys scolopaceus neus 8

Synodus foetens neus 8

Argis dentata ebs 7

#Species most likely to colonize across all regions, 288 out of 581 species experience colonization at some point atleast once

Etrumeus teres(sadina) 13 Red eye round herring

Parasudis truculenta 10 Atlantic greeneye

Anchoa hepsetus 9 broad-striped anchovy

Decapterus punctatus 9 Round scad

Pontinus longispinis 9 scorpionfish

Macrorhamphosus scolopax 9 longspine snipefish

Triglops murrayi 9 Moustache sculpin



```{r extinctions by species}
extinctions_bysppreg <- spp_master_ztemp_seus_buoy_scaled[, sum(now_ext), by = .(spp, reg)] #total extinctions by spp and reg
extinctions_byspp <- spp_master_ztemp_seus_buoy_scaled[, sum(now_ext), by = .(spp)] #total extinctions by spp
```

# Species most likely to go extinct by region:

Parasudis truculenta neus 10 Atlantic Greeneye

Macrorhamphosus scolopax neus 9 Longspine snipefish

Neocrangon communis ebs 8 Gray shrimp

Anchoa hepsetus neus 8 Broad striped anchovy

Chionoecetes opilio neus 8 snow crab

Dasyatis say neus 8

Lolliguncula brevis neus 8

Nemichthys scolopaceus neus 8

Synodus foetens neus 8

Argis dentata ebs 7

#Species most likely to go extinct across all regions, 242/581 (42%) experience atleast one extinction


Etrumeus teres(sadina) 12 Red eye round herring

Parasudis truculenta 10 Atlantic Greeneye

Ovalipes stephensoni 9 crab, closely related to lady crab

Pontinus longispinis 9 scorpionfish

Syacium papillosum 9 Dusky Flounder

Macrorhamphosus scolopax 9 Longspine snipefish

Chionoecetes opilio 8 snow crab

Neocrangon communis 8

Anchoa hepsetus 8

**********************
##What if we run these models with fish only? No traits? How do inverts change the story? Because it looks like above, not a ton of invertebrates are going in and out. 

```{r fish only}
#list of fish names from trait database
traits <- fread("TraitCollectionFishNAtlanticNEPacificContShelf (3).csv")

#make fish no fish key
fish <- data.table(spp = unique(traits$taxon), fish = "Y")

#combine with spp master
spp_master_ztemp_seus_buoy_scaled_fishonly <- merge(spp_master_ztemp_seus_buoy_scaled, fish, all.x = T)

#get rid of any rows that aren't observations of fish
spp_master_ztemp_seus_buoy_scaled_fishonly2 <- spp_master_ztemp_seus_buoy_scaled_fishonly[fish == "Y",]

```

Running models for fish only

```{r colonization models without traits for fish only}

#names of scaled columns
scaled_cols <- grep("*_scaled", names(spp_master_ztemp_seus_buoy_scaled_fishonly2), value = T)

#going to make loop to make all models I need to look at with single variables
variables_scaled <- colnames(spp_master_ztemp_seus_buoy_scaled_fishonly2[,scaled_cols, with = FALSE])

colonization_model_comparison_spprandom_scaled_seus_update_fishonly <- as.data.table(matrix(nrow = length(variables_scaled)))
colonization_model_comparison_spprandom_scaled_seus_update_fishonly[, variable:=as.factor(V1)][, coef:=as.numeric(V1)][, p_value:=as.numeric(V1)][, AICc:=as.numeric(V1)]
colonization_model_comparison_spprandom_scaled_seus_update_fishonly[, V1 := NULL]

for (i in 1:length(variables_scaled)){
  mod <- glmer(col ~ get(variables_scaled[i]) + (1|reg) + (1|spp), family = binomial, data = spp_master_ztemp_seus_buoy_scaled_fishonly2, nAGQ = 0)
  colonization_model_comparison_spprandom_scaled_seus_update_fishonly[i,variable := variables_scaled[i]]
  colonization_model_comparison_spprandom_scaled_seus_update_fishonly[i,coef := coef(summary(mod))[,"Estimate"][2]]
  colonization_model_comparison_spprandom_scaled_seus_update_fishonly[i,p_value := coef(summary(mod))[,"Pr(>|z|)"][2]]
  colonization_model_comparison_spprandom_scaled_seus_update_fishonly[i,AICc := AICc(mod)]
  
  print(paste(i, length(variables_scaled), sep = "/"))
    
}

#by setting nACQ to 0, all models converged


```

Extinction Models without Traits
```{r extinction models without traits for fish only}
#see setup above

extinction_model_comparison_spprandom_scaled_seus_update_fishonly <- as.data.table(matrix(nrow = length(variables_scaled)))
extinction_model_comparison_spprandom_scaled_seus_update_fishonly[, variable:=as.factor(V1)][, coef:=as.numeric(V1)][, p_value:=as.numeric(V1)][, AICc:=as.numeric(V1)]
extinction_model_comparison_spprandom_scaled_seus_update_fishonly[, V1 := NULL]

for (i in 1:length(variables_scaled)){
  mod <- glmer(now_ext ~ get(variables_scaled[i]) + (1|reg) + (1|spp), family = binomial, data = spp_master_ztemp_seus_buoy_scaled_fishonly2, nAGQ = 0)
  extinction_model_comparison_spprandom_scaled_seus_update_fishonly[i,variable := variables_scaled[i]]
  extinction_model_comparison_spprandom_scaled_seus_update_fishonly[i,coef := coef(summary(mod))[,"Estimate"][2]]
  extinction_model_comparison_spprandom_scaled_seus_update_fishonly[i,p_value := coef(summary(mod))[,"Pr(>|z|)"][2]]
  extinction_model_comparison_spprandom_scaled_seus_update_fishonly[i,AICc := AICc(mod)]
  
  print(paste(i, length(variables_scaled), sep = "/"))
    
}

#by setting nACQ to 0, all models converged


```

Relative Variable Importance
```{r get rid of any models using mean for fish only}
colonization_model_comparison_spprandom_scaled_seus_update_fishonly_nomean <- colonization_model_comparison_spprandom_scaled_seus_update_fishonly[!grepl("mean",variable),]

extinction_model_comparison_spprandom_scaled_seus_update_fishonly_nomean <- extinction_model_comparison_spprandom_scaled_seus_update_fishonly[!grepl("mean",variable),]

#comparison to null
col_mod_null <- glmer(col ~ (1|reg) + (1|spp), family = binomial, data = spp_master_ztemp_seus_buoy_scaled_fishonly2, nAGQ = 0)
AICc(col_mod_null)-min(colonization_model_comparison_spprandom_scaled_seus_update_fishonly_nomean$AICc)

ext_mod_null <- glmer(ext ~ (1|reg) + (1|spp), family = binomial, data = spp_master_ztemp_seus_buoy_scaled_fishonly2, nAGQ = 0)
AICc(ext_mod_null)-min(extinction_model_comparison_spprandom_scaled_seus_update_fishonly_nomean$AICc)
```

Relative Variable Importance for Colonization Models
```{r RVI colonization for fish only}
#add ∆AIC to tables
min_col_AICc_fishonly <- min(colonization_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[, AICc])
colonization_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[,"deltaAICc" := (AICc - min_col_AICc_fishonly)]

#add relative likelihood exp( -0.5 * ∆AIC score for that model)
colonization_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[,"rel_likelihood" := exp((-0.5 * deltaAICc))]
#sum relative likelihoods across all models
colonization_model_comparison_spprandom_scaled_seus_update_fishonly_nomean.likelihoodsum <- sum(colonization_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[, rel_likelihood])
#Akaike weight for a model is this rel_likelihood devided by the sum of these values across all models
colonization_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[,"akaike_weight" := rel_likelihood/colonization_model_comparison_spprandom_scaled_seus_update_fishonly_nomean.likelihoodsum]

#I want to look at relative importance FOR 
#bottom/surface (bottom = includes sbt, grepl("sbt", variable))
col_bottom_importance_fishonly <- sum(colonization_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("sbt", variable), ]$akaike_weight)
col_surface_importance_fishonly <- sum(colonization_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("sst", variable), ]$akaike_weight)

#lag/not lagged (grepl("lag", variable))
col_lag_importance_fishonly <- sum(colonization_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("lag", variable), ]$akaike_weight)
col_nolag_importance_fishonly <- sum(colonization_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[!grep("lag", variable), ]$akaike_weight)

#absolute (grepl("abs", variable))
col_abs_importance_fishonly <- sum(colonization_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("abs", variable), ]$akaike_weight)

#raw (!grepl("change"))
col_raw_importance_fishonly <- sum(colonization_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[!grep("change", variable), ]$akaike_weight)

#change (grepl("change", variable), (!grepl("abs")))
col_change_importance_fishonly <- sum(colonization_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("change", variable), ][!grep("abs", variable),]$akaike_weight)

#type of temp variable (max, min, seas)
col_max_temp_importance_fishonly <- sum(colonization_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("max", variable), ]$akaike_weight)
col_min_temp_importance_fishonly <- sum(colonization_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("min", variable), ]$akaike_weight)
col_seas_temp_importance_fishonly <- sum(colonization_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("seas", variable), ]$akaike_weight)
```

Relative Variable Importance for Extinction Models
```{r RVI extinction for fish only}
#add ∆AIC to tables
min_ext_AICc_fishonly <- min(extinction_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[, AICc])
extinction_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[,"deltaAICc" := (AICc - min_ext_AICc_fishonly)]

#add relative likelihood exp( -0.5 * ∆AIC score for that model)
extinction_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[,"rel_likelihood" := exp((-0.5 * deltaAICc))]
#sum relative likelihoods across all models
extinction_model_comparison_spprandom_scaled_seus_update_fishonly_nomean.likelihoodsum <- sum(extinction_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[, rel_likelihood])
#Akaike weight for a model is this rel_likelihood devided by the sum of these values across all models
extinction_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[,"akaike_weight" := rel_likelihood/extinction_model_comparison_spprandom_scaled_seus_update_fishonly_nomean.likelihoodsum]

#I want to look at relative importance FOR 
#bottom/surface (bottom = includes sbt, grepl("sbt", variable))
ext_bottom_importance_fishonly <- sum(extinction_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("sbt", variable), ]$akaike_weight)
ext_surface_importance_fishonly <- sum(extinction_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("sst", variable), ]$akaike_weight)

#lag/not lagged (grepl("lag", variable))
ext_lag_importance_fishonly <- sum(extinction_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("lag", variable), ]$akaike_weight)
ext_nolag_importance_fishonly <- sum(extinction_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[!grep("lag", variable), ]$akaike_weight)

#absolute (grepl("abs", variable))
ext_abs_importance_fishonly <- sum(extinction_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("abs", variable), ]$akaike_weight)

#raw (!grepl("change"))
ext_raw_importance_fishonly <- sum(extinction_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[!grep("change", variable), ]$akaike_weight)

#change (grepl("change", variable), (!grepl("abs")))
ext_change_importance_fishonly <- sum(extinction_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("change", variable), ][!grep("abs", variable),]$akaike_weight)

#type of temp variable (max, min, seas)
ext_max_temp_importance_fishonly <- sum(extinction_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("max", variable), ]$akaike_weight)
ext_min_temp_importance_fishonly <- sum(extinction_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("min", variable), ]$akaike_weight)
ext_seas_temp_importance_fishonly <- sum(extinction_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("seas", variable), ]$akaike_weight)
```

Let's see how the RVI importance varies by looking at specific lag values
```{r make a plot here for variability across lag values for fish only}
#first, table for lags
lags_v_RVI_spprandom_scaled_fishonly <- data.table(col_lag = c(0:9), col_RVI = 0, ext_RVI = 0)
#colonization
lags_v_RVI_spprandom_scaled_fishonly[1,2] <- 1-sum(colonization_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("lag", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled_fishonly[2,2] <- sum(colonization_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("lag1", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled_fishonly[3,2] <- sum(colonization_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("lag2", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled_fishonly[4,2] <- sum(colonization_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("lag3", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled_fishonly[5,2] <- sum(colonization_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("lag4", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled_fishonly[6,2] <- sum(colonization_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("lag5", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled_fishonly[7,2] <- sum(colonization_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("lag6", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled_fishonly[8,2] <- sum(colonization_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("lag7", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled_fishonly[9,2] <- sum(colonization_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("lag8", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled_fishonly[10,2] <- sum(colonization_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("lag9", variable), ]$akaike_weight)
#extinction
lags_v_RVI_spprandom_scaled_fishonly[1,3] <- 1-sum(extinction_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("lag", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled_fishonly[2,3] <- sum(extinction_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("lag1", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled_fishonly[3,3] <- sum(extinction_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("lag2", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled_fishonly[4,3] <- sum(extinction_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("lag3", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled_fishonly[5,3] <- sum(extinction_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("lag4", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled_fishonly[6,3] <- sum(extinction_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("lag5", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled_fishonly[7,3] <- sum(extinction_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("lag6", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled_fishonly[8,3] <- sum(extinction_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("lag7", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled_fishonly[9,3] <- sum(extinction_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("lag8", variable), ]$akaike_weight)
lags_v_RVI_spprandom_scaled_fishonly[10,3] <- sum(extinction_model_comparison_spprandom_scaled_seus_update_fishonly_nomean[grep("lag9", variable), ]$akaike_weight)

ggplot(data = lags_v_RVI_spprandom_scaled_fishonly, aes(x = col_lag)) +
  geom_line(aes(y = col_RVI), col = "blue") +
  geom_line(aes(y = ext_RVI), col = "red") +
  labs(x = "Lag", y = "Relative Variable Importance") +
  scale_color_discrete() + #how to make a legend
  theme_bw()
```

Table for RVI data for Colonization
```{r put RVIs for colonization into data table for fish only}
col_ext <- c("col","col","col","col","col", "col","col", "col", "col","col")
type <- c("depth", "depth", "lag", "lag", "Change?", "Change?", "Change?", "Temp", "Temp", "Temp")
variable <- c("bottom", "surface", "no_lag", "lagged", "absolute_value_change", "change", "raw", "Min", "Max", "Seas")
value <- c(col_bottom_importance_fishonly, col_surface_importance_fishonly, col_nolag_importance_fishonly, col_lag_importance_fishonly, col_abs_importance_fishonly, col_change_importance_fishonly, col_raw_importance_fishonly, col_min_temp_importance_fishonly, col_max_temp_importance_fishonly, col_seas_temp_importance_fishonly)

RVI_col_fishonly <- data.table(col_ext, type, variable, value)
```

Table for RVI data for Extinction
```{r put RVIs for extinction into data table for fish only}
col_ext <- c("ext","ext","ext","ext","ext", "ext", "ext", "ext", "ext", "ext")
type <- c("depth", "depth", "lag", "lag", "Change?", "Change?", "Change?", "Temp", "Temp", "Temp")
variable <- c("bottom", "surface", "no_lag", "lagged", "absolute_value_change", "change", "raw", "Min", "Max", "Seas")
value <- c(ext_bottom_importance_fishonly, ext_surface_importance_fishonly, ext_nolag_importance_fishonly, ext_lag_importance_fishonly, ext_abs_importance_fishonly, ext_change_importance_fishonly, ext_raw_importance_fishonly, ext_min_temp_importance_fishonly, ext_max_temp_importance_fishonly, ext_seas_temp_importance_fishonly)

RVI_ext_fishonly <- data.table(col_ext, type, variable, value)
```

Merge RVI tables for colonization and extinction, and then graph
```{r merge RVI tables and plot for fish only}
RVI_table_fishonly <- as.data.table(rbind(RVI_col_fishonly, RVI_ext_fishonly)) #bind RVI for colonizations and extinctions

RVI_table.r_fishonly <- RVI_table_fishonly[!grep("surface", variable)][!grep("lagged", variable)]

#change order of factor levels
RVI_table.r_fishonly[, variable := factor(variable, levels = c("bottom", "no_lag", "raw", "change", "absolute_value_change", "Min", "Max", "Seas"))]

save(RVI_table_fishonly, file = "RVI_table_fishonly.Rdata")

ggplot(data = RVI_table.r_fishonly, aes(x=variable, y = value, fill = col_ext)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_x_discrete(breaks = c("bottom", "no_lag", "raw", "change", "absolute_value_change", "Min", "Max", "Seas"), labels = c("Bottom Temp", "No Lag", "Raw Temp", "Change in \nTemp", "| Change in\n Temp |", "Min Temp", "Max Temp", "Seas")) +
  labs(x = "Temperature Variables", y = "Relative Variable Importance")  +
  theme_bw()

```

Another way to visualize is stacked bar plot.

```{r RVI stacked plot for fish only}
#put levels into correct order for viewing
RVI_table_fishonly[, variable := factor(variable, levels = c("bottom", "surface", "absolute_value_change", "change", "raw", "no_lag", "lagged", "Min", "Max", "Seas"))]
#make types factors as well
RVI_table_fishonly[,type := as.factor(type)]

#colonization
RVI_col_plot_fishonly <- ggplot(data = RVI_table_fishonly[col_ext == "col",], aes(x=type, y = value, fill = variable)) +
  geom_bar(stat="identity", color = "black") +
  scale_x_discrete(breaks = c("Change?", "depth", "lag", "Temp"), labels = c("Change in\ntemp?", "Metric\nDepth", "Lagged?", "Temp")) +
  labs(x = "Temperature Variables", y = "Relative Variable Importance") +
  theme_classic() +
  theme(text = element_text(size = 22)
        #, legend.position = "none"
        )

#extinction
RVI_ext_plot_fishonly <- ggplot(data = RVI_table_fishonly[col_ext == "ext",], aes(x=type, y = value, fill = variable)) +
  geom_bar(stat="identity", color = "black") +
  scale_x_discrete(breaks = c("Change?", "depth", "lag", "Temp"), labels = c("Change in\ntemp?", "Metric\nDepth", "Lagged?", "Temp")) +
  labs(x = "Temperature Variables", y = "Relative Variable Importance") +
  theme_classic()  +
  theme(text = element_text(size = 22)
        #, legend.position = "none"
        )

RVI_table_fishonly
RVI_col_plot_fishonly
RVI_ext_plot_fishonly


```

How well do these models actually predict the # of colonizations and the # of extinctions?

```{r predicted vs. observed colonizations scaled for fish only }
library(tidyr)
library(plyr)
#best colonization models (all delta less than 2)
  #seas_sst_temp_change_abs_scaled



bestcolmod_scaled_fishonly <- glmer(col ~ seas_sst_temp_change_abs_scaled + (1|reg) + (1|spp), family = binomial, data = spp_master_ztemp_seus_buoy_scaled_fishonly2, nAGQ = 0)

#I wanted predicted # of colonizations in each region per region/year
#year region observed colonizations predicted colonizations

#plotting predicted versus modeled
#unique combinations of spp, region, and max_sbt_temp_change_abs_scaled found in dataset
model_imputs <- spp_master_ztemp_seus_buoy_scaled_fishonly2[,c("spp", "reg", "year", "col", "now_ext", "seas_sst_temp_change_abs_scaled")]

t2_col <- predict(bestcolmod_scaled_fishonly, newdata = model_imputs, type = "response", re.form = NULL) #setting re.form to NULL includes all random effects

model_imputs$pred <- t2_col

#group by region and year, sum over "col" = observations, and "pred" = predict colonizations by summing probabilities
col_model_comparisons_fishonly <- model_imputs[, .(col_predicted = sum(pred), col_observed = sum(col)), by=.(year,reg)]


ggplot(aes(x=year), data = col_model_comparisons_fishonly) +
  geom_point(aes(y = col_observed), data = col_model_comparisons_fishonly, col = "red") +
  geom_point(data = col_model_comparisons_fishonly, aes(y = col_predicted), col = "black") +
  facet_wrap(~reg) +
  theme_classic()



```

All regions together?
```{r all reg together 1|spp scaled fish only predicted versus observed colonizations}
ggplot(aes(x=year), data = col_model_comparisons_fishonly) +
  geom_point(aes(y = col_observed, col = reg), data = col_model_comparisons_fishonly) +
  geom_point(data = col_model_comparisons_fishonly, aes(y = col_predicted, pch = reg)) +
  #facet_wrap(~reg) +
  theme_classic()
```



Predicted extinctions versus observed for 1|spp models for fish only scaled
```{r extinction predictions versus observed scaled for fish only}

#best extinction model (all delta less than 2)
  #min_sbt_temp_change_abs_lag5_scaled 
  #max_sst_temp_scaled
  #seas_sst_temp_change_abs_lag1_scaled 
  #seas_sst_temp_change_abs_lag6_scaled  

bestextmod_scaled_fishonly <- glmer(now_ext ~ min_sbt_temp_change_abs_lag5_scaled + (1|reg) + (1|spp), family = binomial, data = spp_master_ztemp_seus_buoy_scaled_fishonly2, nAGQ = 0)

#I wanted predicted # of colonizations in each region per region/year
#year region observed colonizations predicted colonizations

#plotting predicted versus modeled
#unique combinations of spp, region, and max_sbt_temp_change_abs_scaled found in dataset
model_imputs <- spp_master_ztemp_seus_buoy_scaled_fishonly2[,c("spp", "reg", "year", "col", "now_ext", "min_sbt_temp_change_abs_lag5_scaled")]

t2_ext <- predict(bestextmod_scaled_fishonly, newdata = model_imputs, type = "response", re.form = NULL) #setting re.form to NULL includes all random effects

model_imputs$pred <- t2_ext

#group by region and year, sum over "ext" = observations, and "pred" = predict colonizations by summing probabilities
ext_model_comparisons_fishonly <- model_imputs[, .(ext_predicted = sum(pred), ext_observed = sum(now_ext)), by=.(year,reg)]


ggplot(aes(x=year), data = ext_model_comparisons_fishonly) +
  geom_point(aes(y = ext_observed), data = ext_model_comparisons, col = "red") +
  geom_point(data = ext_model_comparisons_fishonly, aes(y = ext_predicted), col = "black") +
  facet_wrap(~reg) +
  theme_classic()
```






