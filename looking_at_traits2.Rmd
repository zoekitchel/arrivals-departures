---
title: "Looking at Traits"
output: html_notebook
---

Going to look at some patterns in traits
```{r setup}
library(ggplot2)
library(data.table)
library(lme4)
library(MuMIn)

traits <- read.csv("TraitCollectionFishNAtlanticNEPacificContShelf (3).csv")
traits <- data.table(traits)

#remove duplicates
traits.u <- unique(traits, by = c('taxon'))

```
Interested in looking at max age, trophic level, and age of maturity
```{r trait patterns}
ggplot(aes(x=age.max), data = traits) +
  geom_histogram()

ggplot(aes(x=age.maturity), data = traits) +
  geom_histogram()

ggplot(aes(x=tl), data = traits) +
  geom_histogram()

cor(na.omit(traits[,c(10, 17, 22)]))
``` 
They have a R^2 value of 0.53, so, worth it to try both. 

Let's link species

First, let's see if there are any errors?
```{r linking species}
load("spp_master_ztemp.Rdata")
spp_master_spp <- data.frame(spp = unique(spp_master_ztemp$spp), origin = "spp_master")
traits_spp <- data.frame(spp = unique(traits$taxon), origin = "traits")
spp_all <- rbind(spp_master_spp, traits_spp)
spp_all$spp <- as.character(spp_all$spp)
spp_all.u <- spp_all[!duplicated(spp_all$spp),]
```

#Species to fix

species | location

Arctozenus risso | spp_master
Arctozenus risso kroyeri | spp_master
*Arctozenus risso in traits, so best to apply same to both Arctozenus and Artozenus risso kroyeri in spp_master
```{r Arctozenus risso}
row <- traits.u[taxon == "Arctozenus risso",]
row[,taxon := "Arctozenus risso kroyeri"][, species := "risso kroyeri"]
traits.u <- rbind(traits.u, row)
```

Myoxocephalus scorpioides | spp_master
Myoxocephalus scorpius | spp_master
*yes, these are different!

Auxis rochei rochei | traits
*ignore, not in our hauls

Diplecogaster bimaculata | traits
Diplecogaster bimaculata bimaculata | traits
*ignore, not in our hauls

Etrumeus teres | traits
Etrumeus teres(sadina) | spp_master
*change spp_master to Etrumeus teres
```{r Etrumeus teres}
spp_master_ztemp[spp == "Etrumeus teres(sadina)", spp := "Etrumeus teres"]

```

Eualus gaimardii gaimardii | spp_master
*ignore, not in trait database

Gasterosteus aculeatus | traits
Gasterosteus aculeatus williamsoni | traits
*ignore, not in our hauls

Lestidiops jayakari | traits
Lestidiops jayakari jayakari | traits
*ignore, not in our hauls

Liparis liparis liparis | traits
*ignore, not in our hauls

Macroramphosus scolopax | traits
Macrorhamphosus scolopax | spp_master
*spelling error in spp_master, change to Macroramphosus scolopax
```{r Macroramphosus scolopax}
spp_master_ztemp[spp == "Macrorhamphosus scolopax", spp := "Macroramphosus scolopax"]
```

Mullus barbatus barbatus | traits
*ignore, not in our hauls

Myliobatis freminvillei | traits
Myliobatis freminvillii | spp_master
*spelling error in spp_master, change to Myliobatis freminvillei
```{r Myliobatis freminvillei}
spp_master_ztemp[spp == "Myliobatis freminvillii", spp := "Myliobatis freminvillei"]
```


Nicholsina usta usta | traits
*ignore, not in our hauls

Notoscopelus elongatus kroyeri | traits
*ignore, not in our hauls

Oxyporhamphus micropterus micropterus | traits
*ignore, not in our hauls

Polydactylus octoemus | spp_master
Polydactylus octonemus | traits
*spelling error in spp_master, change to Polydactylus octonemus
```{r Polydactylus octonemus}
spp_master_ztemp[spp == "Polydactylus octoemus", spp := "Polydactylus octonemus"]
```


Salmo trutta trutta | traits
*ignore, not in our hauls

Scomberesox saurus saurus | traits
*ignore, not in our hauls

Stichaeus punctatus | spp_master
Stichaeus punctatus punctatus | traits
*delte one punctatus from traits
```{r Stichaeus punctatus}
traits.u[taxon == "Stichaeus punctatus punctatus", taxon := "Stichaeus punctatus"][species == "punctatus punctatus", species := "punctatus"]

```


Stomias boa boa | traits
Stomias boa ferox | traits
*ignore, not in our trawls

Symphurus civitatium | traits
Symphurus civitatum | spp_master
*spelling error in spp_master, change to Symphurus civitatium
```{r Symphurus civitatium}
spp_master_ztemp[spp == "Symphurus civitatum", spp := "Symphurus civitatium"]

```


Zenopsis conchifer | traits
Zenopsis conchifera | spp_master
*spelling error in spp_master, change to Zenopsis conchifer
```{r Zenopsis conchifer}
spp_master_ztemp[spp == "Zenopsis conchifera", spp := "Zenopsis conchifer"]

```

Okay, now we can go forward. Let's link traits to spp_master with temp data

```{r link traits to haul data}
traits.u[, spp := taxon][, taxon := NULL]
spp_master_ztemp.traits <- spp_master_ztemp[traits.u, nomatch = 0, on = c("spp")]
```

Now to save updated data.table with traits for species we have traits for
```{r save}
save(spp_master_ztemp.traits, file = "spp_master_ztemp.traits.Rdata")
```

*******
#Now, what happens if we add traits to our models?

Let's just look at our best models

Best colonization models without traits:

variable | coefficient | p | AICc
---------|-------------|----|-----|
| 1 | max_sbt_temp_change_abs | 	0.23859896	| 4.768169e-06	| 6878.288 |	
| 2 | max_sst_temp_change_abs_lag1	| -0.23972849	| 7.626257e-04	| 6887.400 |	
| 3 | min_sbt_temp_change_abs_lag5	| -0.24444356	| 2.224470e-03	| 6888.859 |	
| 4 | max_sbt_temp_change_abs_lag3 | 	0.17106664	| 1.235113e-03	| 6888.938 |	
| 5 | seas_sbt_temp_change_abs | 	0.14237610	| 1.832988e-03	| 6889.498 |	
| 6 | max_sst_temp_change_abs_lag8 | 	0.19094887	| 2.065176e-03	| 6889.901 |	
| 7 | seas_sst_temp_change_abs_lag8 | 	0.12714037	| 3.919052e-03	| 6890.941 |
| 8 | seas_sbt_temp_change_abs_lag4 |	0.13592310 |	5.378231e-03 |	6891.397 |	
| 9 | max_sbt_temp_change_lag8 |	-0.11479683	| 6.230307e-03 |	6891.566	|
| 10 | seas_sbt_temp_change_abs_lag1 |	0.12614156 |	7.121969e-03 |	6891.960 |	
| 11 | max_sbt_temp_change_abs_lag1 |	0.13913884 |	9.612377e-03 |	6892.510 |	
| 12 | seas_sst_temp_change_abs |	0.10400362 |	1.380557e-02 |	6893.210 |	
| 13 | max_sst_temp_change_abs_lag3 |	0.15225482 |	1.668734e-02 |	6893.417 |	
| 14 | max_sst_temp_change_abs |	0.16851906 |	2.258119e-02 |	6893.968 |	
| 15 | min_sst_temp_change_lag5 |	0.07967662 |	2.537698e-02 |	6894.026 |	

Now, I need to run all models again with this restricted data set. Do the models hold up? Then, I will see how adding traits changes things.

##Maximum age and colonization
```{r run colonization models again with restricted data set to only age.max species do models hold up}
#restrict to rows with age max data
spp_master_ztemp.traits.na.age.max <- na.omit(spp_master_ztemp.traits, cols="age.max")
spp_master_ztemp.traits.na.age.max[,year_factor := as.factor(year)]

#going to make loop to make all models I need to look at with single SURFACE variables
surface_variables <- colnames(spp_master_ztemp.traits.na.age.max[,45:168])
surface_colonization_model_comparison.maxage <- as.data.table(matrix(nrow = length(surface_variables)))
surface_colonization_model_comparison.maxage[, variable:=as.factor(V1)][, coef:=as.numeric(V1)][, p_value:=as.numeric(V1)][, AICc:=as.numeric(V1)]
surface_colonization_model_comparison.maxage[, V1 := NULL]

for (i in 1:length(surface_variables)){
  mod <- glmer(col ~ get(surface_variables[i]) + (1|reg) + (1|year_factor), family = binomial, data = spp_master_ztemp.traits.na.age.max)
  surface_colonization_model_comparison.maxage[i,variable := surface_variables[i]]
  surface_colonization_model_comparison.maxage[i,coef := coef(summary(mod))[,"Estimate"][2]]
  surface_colonization_model_comparison.maxage[i,p_value := coef(summary(mod))[,"Pr(>|z|)"][2]]
  surface_colonization_model_comparison.maxage[i,AICc := AICc(mod)]
  
  print(paste(i, length(surface_variables), sep = "/"))
    
}

#looping through all possible colonization variables with single BOTTOM variables
bottom_variables <- colnames(spp_master_ztemp.traits.na.age.max[,169:292]) #same as above

bottom_colonization_model_comparison.maxage <- as.data.table(matrix(nrow = length(bottom_variables)))
bottom_colonization_model_comparison.maxage[, variable:=as.factor(V1)][, coef:=as.numeric(V1)][, p_value:=as.numeric(V1)][, AICc:=as.numeric(V1)]
bottom_colonization_model_comparison.maxage[, V1 := NULL]

for (i in 1:length(bottom_variables)){
  mod <- glmer(col ~ get(bottom_variables[i]) + (1|reg) + (1|year_factor), family = binomial, data = spp_master_ztemp.traits.na.age.max)
  bottom_colonization_model_comparison.maxage[i,variable := bottom_variables[i]]
  bottom_colonization_model_comparison.maxage[i,coef := coef(summary(mod))[,"Estimate"][2]]
  bottom_colonization_model_comparison.maxage[i,p_value := coef(summary(mod))[,"Pr(>|z|)"][2]]
  bottom_colonization_model_comparison.maxage[i,AICc := AICc(mod)]
  
  print(paste(i, length(bottom_variables), sep = "/"))
    
}

#merge surface and bottom for colonization
colonization_model_comparisons.maxage <- rbind(bottom_colonization_model_comparison.maxage, surface_colonization_model_comparison.maxage)
#lowest AICc
head(colonization_model_comparisons.maxage[order(AICc)], 30)
```
Do top models hold up? This is telling me that previous best model (max sbt temp change abs) is still good, but not the best... Malin says it's okay, as long as similar models are coming out on top. 11/15 top models shared. 

variable | coefficient | p | AICc | rank above | coef above
---------|-------------|----|-----|---|---|
| 1 | seas_sst_temp_change_abs |	0.16747228 |	0.001059902 |	4239.108 |	12 | 0.104 |
| 2 | max_sbt_temp_change_abs_lag3 |	0.19569357 |	0.001885719 |	4239.951 | 4	| 0.171 |
| 3 | max_sst_temp_change_abs_lag1 |	-0.26280961 |	0.003919178 |	4240.645 | 2 | -0.24 |
| 4 | max_sbt_temp_change_abs |	0.16256132 |	0.009148480 |	4242.650 | 1 | 0.239 |
| 5 | max_sbt_temp_change_abs_lag1 |	0.16616085 |	0.010718533 |	4242.893 | 11 | 0.14 | 
| 6 | seas_sbt_temp_change_abs |	0.13226661 |	0.016386407 |	4243.561 | 5 | 0.14 
| 7 | seas_sbt_temp_change_abs_lag4 |	0.14075757 |	0.019188279 |	4243.750 | 8 | 0.14
| 8 | max_sst_temp_change_abs_lag6 |	-0.20512821 |	0.024157883 |	4243.823 |	not in top 15 | |
| 9 | seas_sbt_temp_change_abs_lag1 |	0.12951678 |	0.026914136 |	4244.384 | 9 | 0.13 |	
| 10 | max_sst_temp_change_abs_lag8 |	0.17240059 |	0.028828987 |	4244.709 | 6 |	0.19
| 11 | seas_sst_temp_change_abs_lag6 |	-0.12608343 |	0.043620010 |	4244.899 | not in top 15 | |	
| 12 | max_sst_temp_change_abs |	0.19930194 |	0.042940256 |	4245.196 | 14 | 0.17 |	
| 13 | seas_sst_temp_change_lag5 |	-0.07459168 |	0.049345998 |	4245.232 | not in top 15 | |	
| 14 | seas_sbt_temp_lag10 |	0.08104661 |	0.048357908 |	4245.336 | not in top 15 | |	
| 15 | min_sbt_temp_change_abs_lag5 |	-0.18602894 |	0.060853920 |	4245.388 | 3 | -0.24 |	

Now we will check to see if including max age improves best models.
```{r colonization maximum age does adding max age improve models: new base model}

#new base model (best model with no traits added)
mod.c.agemax.0 <- glmer(col ~ max_sbt_temp_change_abs + (1|reg) + (1|year_factor), family = binomial, data = spp_master_ztemp.traits.na.age.max)
summary(mod.c.agemax.0)
AICc(mod.c.agemax.0)

#max_sbt_temp_change_abs	      0.16256 	0.00915	4242.65
```


```{r colonization maximum age does adding max age improve models:adding max.age}
#max_sbt_temp_change_abs and age.max
mod.c.agemax.1 <- glmer(col ~ max_sbt_temp_change_abs + age.max + (1|reg) + (1|year_factor), family = binomial, data = spp_master_ztemp.traits.na.age.max)
summary(mod.c.agemax.1)
AICc(mod.c.agemax.1)


  #max_sbt_temp_change_abs and             0.155462 0.0127  4204.059
      #                       age.max      -0.025250 1.42e-08	

```


```{r colonization maximum age does adding max age improve models:adding max.age with interaction}
#interaction?
mod.c.agemax.2 <- glmer(col ~ max_sbt_temp_change_abs * age.max + (1|reg) + (1|year_factor), family = binomial, data = spp_master_ztemp.traits.na.age.max)
summary(mod.c.agemax.2)
AICc(mod.c.agemax.2)

  #max_sbt_temp_change_abs          0.055470   0.088216   0.629   0.5295    
    #age.max                         -0.031236   0.005892  -5.301 1.15e-07 ***
    #max_sbt_temp_change_abs:age.max  0.008543   0.005074   1.684   0.0922 .  
  #yes, appears that max age impacts interaction with temperature.
```
The interaction is significant. As maximum age increases, the effect of temp on liklihood of colonization increases.

```{r colonization maximum age does adding max age improve models:only max.age}
#what about only max age?
mod.c.agemax.3 <- glmer(col ~ age.max + (1|reg) + (1|year_factor), family = binomial, data = spp_master_ztemp.traits.na.age.max)
summary(mod.c.agemax.3)
AICc(mod.c.agemax.3)

  #4208.04

```
Comparing above options (no trait, yes trait, yes trait with interaction, only trait)
```{r colonization maximum age does adding max age improve models: comparing all models}
AICc(mod.c.agemax.0, mod.c.agemax.1, mod.c.agemax.2, mod.c.agemax.3)
```
Best model (Δ = 1.34, w/ interaction)

This tells us that as maximum age increases, the log odds of colonizing decreases. As max absolute change in sbt experienced in the past year increases, log odds of colonization increases. Additionally, as max age increases, the effect of temp on log odds of colonization increases.

Can we make a plot for how likelihood of colonization and extinction changes with age.max?
```{r age.max region bias?}
ggplot(aes(x=age.max), data = spp_master_ztemp.traits.na.age.max) +
  geom_histogram() +
  facet_wrap(~reg)

#appears to be similar across regions? just many more in neus
```

##Age of Maturity for Colonization
```{r run colonization models again with restricted data set to only age.maturity species do models hold up}
#restrict to rows with maturity data
spp_master_ztemp.traits.na.age.maturity <- na.omit(spp_master_ztemp.traits, cols="age.maturity")
spp_master_ztemp.traits.na.age.maturity[,year_factor := as.factor(year)]

#going to make loop to make all models I need to look at with single SURFACE variables
surface_variables <- colnames(spp_master_ztemp.traits.na.age.maturity[,45:168])
surface_colonization_model_comparison.maturityage <- as.data.table(matrix(nrow = length(surface_variables)))
surface_colonization_model_comparison.maturityage[, variable:=as.factor(V1)][, coef:=as.numeric(V1)][, p_value:=as.numeric(V1)][, AICc:=as.numeric(V1)]
surface_colonization_model_comparison.maturityage[, V1 := NULL]

for (i in 1:length(surface_variables)){
  mod <- glmer(col ~ get(surface_variables[i]) + (1|reg) + (1|year_factor), family = binomial, data = spp_master_ztemp.traits.na.age.maturity)
  surface_colonization_model_comparison.maturityage[i,variable := surface_variables[i]]
  surface_colonization_model_comparison.maturityage[i,coef := coef(summary(mod))[,"Estimate"][2]]
  surface_colonization_model_comparison.maturityage[i,p_value := coef(summary(mod))[,"Pr(>|z|)"][2]]
  surface_colonization_model_comparison.maturityage[i,AICc := AICc(mod)]
  
  print(paste(i, length(surface_variables), sep = "/"))
    
}

#looping through all possible colonization variables with single BOTTOM variables
bottom_variables <- colnames(spp_master_ztemp.traits.na.age.maturity[,169:292]) #same as above

bottom_colonization_model_comparison.maturityage <- as.data.table(matrix(nrow = length(bottom_variables)))
bottom_colonization_model_comparison.maturityage[, variable:=as.factor(V1)][, coef:=as.numeric(V1)][, p_value:=as.numeric(V1)][, AICc:=as.numeric(V1)]
bottom_colonization_model_comparison.maturityage[, V1 := NULL]

for (i in 1:length(bottom_variables)){
  mod <- glmer(col ~ get(bottom_variables[i]) + (1|reg) + (1|year_factor), family = binomial, data = spp_master_ztemp.traits.na.age.maturity)
  bottom_colonization_model_comparison.maturityage[i,variable := bottom_variables[i]]
  bottom_colonization_model_comparison.maturityage[i,coef := coef(summary(mod))[,"Estimate"][2]]
  bottom_colonization_model_comparison.maturityage[i,p_value := coef(summary(mod))[,"Pr(>|z|)"][2]]
  bottom_colonization_model_comparison.maturityage[i,AICc := AICc(mod)]
  
  print(paste(i, length(bottom_variables), sep = "/"))
    
}

#merge surface and bottom for colonization
colonization_model_comparisons.maturityage <- rbind(bottom_colonization_model_comparison.maturityage, surface_colonization_model_comparison.maturityage)
#lowest AICc
head(colonization_model_comparisons.maturityage[order(AICc)], 30)
```
Do top models hold up? This is telling me that previous best model (max sbt temp change abs) is still good, but not the best... Malin says it's okay, as long as similar models are coming out on top

variable | coefficient | p | AICc | rank above | coef above
---------|-------------|----|-----|---|---|
| 1 | seas_sst_temp_change_abs | 	0.16732168 |	0.001055896 |	4237.134 | 12 | 0.10	| 
| 2 | max_sst_temp_change_abs_lag1	 | -0.26275332 |	0.004143103 |	4238.738 | 2 | -0.24 |
| 3 | max_sbt_temp_change_abs_lag3 | 	0.18628409 |	0.003083958 |	4238.804 | 4 | 0.17 |
| 4 | max_sst_temp_change_abs_lag6	 | -0.22361557 |	0.014782142 |	4240.889 | not in top 15 | |
| 5 | max_sbt_temp_change_abs | 	0.15801135 |	0.011635865 |	4241.039 | 1 | 0.24 |
| 6 | max_sst_temp_change_abs_lag8 | 	0.19598072 |	0.012668985 |	4241.366 | 6 | 0.19 |
| 7 | max_sbt_temp_change_abs_lag1 | 	0.15825795 |	0.014922452 |	4241.440 | 11 | 0.14 |
| 9 | seas_sbt_temp_change_abs | 	0.13079589 |	0.017830284 |	4241.690 | 5 | 0.14 | 
| 10 | seas_sbt_temp_change_abs_lag4 | 	0.13424702 |	0.024563505 |	4242.176 | 8 | 0.14 |
| 11 | seas_sst_temp_change_abs_lag6	 | -0.13386926 |	0.033532762 |	4242.414 | not in top 15 | |
| 12 | seas_sbt_temp_change_abs_lag1 | 	0.12498712 |	0.031649631 |	4242.646 | 10 | 0.13 |
| 13 | 	min_sbt_temp_change_abs_lag5	 | -0.19180573 |	0.054000799 |	4243.150 | 3 | -0.24 |
| 14 | seas_sst_temp_change_lag5	 | -0.07497315 |	0.049187743 |	4243.216 |	not in top 15 | |
| 15 | seas_sbt_temp_lag10 | 	0.07724898 |	0.059318089 |	4243.639 | not in top 15 ||

In top 15, 11/15 shared. 

Now we will check to see if including age at maturity improves best models.
```{r colonization age at maturity does adding age at maturity improve models: new base model}

#new base model (best model with no traits added)
mod.c.agematurity.0 <- glmer(col ~ max_sbt_temp_change_abs + (1|reg) + (1|year_factor), family = binomial, data = spp_master_ztemp.traits.na.age.maturity)
summary(mod.c.agematurity.0)
AICc(mod.c.agematurity.0)
  #max_sbt_temp_change_abs  0.15801  0.0116 4241.039  
```


```{r colonization age at maturity does adding age at maturity improve models:adding age at maturity}
#max_sbt_temp_change_abs and age.maturity
mod.c.agematurity.1 <- glmer(col ~ max_sbt_temp_change_abs + age.maturity + (1|reg) + (1|year_factor), family = binomial, data = spp_master_ztemp.traits.na.age.maturity)
summary(mod.c.agematurity.1)
AICc(mod.c.agematurity.1)

#max_sbt_temp_change_abs  0.15503   0.0132 4236.753
#age.maturity            -0.03818   0.0171 


```


```{r colonization age at maturity does adding age at maturity improve models:adding age at maturity with interaction}
#interaction?
mod.c.agematurity.2 <- glmer(col ~ max_sbt_temp_change_abs * age.maturity + (1|reg) + (1|year_factor), family = binomial, data = spp_master_ztemp.traits.na.age.maturity)
summary(mod.c.agematurity.2)
AICc(mod.c.agematurity.2)

#max_sbt_temp_change_abs               0.16781  0.0385 4238.693 
#age.maturity                         -0.03490  0.0911  
#max_sbt_temp_change_abs:age.maturity -0.00451  0.8063  
```
Interaction is NOT significant

```{r colonization age at maturity does adding age at maturity improve models:only age at maturity}
#what about only age at maturity?
mod.c.agematurity.3 <- glmer(col ~ age.maturity + (1|reg) + (1|year_factor), family = binomial, data = spp_master_ztemp.traits.na.age.maturity)
summary(mod.c.agematurity.3)
AICc(mod.c.agematurity.3)

#age.maturity -0.03886 0.0155 4240.648  

```


Comparing above options (no trait, yes trait, yes trait with interaction, only trait)
```{r colonization age at maturity does adding age at maturity improve models: comparing all models}
AICc(mod.c.agematurity.0, mod.c.agematurity.1, mod.c.agematurity.2, mod.c.agematurity.3)
```
Best model is with age maturity and temperature, but NO interaction.

This tells us that as age at maturity increases, log odds of colonization decreases. As absolute value of change in max temp experienced in the past year increases, log odds of colonization increases. Age at maturity does not impact relationship between temp and colonization.

Can we make a plot for how likelihood of colonization and extinction changes with age.maturity?
```{r age.maturity region bias?}
ggplot(aes(x=age.maturity), data = spp_master_ztemp.traits.na.age.maturity) +
  geom_histogram() +
  facet_wrap(~reg)

```
  
  
##Colonization Trophic Level
```{r run colonization models again with restricted data set to only tl species do models hold up}
#restrict to rows with trophic level data
spp_master_ztemp.traits.na.tl <- na.omit(spp_master_ztemp.traits, cols="tl")
spp_master_ztemp.traits.na.tl[,year_factor := as.factor(year)]

#going to make loop to make all models I need to look at with single SURFACE variables
surface_variables <- colnames(spp_master_ztemp.traits.na.tl[,45:168])
surface_colonization_model_comparison.tl <- as.data.table(matrix(nrow = length(surface_variables)))
surface_colonization_model_comparison.tl[, variable:=as.factor(V1)][, coef:=as.numeric(V1)][, p_value:=as.numeric(V1)][, AICc:=as.numeric(V1)]
surface_colonization_model_comparison.tl[, V1 := NULL]

for (i in 1:length(surface_variables)){
  mod <- glmer(col ~ get(surface_variables[i]) + (1|reg) + (1|year_factor), family = binomial, data = spp_master_ztemp.traits.na.tl)
  surface_colonization_model_comparison.tl[i,variable := surface_variables[i]]
  surface_colonization_model_comparison.tl[i,coef := coef(summary(mod))[,"Estimate"][2]]
  surface_colonization_model_comparison.tl[i,p_value := coef(summary(mod))[,"Pr(>|z|)"][2]]
  surface_colonization_model_comparison.tl[i,AICc := AICc(mod)]
  
  print(paste(i, length(surface_variables), sep = "/"))
    
}

#looping through all possible colonization variables with single BOTTOM variables
bottom_variables <- colnames(spp_master_ztemp.traits.na.tl[,169:292]) #same as above

bottom_colonization_model_comparison.tl <- as.data.table(matrix(nrow = length(bottom_variables)))
bottom_colonization_model_comparison.tl[, variable:=as.factor(V1)][, coef:=as.numeric(V1)][, p_value:=as.numeric(V1)][, AICc:=as.numeric(V1)]
bottom_colonization_model_comparison.tl[, V1 := NULL]

for (i in 1:length(bottom_variables)){
  mod <- glmer(col ~ get(bottom_variables[i]) + (1|reg) + (1|year_factor), family = binomial, data = spp_master_ztemp.traits.na.tl)
  bottom_colonization_model_comparison.tl[i,variable := bottom_variables[i]]
  bottom_colonization_model_comparison.tl[i,coef := coef(summary(mod))[,"Estimate"][2]]
  bottom_colonization_model_comparison.tl[i,p_value := coef(summary(mod))[,"Pr(>|z|)"][2]]
  bottom_colonization_model_comparison.tl[i,AICc := AICc(mod)]
  
  print(paste(i, length(bottom_variables), sep = "/"))
    
}

#merge surface and bottom for colonization
colonization_model_comparisons.tl <- rbind(bottom_colonization_model_comparison.tl, surface_colonization_model_comparison.tl)
#lowest AICc
head(colonization_model_comparisons.tl[order(AICc)], 30)
```
Do top models hold up? This is telling me that previous best model (max sbt temp change abs) is still good, but not the best... Malin says it's okay, as long as similar models are coming out on top

variable | coefficient | p | AICc | rank above | coef above
|---------|-------------|----|-----|---|---|
| 1 | seas_sst_temp_change_abs |	0.17121179 |	0.0005599279 |	4525.486 |	12 | 0.10 |
| 2 | max_sbt_temp_change_abs_lag3 |	0.19678089 |	0.0013246068 |	4526.919 | 4 | 0.17 |
| 3 | max_sbt_temp_change_abs |	0.18509626 |	0.0021952362 |	4527.742 | 1 | 0.24
| 4 | max_sst_temp_change_abs_lag1 |	-0.25709293 |	0.0033255361 |	4527.955 | 2 | -0.24
| 5 | seas_sbt_temp_change_abs |	0.15728890 |	0.0034775899 |	4528.408 |	5 | 0.14
| 6 | max_sbt_temp_change_abs_lag1 |	0.16544380 |	0.0096094080 |	4530.271 |	11 | 0.14
| 7 | seas_sbt_temp_change_abs_lag1 |	0.13431316 |	0.0183946976 |	4531.309 |	10 | 0.13
| 8 | seas_sbt_temp_change_abs_lag4 |	0.13162107 |	0.0232351577 |	4531.668 |	8 | 0.14
| 9 | min_sbt_temp_change_abs |	0.17182671 |	0.0196874934 |	4531.795 | not in top 15 ||
| 10 | max_sst_temp_change_abs_lag8 |	0.16963749 |	0.0255186622 |	4532.091 |	6 | 0.19 |
| 11 | min_sbt_temp_change_abs_lag5 |	-0.20316841 |	0.0397350249 |	4532.176 |	3 | -0.24 |
| 12 | max_sst_temp_change_abs_lag6 |	-0.18049426 |	0.0381593586 |	4532.251 | not in top 15 ||
| 13 | seas_sst_temp_change_lag5 |	-0.07645147 |	0.0360758538 |	4532.280 |	not in top 15 ||
| 14 | max_sst_temp_change_abs |	0.20292370 |	0.0327597085 |	4532.339 |	14 | 0.17|
| 15 | min_sst_temp_change_abs |	0.13663573 |	0.0333662358 |	4532.452 |	not in top 15||

Of top 15, 11 are shared between the two. 

Now we will check to see if including trophic level improves best models.
```{r colonization trophic level does adding trophic level improve models: new base model}

#new base model (best model with no traits added)
mod.c.tl.0 <- glmer(col ~ max_sbt_temp_change_abs + (1|reg) + (1|year_factor), family = binomial, data = spp_master_ztemp.traits.na.tl)
summary(mod.c.tl.0)
AICc(mod.c.tl.0)
#max_sbt_temp_change_abs  0.18510  0.0022 4527.742
```


```{r colonization trophic level does adding trophic level improve models:adding trophic level}
#max_sbt_temp_change_abs and tl
mod.c.tl.1 <- glmer(col ~ max_sbt_temp_change_abs + tl + (1|reg) + (1|year_factor), family = binomial, data = spp_master_ztemp.traits.na.tl)
summary(mod.c.tl.1)
AICc(mod.c.tl.1)

#max_sbt_temp_change_abs  0.18636   0.002102 4515.642
#tl                      -0.36865   0.000158


```


```{r colonization trophic level does adding trophic level improve models:adding trophic level with interaction}
#interaction?
mod.c.tl.2 <- glmer(col ~ max_sbt_temp_change_abs * tl + (1|reg) + (1|year_factor), family = binomial, data = spp_master_ztemp.traits.na.tl)
summary(mod.c.tl.2)
AICc(mod.c.tl.2)

#max_sbt_temp_change_abs     0.93859   0.000332 4509.615
#tl                         -0.14904   0.226275    
#max_sbt_temp_change_abs:tl -0.20651   0.003700 
```


```{r colonization trophic level does adding trophic level improve models:only trophic level}
#what about only trophic level?
mod.c.tl.3 <- glmer(col ~ tl + (1|reg) + (1|year_factor), family = binomial, data = spp_master_ztemp.traits.na.tl)
summary(mod.c.tl.3)
AICc(mod.c.tl.3)

#tl          -0.36778  0.000165 4522.709

```
Comparing above options (no trait, yes trait, yes trait with interaction, only trait)
```{r colonization trophic level does adding trophic level improve models: comparing all models}
AICc(mod.c.tl.0, mod.c.tl.1, mod.c.tl.2, mod.c.tl.3)
```
Best model includes interaction, in addition to temp and trophic level. 
This tells us that as trophic level increases, log odds of colonization decreases. Also, as trophic level increases, effect of temperature on colonization decreases.

Can we make a plot for how likelihood of colonization and extinction changes with tl?
```{r tl region bias?}
ggplot(aes(x=tl), data = spp_master_ztemp.traits.na.tl) +
  geom_histogram() +
  facet_wrap(~reg)

```
____________
###Traits and extinction models.

Best Extinction Models Without Traits

Variable | coef | p | AICc
| 1 | seas_sbt_temp_change_abs_lag9 |	0.16783102	| 0.002379916 |	6207.213 |	
| 2 | min_sst_temp_change_lag2 |	-0.09468652	| 0.010582502 |	6209.860 |	
| 3 | min_sbt_temp_change_lag7 |	-0.11564632	| 0.010589365 |	6210.022 |	
| 4 | seas_sbt_temp_change_abs |	0.11602173	| 0.012974657 |	6210.184 |	
| 5 | max_sbt_temp_change_lag7 |	-0.09962557	| 0.014665739 |	6210.285 |	
| 6 | seas_sbt_temp_lag9 |	0.08732228	| 0.016700078 |	6210.766 |	
| 7 | seas_sst_temp_change_lag2 |	0.06949214	| 0.019648883 |	6210.908 |	
| 8 | max_sbt_temp_change_abs_lag9 |	0.17729188	| 0.027635910 |	6211.488 |	
| 9 | max_sst_temp_change_lag1 |	-0.09801938	| 0.038291169 |	6212.029	|
| 10 | max_sbt_temp_change_abs_lag3 |	0.11650881	| 0.043016403 |	6212.264	|
| 11 | min_sst_temp_change_lag7 |	-0.07228131	| 0.050914778 |	6212.501	|
| 12 | seas_sst_temp_lag2 |	0.06150102	| 0.040450419 |	6212.509	|
| 13 | min_sbt_temp_change_abs |	-0.15365730	| 0.066163532 |	6212.677	|
| 14 | seas_sbt_temp_change_abs_lag3 |	0.09513369	| 0.058900682 |	6212.732	|
| 15 | min_sst_temp_change_abs_lag7 |	0.10668148	| 0.056469788 |	6212.755	|

##Maximum Age for Extinction

```{r run extinction models again with restricted data set to only age.max species}
surface_variables <- colnames(spp_master_ztemp.traits.na.age.max[,45:168]) #same as above

#going to make loop to make all models I need to look at with single SURFACE variables
surface_extinction_model_comparison.maxage <- as.data.table(matrix(nrow = length(surface_variables)))
surface_extinction_model_comparison.maxage[, variable:=as.factor(V1)][, coef:=as.numeric(V1)][, p_value:=as.numeric(V1)][, AICc:=as.numeric(V1)]
surface_extinction_model_comparison.maxage[, V1 := NULL]

for (i in 1:length(surface_variables)){
  mod <- glmer(now_ext ~ get(surface_variables[i]) + (1|reg) + (1|year_factor), family = binomial, data = spp_master_ztemp.traits.na.age.max)
  surface_extinction_model_comparison.maxage[i,variable := surface_variables[i]]
  surface_extinction_model_comparison.maxage[i,coef := coef(summary(mod))[,"Estimate"][2]]
  surface_extinction_model_comparison.maxage[i,p_value := coef(summary(mod))[,"Pr(>|z|)"][2]]
  surface_extinction_model_comparison.maxage[i,AICc := AICc(mod)]
  
  print(paste(i, length(surface_variables), sep = "/"))
    
}

#looping through all possible colonization variables with single BOTTOM variables
bottom_variables <- colnames(spp_master_ztemp.traits.na.age.max[,169:292]) #same as above

bottom_extinction_model_comparison.maxage <- as.data.table(matrix(nrow = length(bottom_variables)))
bottom_extinction_model_comparison.maxage[, variable:=as.factor(V1)][, coef:=as.numeric(V1)][, p_value:=as.numeric(V1)][, AICc:=as.numeric(V1)]
bottom_extinction_model_comparison.maxage[, V1 := NULL]

for (i in 1:length(bottom_variables)){
  mod <- glmer(now_ext ~ get(bottom_variables[i]) + (1|reg) + (1|year_factor), family = binomial, data = spp_master_ztemp.traits.na.age.max)
  bottom_extinction_model_comparison.maxage[i,variable := bottom_variables[i]]
  bottom_extinction_model_comparison.maxage[i,coef := coef(summary(mod))[,"Estimate"][2]]
  bottom_extinction_model_comparison.maxage[i,p_value := coef(summary(mod))[,"Pr(>|z|)"][2]]
  bottom_extinction_model_comparison.maxage[i,AICc := AICc(mod)]
  
  print(paste(i, length(bottom_variables), sep = "/"))
    
}

#merge surface and bottom for extinction
extinction_model_comparisons.maxage <- rbind(bottom_extinction_model_comparison.maxage, surface_extinction_model_comparison.maxage)
#lowest AICc
head(extinction_model_comparisons.maxage[order(AICc)], 30)
```
Are similar models coming out on top for extinction by including maximum age?

variable | coefficient | p | AICc | rank above | coef above
---------|-------------|----|-----|---|---|
| 1 | min_sst_temp_change_lag2 |	-0.14436022 |	0.003038827 |	3930.580 | 2 | -0.09 |	
| 2 |  seas_sbt_temp_change_lag9 |	0.12993554 |	0.005210505 |	3931.628 | not in top 15 | |	
| 3 |  seas_sbt_temp_lag9 |	0.10972665 |	0.013229764 |	3933.519 | 6 | 0.09 |	
| 4 |  max_sbt_temp_change_abs |	0.15427483 |	0.017742274 |	3933.821 | not in top 15 | |	
| 5 |  min_sst_temp_change_abs_lag6 |	0.16578612 |	0.020123707 |	3934.268 | not in top 15 | |	
| 6 |  min_sbt_temp_change_abs_lag5 |	-0.23173199 |	0.036076360 |	3934.596 | not in top 15| |	
| 7 | seas_sbt_temp_change_abs |	0.12245319 |	0.032188793 |	3934.761 | 4 | 0.12 |	
| 9 |  max_sbt_temp_change_lag9 |	0.11439746 |	0.035588475 |	3934.905 | not in top 15| |	
| 10 | seas_sst_temp |	-0.09460166 |	0.050126076 |	3935.655 | not in top 15 | |	
| 11 | min_sst_temp_change_abs_lag5 |	-0.15868171 |	0.063866384 |	3935.761 | not in top 15 | |	
| 12 | seas_sst_temp_lag2 |	0.07970154 |	0.044236722 |	3935.820 | 12 |  0.06 |	
| 13 |	seas_sst_temp_change_abs_lag5 |	-0.11465158 |	0.071676787 |	3935.918 | not in top 15 | |	
| 14 | seas_sst_temp_change_lag2 |	0.06818593 |	0.069610050 |	3936.028 | 7 | 0.07 |	
| 15 | seas_sst_temp_change |	-0.07118644 |	0.077429810 |	3936.153 | not in top 15 | |	

Of top 15 models, they only share 6... this is a problem? Seems like *min_sst_temp_change_lag2* is best to continue with?

Now we will check to see if including maximum age improves best extinction models.
```{r extinction maximum age does adding maximum age improve models: new base model}

#new base model (best model with no traits added)
mod.e.agemax.0 <- glmer(now_ext ~ min_sst_temp_change_lag2 + (1|reg) + (1|year_factor), family = binomial, data = spp_master_ztemp.traits.na.age.max)
summary(mod.e.agemax.0)
AICc(mod.e.agemax.0)

#min_sst_temp_change_lag2 -0.14436  0.00304 3930.58

#As the minimum temperature experienced between 2-3 years ago increases, the log odds of extinction decreases. 
#-->THIS IS COUNTERINTUITIVE
```


```{r extinction maximum age does adding maximum age improve models:adding maximum age}
#max_sbt_temp_change_abs and age.max
mod.e.agemax.1 <- glmer(now_ext ~ min_sst_temp_change_lag2 + age.max + (1|reg) + (1|year_factor), family = binomial, data = spp_master_ztemp.traits.na.age.max)
summary(mod.e.agemax.1)
AICc(mod.e.agemax.1)

#min_sst_temp_change_lag2 -0.144548 0.00306 3889.425
#age.max                  -0.029182 4.7e-09 
```
As maximum age increases, likelihood of going extinct decreases. 

```{r extinction maximum age does adding maximum age improve models:adding maximum age with interaction}
#interaction?
mod.e.agemax.2 <- glmer(now_ext ~ min_sst_temp_change_lag2 * age.max + (1|reg) + (1|year_factor), family = binomial, data = spp_master_ztemp.traits.na.age.max)
summary(mod.e.agemax.2)
AICc(mod.e.agemax.2)

#min_sst_temp_change_lag2         -0.080449     0.279  3890.142   
#age.max                          -0.030339  3.25e-09 
#min_sst_temp_change_lag2:age.max -0.005597     0.247    
```


```{r extinction maximum age does adding maximum age improve models:only maximum age}
#what about only maximum age?
mod.e.agemax.3 <- glmer(now_ext ~ age.max + (1|reg) + (1|year_factor), family = binomial, data = spp_master_ztemp.traits.na.age.max)
summary(mod.e.agemax.3)
AICc(mod.e.agemax.3)

#age.max     -0.029179  4.68e-09 3896.078

```
Comparing above options (no trait, yes trait, yes trait with interaction, only trait)
```{r extinction maximum age does adding maximum age improve models: comparing all models}
AICc(mod.e.agemax.0, mod.e.agemax.1, mod.e.agemax.2, mod.e.agemax.3)
```
Best model does not include interaction, but is nearly impossible to distinguish from model with interaction. 

This tells us that as maximum age increases, log odds of going extinct decreases. As change in min temperature experienced between 2-3 years ago increases (positive change, towards warmer), the log odds of extinction decreases.


##Age of Maturity for Extinction
```{r extinction with age of maturity}

#going to make loop to make all models I need to look at with single SURFACE variables
surface_extinction_model_comparison.maturityage <- as.data.table(matrix(nrow = length(surface_variables)))
surface_extinction_model_comparison.maturityage[, variable:=as.factor(V1)][, coef:=as.numeric(V1)][, p_value:=as.numeric(V1)][, AICc:=as.numeric(V1)]
surface_extinction_model_comparison.maturityage[, V1 := NULL]

for (i in 1:length(surface_variables)){
  mod <- glmer(now_ext ~ get(surface_variables[i]) + (1|reg) + (1|year_factor), family = binomial, data = spp_master_ztemp.traits.na.age.maturity)
  surface_extinction_model_comparison.maturityage[i,variable := surface_variables[i]]
  surface_extinction_model_comparison.maturityage[i,coef := coef(summary(mod))[,"Estimate"][2]]
  surface_extinction_model_comparison.maturityage[i,p_value := coef(summary(mod))[,"Pr(>|z|)"][2]]
  surface_extinction_model_comparison.maturityage[i,AICc := AICc(mod)]
  
  print(paste(i, length(surface_variables), sep = "/"))
    
}

#looping through all possible extinction variables with single BOTTOM variables

bottom_extinction_model_comparison.maturityage <- as.data.table(matrix(nrow = length(bottom_variables)))
bottom_extinction_model_comparison.maturityage[, variable:=as.factor(V1)][, coef:=as.numeric(V1)][, p_value:=as.numeric(V1)][, AICc:=as.numeric(V1)]
bottom_extinction_model_comparison.maturityage[, V1 := NULL]

for (i in 1:length(bottom_variables)){
  mod <- glmer(now_ext ~ get(bottom_variables[i]) + (1|reg) + (1|year_factor), family = binomial, data = spp_master_ztemp.traits.na.age.maturity)
  bottom_extinction_model_comparison.maturityage[i,variable := bottom_variables[i]]
  bottom_extinction_model_comparison.maturityage[i,coef := coef(summary(mod))[,"Estimate"][2]]
  bottom_extinction_model_comparison.maturityage[i,p_value := coef(summary(mod))[,"Pr(>|z|)"][2]]
  bottom_extinction_model_comparison.maturityage[i,AICc := AICc(mod)]
  
  print(paste(i, length(bottom_variables), sep = "/"))
    
}

#merge surface and bottom for extinction
extinction_model_comparisons.maturityage <- rbind(bottom_extinction_model_comparison.maturityage, surface_extinction_model_comparison.maturityage)
#lowest AICc
head(extinction_model_comparisons.maturityage[order(AICc)], 30)

```
Are similar models coming out on top for extinction by including age at maturity?

variable | coefficient | p | AICc | rank above | coef above
---------|-------------|----|-----|---|---|
| 1 | min_sst_temp_change_lag2	| -0.14805497 |	0.002710857 |	3920.109 | 2 | -0.09 |	
| 2 |  seas_sbt_temp_change_lag9	| 0.12861632 |	0.006329875 |	3921.697 | not in top 15 | |	
| 3 |  seas_sbt_temp_lag9	| 0.11207541 |	0.011862688 |	3923.042 | 6 | 0.09 |	
| 4 |  max_sbt_temp_change_abs	| 0.15619946 |	0.016642456 |	3923.456 | not in top 15  | |	
| 5 |  min_sst_temp_change_abs_lag6	| 0.16612378 |	0.020897770 |	3924.076 | not in top 15 | |	
| 6 |  min_sbt_temp_change_abs_lag5	| -0.23921218 |	0.032703088 |	3924.162 | not in top 15 | |	
| 7 | seas_sbt_temp_change_abs	| 0.12215822 |	0.032750203 |	3924.536 | 4  | 0.12 |	
| 9 |  seas_sst_temp_lag2	| 0.08894160 |	0.021276070 |	3924.730 | 12 | 0.06 |	
| 10 | seas_sst_temp_change	| -0.07914067 |	0.053147439 |	3925.275 | not in top 15  | |	
| 11 | max_sbt_temp_change_lag9	| 0.10522327 |	0.055746506 |	3925.392 | not in top 15 | |	
| 12 | min_sst_temp_change_abs_lag5	| -0.16304438 |	0.059969373 |	3925.406 | not in top 15 | |	
| 13 |	 seas_sst_temp_change_lag2	| 0.07202288 |	0.059464663 |	3925.501 | 7 | 0.07 |	
| 14 | seas_sst_temp	| -0.09394699 |	0.055661858 |	3925.636 | not in top 15 | |	
| 15 | min_sst_temp_change	| 0.09385684 |	0.072201812 |	3925.738 | not in top 15  | |	

Of top 15, only 5 are shared


Now we will check to see if including age at maturity improves best extinction models.
```{r extinction age at maturity does adding age at maturity improve models: new base model}

#new base model (best model with no traits added)
mod.e.agematurity.0 <- glmer(now_ext ~ min_sst_temp_change_lag2 + (1|reg) + (1|year_factor), family = binomial, data = spp_master_ztemp.traits.na.age.maturity)
summary(mod.e.agematurity.0)
AICc(mod.e.agematurity.0)

#min_sst_temp_change_lag2 -0.14805 0.00271 3920.109
```


```{r extinction age at maturity does adding age at maturity improve models:adding age at maturity}
#max_sbt_temp_change_abs and age.maturity
mod.e.agematurity.1 <- glmer(now_ext ~ min_sst_temp_change_lag2 + age.maturity + (1|reg) + (1|year_factor), family = binomial, data = spp_master_ztemp.traits.na.age.maturity)
summary(mod.e.agematurity.1)
AICc(mod.e.agematurity.1)

#min_sst_temp_change_lag2 -0.14810  0.002714 3906.268
#age.maturity             -0.06855  0.000204 

```


```{r extinction age at maturity does adding age at maturity improve models:adding age at maturity with interaction}
#interaction?
mod.e.agematurity.2 <- glmer(now_ext ~ min_sst_temp_change_lag2 * age.maturity + (1|reg) + (1|year_factor), family = binomial, data = spp_master_ztemp.traits.na.age.maturity)
summary(mod.e.agematurity.2)
AICc(mod.e.agematurity.2)

#min_sst_temp_change_lag2              -0.162645 0.023862 3908.194 
#age.maturity                          -0.067870 0.000259 
#min_sst_temp_change_lag2:age.maturity  0.005069 0.781563 
```


```{r extinction age at maturity does adding age at maturity improve models:only age at maturity}
#what about only age at maturity?
mod.e.agematurity.3 <- glmer(now_ext ~ age.maturity + (1|reg) + (1|year_factor), family = binomial, data = spp_master_ztemp.traits.na.age.maturity)
summary(mod.e.agematurity.3)
AICc(mod.e.agematurity.3)

#age.maturity -0.06853 0.000205 3913.139

```
Comparing above options (no trait, yes trait, yes trait with interaction, only trait)
```{r extinction age at maturity does adding age at maturity improve models: comparing all models}
AICc(mod.e.agematurity.0, mod.e.agematurity.1, mod.e.agematurity.2, mod.e.agematurity.3)
```
Best model includes both age at maturity and temp but not the interaction. 

This tells us that as age at maturity increases,log odds of extinction decrease. Also, as change in minimum temperature experienced between 2-3 years ago increases (towards positive), log odds of extinction decreases.


##Trophic Level for Extinction
```{r extinction with trophic level}

#going to make loop to make all models I need to look at with single SURFACE variables
surface_extinction_model_comparison.trophiclevel <- as.data.table(matrix(nrow = length(surface_variables)))
surface_extinction_model_comparison.trophiclevel[, variable:=as.factor(V1)][, coef:=as.numeric(V1)][, p_value:=as.numeric(V1)][, AICc:=as.numeric(V1)]
surface_extinction_model_comparison.trophiclevel[, V1 := NULL]

for (i in 1:length(surface_variables)){
  mod <- glmer(now_ext ~ get(surface_variables[i]) + (1|reg) + (1|year_factor), family = binomial, data = spp_master_ztemp.traits.na.tl)
  surface_extinction_model_comparison.trophiclevel[i,variable := surface_variables[i]]
  surface_extinction_model_comparison.trophiclevel[i,coef := coef(summary(mod))[,"Estimate"][2]]
  surface_extinction_model_comparison.trophiclevel[i,p_value := coef(summary(mod))[,"Pr(>|z|)"][2]]
  surface_extinction_model_comparison.trophiclevel[i,AICc := AICc(mod)]
  
  print(paste(i, length(surface_variables), sep = "/"))
    
}

#looping through all possible extinction variables with single BOTTOM variables

bottom_extinction_model_comparison.trophiclevel <- as.data.table(matrix(nrow = length(bottom_variables)))
bottom_extinction_model_comparison.trophiclevel[, variable:=as.factor(V1)][, coef:=as.numeric(V1)][, p_value:=as.numeric(V1)][, AICc:=as.numeric(V1)]
bottom_extinction_model_comparison.trophiclevel[, V1 := NULL]

for (i in 1:length(bottom_variables)){
  mod <- glmer(now_ext ~ get(bottom_variables[i]) + (1|reg) + (1|year_factor), family = binomial, data = spp_master_ztemp.traits.na.tl)
  bottom_extinction_model_comparison.trophiclevel[i,variable := bottom_variables[i]]
  bottom_extinction_model_comparison.trophiclevel[i,coef := coef(summary(mod))[,"Estimate"][2]]
  bottom_extinction_model_comparison.trophiclevel[i,p_value := coef(summary(mod))[,"Pr(>|z|)"][2]]
  bottom_extinction_model_comparison.trophiclevel[i,AICc := AICc(mod)]
  
  print(paste(i, length(bottom_variables), sep = "/"))
    
}

#merge surface and bottom for extinction
extinction_model_comparisons.trophiclevel <- rbind(surface_extinction_model_comparison.trophiclevel, bottom_extinction_model_comparison.trophiclevel)
#lowest AICc
head(extinction_model_comparisons.trophiclevel[order(AICc)], 30)

```
Are similar models coming out on top for extinction by including trophic level?

|1 | min_sst_temp_change_lag2 |	-0.12605189 |	0.008882239 |	4205.455 |2	|-0.09|
|2 | seas_sbt_temp_change_abs	| 0.13647286 | 	0.014522389	| 4206.321 |4 |0.12 | 	
|3 | seas_sbt_temp_change_lag9 |	0.11068561 |	0.016010438 |	4206.530 |not in top 15 | |	
|4 | seas_sbt_temp_lag9 |	0.10832214 |	0.014587647 |	4206.647 | 6 | 0.09 |	
|5 | min_sst_temp_change_abs_lag6 |	0.17395683 |	0.014698403 |	4206.661 | not in top 15	||
|6 | min_sbt_temp_change_abs_lag5 |	-0.25022141 |	0.023335227 |	4206.734 | not in top 15 | |	
|7 | max_sbt_temp_change_abs |	0.15091446 |	0.018910307 |	4206.845 | not in top 15 | |	
|8 |min_sst_temp_change_abs_lag7 |	0.16683645 |	0.017394540 |	4206.863 |15	|0.11|
|9 | min_sst_temp_change_abs_lag5 |	-0.18898669 |	0.027881516 |	4207.251 |not in top 15	||
|10| min_sbt_temp_change_lag7 |	-0.10660642 |	0.056611513 |	4208.757 | 3| -0.12|	
|11|  seas_sst_temp_lag2 |	0.07887305 |	0.050759977 |	4208.927 |12	|0.07|
|12 | seas_sst_temp_change_abs_lag5 |	-0.11074422 |	0.077570136 |	4208.999 |not in top 15	||
|13 |  min_sst_temp_change |	0.08871614 |	0.078886342 |	4209.073 |not in top 15	||
|14 |  seas_sst_temp |	-0.08790929 |	0.067876817 |	4209.092 |not in top 15	||
|15 | max_sbt_temp_change_lag9 |	0.09267424 |	0.081161794 |	4209.182 |not in top 15 | |	

Of top 15, only 6 are shared. 

Now we will check to see if including trophic level improves best extinction models.
```{r extinction trophic level does adding trophic level improve models: new base model}
#new base model (best model with no traits added)
mod.e.tl.0 <- glmer(now_ext ~ min_sst_temp_change_lag2 + (1|reg) + (1|year_factor), family = binomial, data = spp_master_ztemp.traits.na.tl)
summary(mod.e.tl.0)
AICc(mod.e.tl.0)

#min_sst_temp_change_lag2 -0.12605   0.00888 4205.455
```


```{r extinction trophic level does adding trophic level improve models:adding trophic level}
#max_sbt_temp_change_abs and tl
mod.e.tl.1 <- glmer(now_ext ~ min_sst_temp_change_lag2 + tl + (1|reg) + (1|year_factor), family = binomial, data = spp_master_ztemp.traits.na.tl)
summary(mod.e.tl.1)
AICc(mod.e.tl.1)

#min_sst_temp_change_lag2 -0.12635  0.0088 4192.295
#tl                       -0.39633 8.55e-05 
  
```


```{r extinction trophic level does adding trophic level improve models:adding trophic level with interaction}
#interaction?
mod.e.tl.2 <- glmer(now_ext ~ min_sst_temp_change_lag2 * tl + (1|reg) + (1|year_factor), family = binomial, data = spp_master_ztemp.traits.na.tl)
summary(mod.e.tl.2)
AICc(mod.e.tl.2)

# min_sst_temp_change_lag2    -0.03522    0.30747  -0.115    0.909 4194.209    
# tl                          -0.40081    0.10198  -3.930 8.49e-05
# min_sst_temp_change_lag2:tl -0.02460    0.08190  -0.300    0.764 
```


```{r extinction trophic level does adding trophic level improve models:only trophic level}
#what about only trophic level?
mod.e.tl.3 <- glmer(now_ext ~ tl + (1|reg) + (1|year_factor), family = binomial, data = spp_master_ztemp.traits.na.tl)
summary(mod.e.tl.3)
AICc(mod.e.tl.3)


#tl           -0.3960  8.64e-05 4197.014
```
Comparing above options (no trait, yes trait, yes trait with interaction, only trait)
```{r extinction trophic level does adding trophic level improve models: comparing all models}
AICc(mod.e.tl.0, mod.e.tl.1, mod.e.tl.2, mod.e.tl.3)
```
Best model includes both trophic level and temperature, but not an interaction. 

This tells us that as trophic level increases, log odds of extinction decreases. As change in minimum temperature experienced between 2-3 years ago towards positive increases, the log odds of extinction decreases. 
_______________
###Regional variability?
```{r regional differences in col and ext}
#total counts in each region
spp_master_ztemp %>%
  group_by(reg) %>%
  summarise(n())

spp_master_ztemp %>%
  group_by(reg) %>%
  summarise(sum(col)/n()) #quite even percents, NEUS a little high at 8% events are colonizations

spp_master_ztemp %>%
  group_by(reg) %>%
  summarise(sum(col)) #NEUS and EBS both high, AI very small 

spp_master_ztemp %>%
  group_by(reg) %>%
  summarise(sum(now_ext)/n()) #again, NEUS is very high, all others similar

spp_master_ztemp %>%
  group_by(reg) %>%
  summarise(sum(now_ext)) #Again, EBS, NEUS, and SA all high... why more events in these regions?
```

First, let's get some regional statistics
```{r regional stats}
#count colonizations by region
col <- spp_master_ztemp %>%
  group_by(reg) %>%
  summarise(sum(col))

#count extinctions by region
ext <- spp_master_ztemp %>%
  group_by(reg) %>%
  summarise(sum(now_ext))

#count observations by region
count <- spp_master_ztemp %>%
  group_by(reg) %>%
  summarise(n())

#first year
year.first <- spp_master_ztemp %>%
  group_by(reg) %>%
  summarise(min(year))
#last year
year.last <- spp_master_ztemp %>%
  group_by(reg) %>%
  summarise(max(year))

region_summaries <- cbind(count, col[,2], ext[,2], year.first[,2], year.last[,2])
colnames(region_summaries) <- c("reg", "n", "n.col", "n.ext", "year.first","year.last")
```
Now we'll visualize regions in a plot
```{r region plot}
#manipulate data
region_summaries.m <- melt(region_summaries[,1:4], id.vars = "reg")

ggplot(aes(x=reg, y = value, fill = variable), data = region_summaries.m) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "Region", y = "Counts")

```
This shows that no specific region is monopolizing the patterns we see. 